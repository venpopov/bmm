<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>BMM Developer Notes - 5&nbsp; Adding a new model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./example-model.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">BMM Developer Notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./../reference/index.html"> 
<span class="menu-text">Functions</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../articles/index.html"> 
<span class="menu-text">Articles</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../news/index.html"> 
<span class="menu-text">Changelog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../dev-notes/index.html"> 
<span class="menu-text">Develop</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./add-new-model.html"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Adding a new model</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">System setup</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./git-workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Git and Github workflow</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bmm-architecture.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">BMM code structure</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./example-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Example model file</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./add-new-model.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Adding a new model</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#function-use_model_template" id="toc-function-use_model_template" class="nav-link active" data-scroll-target="#function-use_model_template">Function <code>use_model_template()</code></a></li>
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example"><span class="header-section-number">5.1</span> Example</a></li>
  <li><a href="#testing" id="toc-testing" class="nav-link" data-scroll-target="#testing"><span class="header-section-number">5.2</span> Testing</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Adding a new model</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>If you have read <a href="bmm-architecture.html" class="quarto-xref">Section&nbsp;<span>3</span></a> and <a href="example-model.html" class="quarto-xref">Section&nbsp;<span>4</span></a>, you should have a pretty good idea of how the <code>bmm</code> package functions. Now it’s time to add your new model.</p>
<p>You don’t have to add any of the files manually. You can use the function <code>use_model_template()</code> to generate all the files with template for all necessary functions, that you can fill. If you type <code>?use_model_template</code> you will see the following description:</p>
<section id="function-use_model_template" class="level3 unnumbered">
<h3 class="unnumbered anchored" data-anchor-id="function-use_model_template">Function <code>use_model_template()</code></h3>
<section id="description" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="description">Description</h4>
<p>Create a file with a template for adding a new model (for developers)</p>
</section>
<section id="usage" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="usage">Usage</h4>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">use_model_template</span>(</span>
<span id="cb1-2"><a href="#cb1-2"></a>  model_name,</span>
<span id="cb1-3"><a href="#cb1-3"></a>  <span class="at">custom_family =</span> <span class="cn">FALSE</span>,</span>
<span id="cb1-4"><a href="#cb1-4"></a>  <span class="at">stanvar_blocks =</span> <span class="fu">c</span>(<span class="st">"data"</span>, <span class="st">"tdata"</span>, <span class="st">"parameters"</span>, </span>
<span id="cb1-5"><a href="#cb1-5"></a>                     <span class="st">"tparameters"</span>, <span class="st">"model"</span>, <span class="st">"likelihood"</span>,</span>
<span id="cb1-6"><a href="#cb1-6"></a>                     <span class="st">"genquant"</span>, <span class="st">"functions"</span>),</span>
<span id="cb1-7"><a href="#cb1-7"></a>  <span class="at">open_files =</span> <span class="cn">TRUE</span>,</span>
<span id="cb1-8"><a href="#cb1-8"></a>  <span class="at">testing =</span> <span class="cn">FALSE</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="arguments" class="level4 unnumbered">
<h4 class="unnumbered anchored" data-anchor-id="arguments">Arguments</h4>
<table class="table">
<colgroup>
<col style="width: 25%">
<col style="width: 75%">
</colgroup>
<thead>
<tr class="header">
<th>Argument</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>model_name</code></td>
<td>A string with the name of the model. The file will be named bmm_model_model_name.R and all necessary functions will be created with the appropriate names and structure. The file will be saved in the ⁠R/⁠ directory</td>
</tr>
<tr class="even">
<td><code>custom_family</code></td>
<td>Logical; Do you plan to define a brms::custom_family()? If TRUE the function will add a section for the custom family, placeholders for the stan_vars and corresponding empty .stan files in ⁠inst/stan_chunks/⁠, that you can fill For an example, see the sdmSimple model in ⁠/R/bmm_model_sdmSimple.R⁠. If FALSE (default) the function will not add the custom family section nor stan files.</td>
</tr>
<tr class="odd">
<td><code>stanvar_blocks</code></td>
<td>A character vector with the names of the blocks that will be added to the custom family section. See brms::stanvar() for more details. The default lists all the possible blocks, but it is unlikely that you will need all of them. You can specify a vector of only those that you need. The function will add a section for each block in the list</td>
</tr>
<tr class="even">
<td><code>open_files</code></td>
<td>Logical; If TRUE (default), the function will open the template files that were created in RStudio</td>
</tr>
<tr class="odd">
<td><code>testing</code></td>
<td>Logical; If TRUE, the function will return the file content but will not save the file. If FALSE (default), the function will save the file</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="example" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="example"><span class="header-section-number">5.1</span> Example</h2>
<p>Let’s add a new model called <code>gcm</code>. Let’s assume that you have tested the model in Stan and you have the Stan code ready. We want to define a custom family for the <code>gcm</code> model, and we want to define the following blocks: <code>likelihood</code>, <code>functions</code> (see <code>?brms::stanvar</code> for an explanation of the blocks).</p>
<p>First you set up your system and git environment as described in <a href="setup.html" class="quarto-xref">Section&nbsp;<span>1</span></a>. Then you can run the following code from RStudio in the root directory of the <code>bmm</code> package:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">use_model_template</span>(<span class="st">"gcm"</span>, <span class="at">custom_family =</span> <span class="cn">TRUE</span>, <span class="at">stanvar_blocks =</span> <span class="fu">c</span>(<span class="st">"likelihood"</span>, <span class="st">"functions"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will create the file <code>bmm_model_gcm.R</code> in the <code>R/</code> directory and the files <code>gcm_likelihood.stan</code> and <code>gcm_functions.stan</code> in the <code>inst/stan_chunks/</code> directory. The function will also open the files in RStudio. You will see the following output in the console:</p>
<pre><code>• Modify 'inst/stan_chunks/gcm_likelihood.stan'
• Modify 'inst/stan_chunks/gcm_functions.stan'
• Modify 'R/bmm_model_gcm.R'</code></pre>
<p>Now you can fill the files with the appropriate code. The stan files will be empty, but the R file will have the following structure:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="do">#############################################################################!</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co"># MODELS                                                                 ####</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="do">#############################################################################!</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co"># see file 'R/bmm_model_mixture3p.R' for an example</span></span>
<span id="cb4-5"><a href="#cb4-5"></a></span>
<span id="cb4-6"><a href="#cb4-6"></a>.model_gcm <span class="ot">&lt;-</span> <span class="cf">function</span>(required_arg1, required_arg2, ...) {</span>
<span id="cb4-7"><a href="#cb4-7"></a>   out <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb4-8"><a href="#cb4-8"></a>      <span class="at">vars =</span> <span class="fu">nlist</span>(required_arg1, required_arg2),</span>
<span id="cb4-9"><a href="#cb4-9"></a>      <span class="at">info =</span> <span class="fu">list</span>(</span>
<span id="cb4-10"><a href="#cb4-10"></a>         <span class="at">domain =</span> <span class="st">''</span>,</span>
<span id="cb4-11"><a href="#cb4-11"></a>         <span class="at">task =</span> <span class="st">''</span>,</span>
<span id="cb4-12"><a href="#cb4-12"></a>         <span class="at">name =</span> <span class="st">''</span>,</span>
<span id="cb4-13"><a href="#cb4-13"></a>         <span class="at">citation =</span> <span class="st">''</span>,</span>
<span id="cb4-14"><a href="#cb4-14"></a>         <span class="at">version =</span> <span class="st">''</span>,</span>
<span id="cb4-15"><a href="#cb4-15"></a>         <span class="at">requirements =</span> <span class="st">''</span>,</span>
<span id="cb4-16"><a href="#cb4-16"></a>         <span class="at">parameters =</span> <span class="fu">list</span>()</span>
<span id="cb4-17"><a href="#cb4-17"></a>      ))</span>
<span id="cb4-18"><a href="#cb4-18"></a>   <span class="fu">class</span>(out) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'bmmmodel'</span>, <span class="st">'gcm'</span>)</span>
<span id="cb4-19"><a href="#cb4-19"></a>   out</span>
<span id="cb4-20"><a href="#cb4-20"></a>}</span>
<span id="cb4-21"><a href="#cb4-21"></a></span>
<span id="cb4-22"><a href="#cb4-22"></a><span class="co"># user facing alias</span></span>
<span id="cb4-23"><a href="#cb4-23"></a><span class="co"># information in the title and details sections will be filled in</span></span>
<span id="cb4-24"><a href="#cb4-24"></a><span class="co"># automatically based on the information in the .model_gcm()$info</span></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="co">#' @title `r .model_gcm()$info$name`</span></span>
<span id="cb4-26"><a href="#cb4-26"></a><span class="co">#' @details `r model_info(gcm(NA,NA))`</span></span>
<span id="cb4-27"><a href="#cb4-27"></a><span class="co">#' @param required_arg1 A description of the required argument</span></span>
<span id="cb4-28"><a href="#cb4-28"></a><span class="co">#' @param required_arg2 A description of the required argument</span></span>
<span id="cb4-29"><a href="#cb4-29"></a><span class="co">#' @param ... used internally for testing, ignore it</span></span>
<span id="cb4-30"><a href="#cb4-30"></a><span class="co">#' @return An object of class `bmmmodel`</span></span>
<span id="cb4-31"><a href="#cb4-31"></a><span class="co">#' @export</span></span>
<span id="cb4-32"><a href="#cb4-32"></a><span class="co">#' @examples</span></span>
<span id="cb4-33"><a href="#cb4-33"></a><span class="co">#' \dontrun{</span></span>
<span id="cb4-34"><a href="#cb4-34"></a><span class="co">#' # put a full example here (see 'R/bmm_model_mixture3p.R' for an example)</span></span>
<span id="cb4-35"><a href="#cb4-35"></a><span class="co">#' }</span></span>
<span id="cb4-36"><a href="#cb4-36"></a>gcm <span class="ot">&lt;-</span> .model_gcm</span>
<span id="cb4-37"><a href="#cb4-37"></a></span>
<span id="cb4-38"><a href="#cb4-38"></a></span>
<span id="cb4-39"><a href="#cb4-39"></a></span>
<span id="cb4-40"><a href="#cb4-40"></a><span class="do">#############################################################################!</span></span>
<span id="cb4-41"><a href="#cb4-41"></a><span class="co"># CHECK_DATA S3 methods                                                  ####</span></span>
<span id="cb4-42"><a href="#cb4-42"></a><span class="do">#############################################################################!</span></span>
<span id="cb4-43"><a href="#cb4-43"></a><span class="co"># A check_data.* function should be defined for each class of the model.</span></span>
<span id="cb4-44"><a href="#cb4-44"></a><span class="co"># If a model shares methods with other models, the shared methods should be</span></span>
<span id="cb4-45"><a href="#cb4-45"></a><span class="co"># defined in data-helpers.R. Put here only the methods that are specific to</span></span>
<span id="cb4-46"><a href="#cb4-46"></a><span class="co"># the model. See ?check_data for details</span></span>
<span id="cb4-47"><a href="#cb4-47"></a></span>
<span id="cb4-48"><a href="#cb4-48"></a></span>
<span id="cb4-49"><a href="#cb4-49"></a><span class="co">#' @export</span></span>
<span id="cb4-50"><a href="#cb4-50"></a>check_data.gcm <span class="ot">&lt;-</span> <span class="cf">function</span>(model, data, formula) {</span>
<span id="cb4-51"><a href="#cb4-51"></a>   <span class="co"># retrieve required arguments</span></span>
<span id="cb4-52"><a href="#cb4-52"></a>   required_arg1 <span class="ot">&lt;-</span> model<span class="sc">$</span>vars<span class="sc">$</span>required_arg1</span>
<span id="cb4-53"><a href="#cb4-53"></a>   required_arg2 <span class="ot">&lt;-</span> model<span class="sc">$</span>vars<span class="sc">$</span>required_arg2</span>
<span id="cb4-54"><a href="#cb4-54"></a></span>
<span id="cb4-55"><a href="#cb4-55"></a></span>
<span id="cb4-56"><a href="#cb4-56"></a>   <span class="co"># check the data (required)</span></span>
<span id="cb4-57"><a href="#cb4-57"></a></span>
<span id="cb4-58"><a href="#cb4-58"></a></span>
<span id="cb4-59"><a href="#cb4-59"></a>   <span class="co"># compute any necessary transformations (optional)</span></span>
<span id="cb4-60"><a href="#cb4-60"></a></span>
<span id="cb4-61"><a href="#cb4-61"></a></span>
<span id="cb4-62"><a href="#cb4-62"></a>   <span class="co"># save some variables as attributes of the data for later use (optional)</span></span>
<span id="cb4-63"><a href="#cb4-63"></a></span>
<span id="cb4-64"><a href="#cb4-64"></a></span>
<span id="cb4-65"><a href="#cb4-65"></a>   data <span class="ot">=</span> <span class="fu">NextMethod</span>(<span class="st">'check_data'</span>)</span>
<span id="cb4-66"><a href="#cb4-66"></a></span>
<span id="cb4-67"><a href="#cb4-67"></a>   <span class="fu">return</span>(data)</span>
<span id="cb4-68"><a href="#cb4-68"></a>}</span>
<span id="cb4-69"><a href="#cb4-69"></a></span>
<span id="cb4-70"><a href="#cb4-70"></a></span>
<span id="cb4-71"><a href="#cb4-71"></a></span>
<span id="cb4-72"><a href="#cb4-72"></a><span class="do">#############################################################################!</span></span>
<span id="cb4-73"><a href="#cb4-73"></a><span class="co"># CONFIGURE_MODEL S3 METHODS                                             ####</span></span>
<span id="cb4-74"><a href="#cb4-74"></a><span class="do">#############################################################################!</span></span>
<span id="cb4-75"><a href="#cb4-75"></a><span class="co"># Each model should have a corresponding configure_model.* function. See</span></span>
<span id="cb4-76"><a href="#cb4-76"></a><span class="co"># ?configure_model for more information.</span></span>
<span id="cb4-77"><a href="#cb4-77"></a></span>
<span id="cb4-78"><a href="#cb4-78"></a></span>
<span id="cb4-79"><a href="#cb4-79"></a><span class="co">#' @export</span></span>
<span id="cb4-80"><a href="#cb4-80"></a>configure_model.gcm <span class="ot">&lt;-</span> <span class="cf">function</span>(model, data, formula) {</span>
<span id="cb4-81"><a href="#cb4-81"></a>   <span class="co"># retrieve required arguments</span></span>
<span id="cb4-82"><a href="#cb4-82"></a>   required_arg1 <span class="ot">&lt;-</span> model<span class="sc">$</span>vars<span class="sc">$</span>required_arg1</span>
<span id="cb4-83"><a href="#cb4-83"></a>   required_arg2 <span class="ot">&lt;-</span> model<span class="sc">$</span>vars<span class="sc">$</span>required_arg2</span>
<span id="cb4-84"><a href="#cb4-84"></a></span>
<span id="cb4-85"><a href="#cb4-85"></a></span>
<span id="cb4-86"><a href="#cb4-86"></a>   <span class="co"># retrieve arguments from the data check</span></span>
<span id="cb4-87"><a href="#cb4-87"></a>   my_precomputed_var <span class="ot">&lt;-</span> <span class="fu">attr</span>(data, <span class="st">'my_precomputed_var'</span>)</span>
<span id="cb4-88"><a href="#cb4-88"></a></span>
<span id="cb4-89"><a href="#cb4-89"></a></span>
<span id="cb4-90"><a href="#cb4-90"></a>   <span class="co"># construct the formula</span></span>
<span id="cb4-91"><a href="#cb4-91"></a>   formula <span class="ot">&lt;-</span> formula <span class="sc">+</span> brms<span class="sc">::</span><span class="fu">lf</span>()</span>
<span id="cb4-92"><a href="#cb4-92"></a></span>
<span id="cb4-93"><a href="#cb4-93"></a></span>
<span id="cb4-94"><a href="#cb4-94"></a>   <span class="co"># construct the family</span></span>
<span id="cb4-95"><a href="#cb4-95"></a>   gcm_family <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">custom_family</span>(</span>
<span id="cb4-96"><a href="#cb4-96"></a>     <span class="st">'gcm'</span>, <span class="at">dpars =</span> <span class="fu">c</span>(),</span>
<span id="cb4-97"><a href="#cb4-97"></a>     <span class="at">links =</span> <span class="fu">c</span>(), <span class="at">lb =</span> <span class="fu">c</span>(), <span class="at">ub =</span> <span class="fu">c</span>(),</span>
<span id="cb4-98"><a href="#cb4-98"></a>     <span class="at">type =</span> <span class="st">''</span>, <span class="at">loop=</span><span class="cn">FALSE</span>,</span>
<span id="cb4-99"><a href="#cb4-99"></a>   )</span>
<span id="cb4-100"><a href="#cb4-100"></a>   family <span class="ot">&lt;-</span> gcm_family</span>
<span id="cb4-101"><a href="#cb4-101"></a></span>
<span id="cb4-102"><a href="#cb4-102"></a>   <span class="co"># prepare initial stanvars to pass to brms, model formula and priors</span></span>
<span id="cb4-103"><a href="#cb4-103"></a>   stan_likelihood <span class="ot">&lt;-</span> <span class="fu">readChar</span>(<span class="st">'inst/stan_chunks/gcm_likelihood.stan'</span>,</span>
<span id="cb4-104"><a href="#cb4-104"></a>      <span class="fu">file.info</span>(<span class="st">'inst/stan_chunks/gcm_likelihood.stan'</span>)<span class="sc">$</span>size)</span>
<span id="cb4-105"><a href="#cb4-105"></a>   stan_functions <span class="ot">&lt;-</span> <span class="fu">readChar</span>(<span class="st">'inst/stan_chunks/gcm_functions.stan'</span>,</span>
<span id="cb4-106"><a href="#cb4-106"></a>      <span class="fu">file.info</span>(<span class="st">'inst/stan_chunks/gcm_functions.stan'</span>)<span class="sc">$</span>size)</span>
<span id="cb4-107"><a href="#cb4-107"></a></span>
<span id="cb4-108"><a href="#cb4-108"></a>   stanvars <span class="ot">&lt;-</span> <span class="fu">stanvar</span>(<span class="at">scode =</span> stan_likelihood, <span class="at">block =</span> <span class="st">'likelihood'</span>) <span class="sc">+</span></span>
<span id="cb4-109"><a href="#cb4-109"></a>      <span class="fu">stanvar</span>(<span class="at">scode =</span> stan_functions, <span class="at">block =</span> <span class="st">'functions'</span>)</span>
<span id="cb4-110"><a href="#cb4-110"></a></span>
<span id="cb4-111"><a href="#cb4-111"></a></span>
<span id="cb4-112"><a href="#cb4-112"></a>   <span class="co"># construct the default prior</span></span>
<span id="cb4-113"><a href="#cb4-113"></a>   prior <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb4-114"><a href="#cb4-114"></a></span>
<span id="cb4-115"><a href="#cb4-115"></a></span>
<span id="cb4-116"><a href="#cb4-116"></a>   <span class="co"># return the list</span></span>
<span id="cb4-117"><a href="#cb4-117"></a>   out <span class="ot">&lt;-</span> <span class="fu">nlist</span>(formula, data, family, prior, stanvars)</span>
<span id="cb4-118"><a href="#cb4-118"></a>   <span class="fu">return</span>(out)</span>
<span id="cb4-119"><a href="#cb4-119"></a>}</span>
<span id="cb4-120"><a href="#cb4-120"></a></span>
<span id="cb4-121"><a href="#cb4-121"></a></span>
<span id="cb4-122"><a href="#cb4-122"></a></span>
<span id="cb4-123"><a href="#cb4-123"></a><span class="do">#############################################################################!</span></span>
<span id="cb4-124"><a href="#cb4-124"></a><span class="co"># POSTPROCESS METHODS                                                    ####</span></span>
<span id="cb4-125"><a href="#cb4-125"></a><span class="do">#############################################################################!</span></span>
<span id="cb4-126"><a href="#cb4-126"></a><span class="co"># A postprocess_brm.* function should be defined for the model class. See </span></span>
<span id="cb4-127"><a href="#cb4-127"></a><span class="co"># ?postprocess_brm for details</span></span>
<span id="cb4-128"><a href="#cb4-128"></a></span>
<span id="cb4-129"><a href="#cb4-129"></a></span>
<span id="cb4-130"><a href="#cb4-130"></a><span class="co">#' @export</span></span>
<span id="cb4-131"><a href="#cb4-131"></a>postprocess_brm.gcm <span class="ot">&lt;-</span> <span class="cf">function</span>(model, fit) {</span>
<span id="cb4-132"><a href="#cb4-132"></a>   <span class="co"># any required postprocessing (if none, delete this section)</span></span>
<span id="cb4-133"><a href="#cb4-133"></a></span>
<span id="cb4-134"><a href="#cb4-134"></a></span>
<span id="cb4-135"><a href="#cb4-135"></a>   <span class="fu">return</span>(fit)</span>
<span id="cb4-136"><a href="#cb4-136"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Now you have to:</p>
<ol type="1">
<li><p>Fill the <code>.model_gcm</code> function with the appropriate code. This function should return a list with the variables that the model needs and a list with information about the model. The class of the list should be <code>c('bmmmodel', 'gcm')</code>. The information list should contain the following elements: <code>domain</code>, <code>task</code>, <code>name</code>, <code>citation</code>, <code>version</code>, <code>requirements</code>, and <code>parameters</code>. Rename the required arguments, if you have any, or delete them if you don’t. You can see an example in the <code>bmm_model_sdmSimple.R</code> file.</p></li>
<li><p>Adjust the user-facing alias. Here you should only rename the required arguments and fill in the <code>@examples</code> section with a full example. Everything else will be filled in automatically based on the information in the <code>.model_gcm</code> function.</p></li>
<li><p>Fill the <code>check_data.gcm</code> function with the appropriate code. This function should check the data and return the data. You may or may not need to compute any transformations or save some variables as attributes of the data.</p></li>
<li><p>Fill the <code>configure_model.gcm</code> function with the appropriate code. This function should construct the formula, the family, the stanvars, and the prior. You can also retrieve any arguments you saved from the data check. Depending on your model, some of these parts might not be necessary. For example, for the mixture models (e.g.&nbsp;<code>mixture3p</code>), we construct a new formula, because we want to rename the arguments to make it easier for the user. For the <code>sdmSimple</code> model, we define the family ourselves, so we don’t need to change the formula.</p>
<p>You need to fill information about your custom family, and then fill the stan files with your stan code. You don’t have to edit lines 102-109 - loading the stan files and setting up the stanvars is done automatically. If you decide to add more stan files after you created the template, you can edit those lines.</p></li>
<li><p>Fill the <code>postprocess_brm.gcm</code> function with the appropriate code. By postprocessing, we mean changes to the fitted brms model - like renaming parameters, etc. If you don’t need any postprocessing, you can delete this section.</p></li>
</ol>
</section>
<section id="testing" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="testing"><span class="header-section-number">5.2</span> Testing</h2>
<p>Unit testing is extremely important. You should test your model with the <code>testthat</code> package. You can use the <code>use_test()</code> function to create a test file for your model. See file <code>tests/testthat/test-fit_model.R</code> for an example of how we test the existing models. BRMS models take a long time to fit, so we don’t test the actual fitting process. <code>fit_model()</code> provides an argument <code>backend="mock"</code>, which will return a mock object instead of fitting the model. This ensures that the entire pipeline works without errors. For example, here’s a test of the <code>IMMfull</code> model:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">test_that</span>(<span class="st">'Available mock models run without errors'</span>,{</span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="fu">skip_on_cran</span>()</span>
<span id="cb5-3"><a href="#cb5-3"></a>  dat <span class="ot">&lt;-</span> <span class="fu">gen_imm_data</span>(<span class="at">parms =</span> <span class="fu">data.frame</span>(<span class="at">c=</span><span class="dv">2</span>,<span class="at">a=</span><span class="fl">0.5</span>,<span class="at">n=</span><span class="dv">0</span>,<span class="at">s=</span><span class="dv">2</span>,<span class="at">kappa=</span><span class="dv">5</span>),</span>
<span id="cb5-4"><a href="#cb5-4"></a>                          <span class="at">ntrial =</span> <span class="dv">2</span>, <span class="at">setsize =</span> <span class="dv">5</span>)</span>
<span id="cb5-5"><a href="#cb5-5"></a>  f <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">bf</span>(respErr <span class="sc">~</span> <span class="dv">1</span>, kappa <span class="sc">~</span> <span class="dv">1</span>, c <span class="sc">~</span> <span class="dv">1</span>, a <span class="sc">~</span> <span class="dv">1</span>, s <span class="sc">~</span> <span class="dv">1</span>)</span>
<span id="cb5-6"><a href="#cb5-6"></a>  mock_fit <span class="ot">&lt;-</span> <span class="fu">fit_model</span>(f, dat, <span class="fu">IMMfull</span>(<span class="at">setsize=</span><span class="dv">5</span>, <span class="at">non_targets =</span> <span class="fu">paste0</span>(<span class="st">'Item'</span>,<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>,<span class="st">'_rel'</span>), <span class="at">spaPos=</span><span class="fu">paste0</span>(<span class="st">'spaD'</span>,<span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>)), <span class="at">backend=</span><span class="st">"mock"</span>, <span class="at">mock_fit=</span><span class="dv">1</span>, <span class="at">rename=</span><span class="cn">FALSE</span>)</span>
<span id="cb5-7"><a href="#cb5-7"></a>  <span class="fu">expect_equal</span>(mock_fit<span class="sc">$</span>fit, <span class="dv">1</span>)</span>
<span id="cb5-8"><a href="#cb5-8"></a>  <span class="fu">expect_type</span>(mock_fit<span class="sc">$</span>fit_args, <span class="st">"list"</span>)</span>
<span id="cb5-9"><a href="#cb5-9"></a>  <span class="fu">expect_equal</span>(<span class="fu">names</span>(mock_fit<span class="sc">$</span>fit_args[<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]), <span class="fu">c</span>(<span class="st">"formula"</span>, <span class="st">"data"</span>, <span class="st">"family"</span>, <span class="st">"prior"</span>))</span>
<span id="cb5-10"><a href="#cb5-10"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The tests based on the <code>testthat</code> package are run every time you call the <code>check()</code> command. Before you submit your changes, make sure that all tests pass.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>Additionally, you should perform a full test of the model by running it in a separate script and ensuring it gives meaningful results. At the very least, you should perform parameter recovery simulations. We are in the process of establishing guidelines for that.</p>
</div>
</div>
<p>And that’s it! You have added a new model to the <code>bmm</code> package. You can now submit your changes to the <code>bmm</code> package repository.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./example-model.html" class="pagination-link  aria-label=" &lt;span="" model="" file&lt;="" span&gt;"="">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Example model file</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->




</body></html>