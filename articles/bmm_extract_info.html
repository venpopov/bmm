<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Extracting default priors, the generated Stan code and Stan data • bmm</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Extracting default priors, the generated Stan code and Stan data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">bmm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Functions</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="nav-link" href="https://venpopov.github.io/bmm/dev-notes/index.html">Develop</a></li>
<li class="nav-item"><a class="nav-link" href="https://venpopov.github.io/bmm/parameter-recovery/index.html">Parameter recovery</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/venpopov/bmm/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Extracting default priors, the generated Stan code and Stan data</h1>
                        <h4 data-toc-skip class="author">Ven Popov</h4>
                        <h4 data-toc-skip class="author">Gidon Frischkorn</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/venpopov/bmm/blob/develop/vignettes/articles/bmm_extract_info.Rmd" class="external-link"><code>vignettes/articles/bmm_extract_info.Rmd</code></a></small>
      <div class="d-none name"><code>bmm_extract_info.Rmd</code></div>
    </div>

    
    
<style type="text/css">
div.main-container {
max-width: 800px !important;
}

p {
margin-top: 1.5em ;
margin-bottom: 1.5em ;
}
.author{
    display: none;
}
</style>
<div class="section level2" number="1">
<h2 id="default-priors-for-models-in-the-bmm-package">
<span class="header-section-number">1</span> Default priors for models in the <code>bmm</code> package<a class="anchor" aria-label="anchor" href="#default-priors-for-models-in-the-bmm-package"></a>
</h2>
<p>Each model in <code>bmm</code> comes with default priors on all of its parameters. Unlike
in the <code>brms</code> package, the default priors in <code>bmm</code> are informative, based on
current expert knowledge in the domain of the model. These default priors help
with model identifiability and improve estimation. However, because the priors
are informed, it is even more important for you to understand what priors are
used when you estimate a model, or when you report the results of a model fit.</p>
<p>You can use the function <code><a href="../reference/default_prior.bmmformula.html">default_prior()</a></code> from the <code>brms</code> package to extract
the default priors for a model. The arguments to <code>default_prior</code> are the same as
for the <code><a href="../reference/bmm.html">bmm()</a></code> function in <code>bmm</code>. For example, if you want to extract the
default priors for the SDM model (<a href="https://venpopov.github.io/bmm/articles/bmm_sdm_simple.html">see the online article for more information</a>), where you have
a set_size categorical predictor of <code>c</code> and <code>kappa</code>, you can use the following
code:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/venpopov/bmm" class="external-link">bmm</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/default_prior.bmmformula.html">default_prior</a></span><span class="op">(</span><span class="fu"><a href="../reference/bmmformula.html">bmf</a></span><span class="op">(</span><span class="va">c</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">set_size</span>, <span class="va">kappa</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">set_size</span><span class="op">)</span>, </span>
<span>              data <span class="op">=</span> <span class="va">oberauer_lin_2017</span>,</span>
<span>              model <span class="op">=</span> <span class="fu"><a href="../reference/sdm.html">sdm</a></span><span class="op">(</span>resp_error <span class="op">=</span> <span class="st">'dev_rad'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;                     prior     class      coef group resp  dpar nlpar   lb   ub       source</span></span>
<span><span class="co">#&gt;     student_t(5, 2, 0.75)         b set_size1                c       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;     student_t(5, 2, 0.75)         b set_size2                c       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;     student_t(5, 2, 0.75)         b set_size3                c       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;     student_t(5, 2, 0.75)         b set_size4                c       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;     student_t(5, 2, 0.75)         b set_size5                c       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;     student_t(5, 2, 0.75)         b set_size6                c       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;     student_t(5, 2, 0.75)         b set_size7                c       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;     student_t(5, 2, 0.75)         b set_size8                c       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(5, 1.75, 0.75)         b set_size1            kappa       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(5, 1.75, 0.75)         b set_size2            kappa       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(5, 1.75, 0.75)         b set_size3            kappa       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(5, 1.75, 0.75)         b set_size4            kappa       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(5, 1.75, 0.75)         b set_size5            kappa       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(5, 1.75, 0.75)         b set_size6            kappa       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(5, 1.75, 0.75)         b set_size7            kappa       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;  student_t(5, 1.75, 0.75)         b set_size8            kappa       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;     student_t(5, 2, 0.75)         b                          c       &lt;NA&gt; &lt;NA&gt;         user</span></span>
<span><span class="co">#&gt;  student_t(5, 1.75, 0.75)         b                      kappa       &lt;NA&gt; &lt;NA&gt;         user</span></span>
<span><span class="co">#&gt;               constant(0) Intercept                                  &lt;NA&gt; &lt;NA&gt;         user</span></span></code></pre></div>
<p>In this case we used a formula of the type <code>~ 0 + factor</code>, which means that the
intercept is suppressed, and a separate parameter is estimated for each level of
the set_size factor variable. For the SDM model, both <code>kappa</code> and <code>c</code> have to be
positive, so they are defined in the model on the log scale, and exponentiated
afterwards. Thus, the parameters are sampled on the log scale, and the priors
are defined on the log scale as well. The default prior for <code>c</code> is a student-t
distribution with 5 degrees of freedom, a mean of 2, and a standard deviation of
0.75. This corresponds to the following prior distribution over the log scale,
with 80% of the prior mass between 0.9 and 3.10:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">log_c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="op">-</span><span class="fl">2</span>,<span class="fl">6</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/StudentT.html" class="external-link">dstudent_t</a></span><span class="op">(</span><span class="va">log_c</span>, df <span class="op">=</span> <span class="fl">5</span>, mu <span class="op">=</span> <span class="fl">2</span>, sigma <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">log_c</span>, <span class="va">y</span>, type <span class="op">=</span> <span class="st">'l'</span>, xlab <span class="op">=</span> <span class="st">'log(c)'</span>, ylab <span class="op">=</span> <span class="st">'Density'</span>, </span>
<span>     main <span class="op">=</span> <span class="st">'Prior distribution for log(c)'</span><span class="op">)</span></span></code></pre></div>
<p><img src="bmm_extract_info_files/figure-html/unnamed-chunk-3-1.jpeg" width="450"></p>
<p>This corresponds to the following log-T prior over the native scale of <code>c</code>, with
a median of ~7.4, and 80% of the prior mass between 2.44 and 22.35:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">brms</span><span class="fu">::</span><span class="fu"><a href="https://paulbuerkner.com/brms/reference/StudentT.html" class="external-link">dstudent_t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">c</span><span class="op">)</span>, df <span class="op">=</span> <span class="fl">5</span>, mu <span class="op">=</span> <span class="fl">2</span>, sigma <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">/</span> <span class="va">c</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">c</span>, <span class="va">y</span>, type <span class="op">=</span> <span class="st">'l'</span>, xlab <span class="op">=</span> <span class="st">'c'</span>, ylab <span class="op">=</span> <span class="st">'Density'</span>, </span>
<span>     main <span class="op">=</span> <span class="st">'Prior distribution for c'</span><span class="op">)</span></span></code></pre></div>
<p><img src="bmm_extract_info_files/figure-html/unnamed-chunk-4-1.jpeg" width="450"></p>
<p>The default prior for <code>kappa</code> is similar, with a lower mean, a student-t
distribution with 5 degrees of freedom, a mean of 1.75, and a standard deviation
of 0.75, which corresponds to a median of 3.5 on the native scale.</p>
<p>If we had retained the intercept in the formula, the default prior above would
be placed on the intercept, while the effects of each factor level relative to
the intercept would have a default prior of normal(0, 1):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/default_prior.bmmformula.html">default_prior</a></span><span class="op">(</span><span class="fu"><a href="../reference/bmmformula.html">bmf</a></span><span class="op">(</span><span class="va">c</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">set_size</span>, <span class="va">kappa</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">set_size</span><span class="op">)</span>, </span>
<span>              data <span class="op">=</span> <span class="va">oberauer_lin_2017</span>,</span>
<span>              model <span class="op">=</span> <span class="fu"><a href="../reference/sdm.html">sdm</a></span><span class="op">(</span>resp_error <span class="op">=</span> <span class="st">'dev_rad'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;                     prior     class      coef group resp  dpar nlpar   lb   ub       source</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b set_size2                c       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b set_size3                c       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b set_size4                c       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b set_size5                c       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b set_size6                c       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b set_size7                c       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b set_size8                c       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b set_size2            kappa       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b set_size3            kappa       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b set_size4            kappa       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b set_size5            kappa       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b set_size6            kappa       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b set_size7            kappa       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b set_size8            kappa       &lt;NA&gt; &lt;NA&gt; (vectorized)</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b                          c       &lt;NA&gt; &lt;NA&gt;         user</span></span>
<span><span class="co">#&gt;     student_t(5, 2, 0.75) Intercept                          c       &lt;NA&gt; &lt;NA&gt;         user</span></span>
<span><span class="co">#&gt;              normal(0, 1)         b                      kappa       &lt;NA&gt; &lt;NA&gt;         user</span></span>
<span><span class="co">#&gt;  student_t(5, 1.75, 0.75) Intercept                      kappa       &lt;NA&gt; &lt;NA&gt;         user</span></span>
<span><span class="co">#&gt;               constant(0) Intercept                                  &lt;NA&gt; &lt;NA&gt;         user</span></span></code></pre></div>
<p>You can also see that in both cases, the last line is “constant(0)” on the
Intercept of the <code>mu</code> parameter, which is fixed to 0 by default in the model,
and is not estimated. You might wonder why it doesn’t say <code>mu</code> in the <code>dpar</code>
column of that prior - this is because <code>brms</code> assumes <code>mu</code> is the default
parameter in all models, so it hides it in the output. If you wanted to estimate
<code>mu</code>, instead of leaving it fixed, the prior for it would change as well:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/default_prior.bmmformula.html">default_prior</a></span><span class="op">(</span><span class="fu"><a href="../reference/bmmformula.html">bmf</a></span><span class="op">(</span><span class="va">mu</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">set_size</span>, <span class="va">c</span> <span class="op">~</span> <span class="fl">1</span>, <span class="va">kappa</span> <span class="op">~</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>              data <span class="op">=</span> <span class="va">oberauer_lin_2017</span>,</span>
<span>              model <span class="op">=</span> <span class="fu"><a href="../reference/sdm.html">sdm</a></span><span class="op">(</span>resp_error <span class="op">=</span> <span class="st">'dev_rad'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;                     prior     class      coef group resp  dpar nlpar   lb   ub       source</span></span>
<span><span class="co">#&gt;                    (flat)         b                                                 default</span></span>
<span><span class="co">#&gt;                    (flat)         b set_size2                                  (vectorized)</span></span>
<span><span class="co">#&gt;                    (flat)         b set_size3                                  (vectorized)</span></span>
<span><span class="co">#&gt;                    (flat)         b set_size4                                  (vectorized)</span></span>
<span><span class="co">#&gt;                    (flat)         b set_size5                                  (vectorized)</span></span>
<span><span class="co">#&gt;                    (flat)         b set_size6                                  (vectorized)</span></span>
<span><span class="co">#&gt;                    (flat)         b set_size7                                  (vectorized)</span></span>
<span><span class="co">#&gt;                    (flat)         b set_size8                                  (vectorized)</span></span>
<span><span class="co">#&gt;        student_t(1, 0, 1) Intercept                                  &lt;NA&gt; &lt;NA&gt;         user</span></span>
<span><span class="co">#&gt;     student_t(5, 2, 0.75) Intercept                          c       &lt;NA&gt; &lt;NA&gt;         user</span></span>
<span><span class="co">#&gt;  student_t(5, 1.75, 0.75) Intercept                      kappa       &lt;NA&gt; &lt;NA&gt;         user</span></span></code></pre></div>
<p>The <code>mu</code> parameter uses a <code>tan_half</code> link function, which means that the
<code>student_t(1, 0, 1)</code> prior results in a uniform prior over the native scale of
<code>mu</code> from -pi to pi. You will also notice above that for the regression
coefficients on <code>mu</code>, the default prior is an improper flat prior - this is the
only parameter in <code>bmm</code> models which has a flat prior by default, and we
strongly recommend you set a prior on it, if you want to calculate Bayes Factors
or use other Bayesian inference methods.</p>
<p>All of the above examples make an important point - priors are always specified
on the scale at which the parameters are sampled. You can always check the
documentation for a given model to see the links for the parameters (e.g.
<code><a href="../reference/sdm.html">?sdm</a></code>).</p>
<p>To overwrite the default priors and set your own, you can use the <code>set_prior</code>
function from <code>brms</code>. For more information, see <code><a href="https://paulbuerkner.com/brms/reference/set_prior.html" class="external-link">?brms::set_prior</a></code>.</p>
</div>
<div class="section level2" number="2">
<h2 id="extracting-the-stan-code">
<span class="header-section-number">2</span> Extracting the Stan code<a class="anchor" aria-label="anchor" href="#extracting-the-stan-code"></a>
</h2>
<p>The Stan code used for fitting a model is generated together by <code>bmm</code> and
<code>brms</code>. <code>bmm</code> takes care of the code specific to the model, while <code>brms</code>
generates the code for the regression syntax, priors and everything else. If you
want to get the Stan code that would be used for fitting a model, so that you
can inspect it or modify it, you can use the <code><a href="../reference/stancode.bmmformula.html">stancode()</a></code> function from <code>brms</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/stancode.bmmformula.html">stancode</a></span><span class="op">(</span><span class="fu"><a href="../reference/bmmformula.html">bmf</a></span><span class="op">(</span><span class="va">c</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">set_size</span>, <span class="va">kappa</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">set_size</span><span class="op">)</span>, </span>
<span>         data <span class="op">=</span> <span class="va">oberauer_lin_2017</span>,</span>
<span>         model <span class="op">=</span> <span class="fu"><a href="../reference/sdm.html">sdm</a></span><span class="op">(</span>resp_error <span class="op">=</span> <span class="st">'dev_rad'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>// generated with brms 2.22.0 and bmm 1.2.0
functions {
  /* compute the tan_half link
   * Args:
   *   x: a scalar in (-pi, pi)
   * Returns:
   *   a scalar in (-Inf, Inf)
   */
   real tan_half(real x) {
     return tan(x / 2);
   }
  /* compute the tan_half link (vectorized)
   * Args:
   *   x: a vector in (-pi, pi)
   * Returns:
   *   a vector in (-Inf, Inf)
   */
   vector tan_half(vector x) {
     return tan(x / 2);
   }
  /* compute the inverse of the tan_half link
   * Args:
   *   y: a scalar in (-Inf, Inf)
   * Returns:
   *   a scalar in (-pi, pi)
   */
   real inv_tan_half(real y) {
     return 2 * atan(y);
   }
  /* compute the inverse of the tan_half link (vectorized)
   * Args:
   *   y: a vector in (-Inf, Inf)
   * Returns:
   *   a vector in (-pi, pi)
   */
   vector inv_tan_half(vector y) {
     return 2 * atan(y);
   }



  // utility function trick for converting real to integer type
  int bin_search(real x, int min_val, int max_val) {
      int mid_p;
      int L = min_val;
      int R = max_val;
      while(L &lt; R) {
        mid_p = (R-L) %/% 2;
        if (L + mid_p &lt; x) {
          L += mid_p + 1;
        } else if (L + mid_p &gt; x) {
          R = L + mid_p - 1;
        } else {
          return(L + mid_p);
        }
      }
      return(L);
    }

  // utility function for determining optimal number of chebyshev points for the denominator approximation
  int get_m(real c, real kappa) {
    real m = floor(2 * exp(0.4*c) * kappa^(fma(c,0.0145,0.7)) + 0.5)+2;
    int M = bin_search(m, 2, 200);
    return(M);
  }

  // log of the numerator of the sdm likelihood
  real sdm_simple_lpdf(vector y, vector mu, vector c, vector kappa) {
    int N = size(y);
    vector[N] num = exp(fma(kappa,cos(y-mu)-1,c)) ;
    real out = dot_product(num, sqrt(kappa));
    out *= inv(sqrt2()) * inv_sqrt(pi());
    return(out);
  }

  // log of the normalization constant, approximated by chebyshev quadrature
  real sdm_simple_ldenom_chquad_adaptive(real c, real kappa, matrix CN) {
    int m = get_m(c,kappa);
    vector[m] cosn = CN[1:m,m];
    vector[m] fn = exp(fma(kappa,cosn,c)) * sqrt(kappa) * inv(sqrt2()) * inv_sqrt(pi());
    real out = -log_sum_exp(fn)+log(m);
    return(out);
  }
}
data {
  int&lt;lower=1&gt; N;  // total number of observations
  vector[N] Y;  // response variable
  int&lt;lower=1&gt; K_c;  // number of population-level effects
  matrix[N, K_c] X_c;  // population-level design matrix
  int&lt;lower=1&gt; K_kappa;  // number of population-level effects
  matrix[N, K_kappa] X_kappa;  // population-level design matrix
  int prior_only;  // should the likelihood be ignored?
}
transformed data {
    // precompute chebyshev points
  matrix[200,200] COSN;
  for (m in 1:200) {
    for (i in 1:m) {
      COSN[i,m] = cos((2*i-1)*pi()/(2*m))-1;
    }
  }
}
parameters {
  vector[K_c] b_c;  // regression coefficients
  vector[K_kappa] b_kappa;  // regression coefficients
}
transformed parameters {
  real Intercept;  // temporary intercept for centered predictors
  real lprior = 0;  // prior contributions to the log posterior
  Intercept = 0;
  lprior += student_t_lpdf(b_c | 5, 2, 0.75);
  lprior += student_t_lpdf(b_kappa | 5, 1.75, 0.75);
}
model {
  // likelihood including constants
  if (!prior_only) {
    // initialize linear predictor term
    vector[N] mu = rep_vector(0.0, N);
    // initialize linear predictor term
    vector[N] c = rep_vector(0.0, N);
    // initialize linear predictor term
    vector[N] kappa = rep_vector(0.0, N);
    mu += Intercept;
    c += X_c * b_c;
    kappa += X_kappa * b_kappa;
    mu = inv_tan_half(mu);
    kappa = exp(kappa);
    target += sdm_simple_lpdf(Y | mu, c, kappa);
      // adaptive calculation of the normalization constant
    real z;
    for (n in 1:N) {
        if (n == 1 || c[n] != c[n-1] || kappa[n] != kappa[n-1]) {
            z = sdm_simple_ldenom_chquad_adaptive(c[n],kappa[n],COSN);
        }
        target += z;
    }
    target += -(log2()+log(pi()))*N;
  }
  // priors including constants
  target += lprior;
}
generated quantities {
  // actual population-level intercept
  real b_Intercept = Intercept;
}</code></pre>
<p>Alternatively, if you already have a fitted model object, you can just call
<code><a href="../reference/stancode.bmmformula.html">stancode()</a></code> on that object, which will give you the same result:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bmm.html">bmm</a></span><span class="op">(</span><span class="fu"><a href="../reference/bmmformula.html">bmf</a></span><span class="op">(</span><span class="va">c</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">set_size</span>, <span class="va">kappa</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">set_size</span><span class="op">)</span>, </span>
<span>              data <span class="op">=</span> <span class="va">oberauer_lin_2017</span>,</span>
<span>              model <span class="op">=</span> <span class="fu"><a href="../reference/sdm.html">sdm</a></span><span class="op">(</span>resp_error <span class="op">=</span> <span class="st">'dev_rad'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/stancode.bmmformula.html">stancode</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2" number="3">
<h2 id="extracting-the-stan-data">
<span class="header-section-number">3</span> Extracting the Stan data<a class="anchor" aria-label="anchor" href="#extracting-the-stan-data"></a>
</h2>
<p>If you want to extract the data that would be used for fitting a model, you can
use the <code><a href="../reference/standata.bmmformula.html">standata()</a></code> function from <code>brms</code>. This function will return a list with
the data that would be passed to Stan for fitting the model.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/standata.bmmformula.html">standata</a></span><span class="op">(</span><span class="fu"><a href="../reference/bmmformula.html">bmf</a></span><span class="op">(</span><span class="va">c</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">set_size</span>, <span class="va">kappa</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">set_size</span><span class="op">)</span>, </span>
<span>               data <span class="op">=</span> <span class="va">oberauer_lin_2017</span>,</span>
<span>               model <span class="op">=</span> <span class="fu"><a href="../reference/sdm.html">sdm</a></span><span class="op">(</span>resp_error <span class="op">=</span> <span class="st">'dev_rad'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">sd</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 10</span></span>
<span><span class="co">#&gt;  $ N         : int 15200</span></span>
<span><span class="co">#&gt;  $ Y         : num [1:15200(1d)] 0.384 -0.4538 -0.0873 0.3665 -0.0349 ...</span></span>
<span><span class="co">#&gt;  $ K         : int 1</span></span>
<span><span class="co">#&gt;  $ Kc        : num 0</span></span>
<span><span class="co">#&gt;  $ X         : num [1:15200, 1] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#&gt;   .. ..$ : chr [1:15200] "1" "2" "3" "4" ...</span></span>
<span><span class="co">#&gt;   .. ..$ : chr "Intercept"</span></span>
<span><span class="co">#&gt;   ..- attr(*, "assign")= int 0</span></span>
<span><span class="co">#&gt;  $ K_c       : int 8</span></span>
<span><span class="co">#&gt;  $ X_c       : num [1:15200, 1:8] 0 0 0 0 1 1 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#&gt;   .. ..$ : chr [1:15200] "1" "2" "3" "4" ...</span></span>
<span><span class="co">#&gt;   .. ..$ : chr [1:8] "set_size1" "set_size2" "set_size3" "set_size4" ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "assign")= int [1:8] 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;   ..- attr(*, "contrasts")=List of 1</span></span>
<span><span class="co">#&gt;   .. ..$ set_size: num [1:8, 1:7] 0 1 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;   .. .. ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#&gt;   .. .. .. ..$ : chr [1:8] "1" "2" "3" "4" ...</span></span>
<span><span class="co">#&gt;   .. .. .. ..$ : chr [1:7] "2" "3" "4" "5" ...</span></span>
<span><span class="co">#&gt;  $ K_kappa   : int 8</span></span>
<span><span class="co">#&gt;  $ X_kappa   : num [1:15200, 1:8] 0 0 0 0 1 1 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#&gt;   .. ..$ : chr [1:15200] "1" "2" "3" "4" ...</span></span>
<span><span class="co">#&gt;   .. ..$ : chr [1:8] "set_size1" "set_size2" "set_size3" "set_size4" ...</span></span>
<span><span class="co">#&gt;   ..- attr(*, "assign")= int [1:8] 1 1 1 1 1 1 1 1</span></span>
<span><span class="co">#&gt;   ..- attr(*, "contrasts")=List of 1</span></span>
<span><span class="co">#&gt;   .. ..$ set_size: num [1:8, 1:7] 0 1 0 0 0 0 0 0 0 0 ...</span></span>
<span><span class="co">#&gt;   .. .. ..- attr(*, "dimnames")=List of 2</span></span>
<span><span class="co">#&gt;   .. .. .. ..$ : chr [1:8] "1" "2" "3" "4" ...</span></span>
<span><span class="co">#&gt;   .. .. .. ..$ : chr [1:7] "2" "3" "4" "5" ...</span></span>
<span><span class="co">#&gt;  $ prior_only: int 0</span></span>
<span><span class="co">#&gt;  - attr(*, "class")= chr [1:2] "standata" "list"</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Vencislav Popov, Gidon T. Frischkorn.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
