Internal model tests
================
2024-02-14

``` r
# load current version of the package on whichever branch you are on
devtools::load_all(".")
library(dplyr)
library(brms)
library(chkptstanr)

# this allows you to avoid recompiling stan models if the code doesn't change
# cmdstanr_output_dir <- here::here("tests/internal/cmdstanr_output")
# if (!dir.exists(cmdstanr_output_dir)) {
#   dir.create(cmdstanr_output_dir)
# }
# options(cmdstanr_write_stan_file_dir = cmdstanr_output_dir,
#         bmm.sort_data = TRUE)
options(bmm.sort_data = TRUE)

# checkpoint folder
basepath <- "tests/internal/checkpoints1/"
withr::defer({
  dirs <- list.files(here::here(basepath), full.names = TRUE)
  for (dir in dirs) {
    reset_checkpoints(path)
  }
})
```

## Introduction

(THIS TESTS SPECIFICALLY THE NEW CHECKPOINT FUNCTIONALITY)

This document contains code snippets for internal model tests. Since
official unit tests via testthat would take too long for actual models
to run every time, we use a mock backend to make sure that the models
are correctly specified and that the fit_model() function works as
expected, except for the actual sampling part.

Using this document, we can run the actual models and make sure they
return the expected results even after changes to the code. The basic
idea is that we have run and stored the model results at a point at
which everything was working as expected. We can then compare the
results of the models to the stored results. Passing a seed to the
fit_model() function ensures that the results are reproducible.
Differences might arise from changes in the underlying packages (brms,
rstan, cmdstanr) or from changes to the model specifications. In which
case we would have to make sure that the results are similar, even if
not identical, and update the stored results.

- \[\] TODO: for now it’s visual inspection. Maybe add explicit test
  with a threshold for estimation differences in a testthat test that is
  run manually only, or on a server.

### Reference fits source

The reference fits are stored in the `tests/internal/ref_fits`
directory. They were generated by the script
`tests/internal/generate_ref_model_fits.R`.

### Important

Set cache to true if you’ve done all the fits interactively and you want
to knit the document without refitting for new tests. Set cache to false
before you start. The whole file currently takes about 20 minutes to run
for all seven models total.

- note1: actually turns out the cache doesn’t transfer between
  interactive mode and knitting the whole document. It is still use to
  keep it set to TRUE, if you just want to add another comparison, then
  knit the whole document without refitting everything else
- note2: I can potentially change the caching to be based on this
  approach instead, which should work both interactively and knittingly
  (is that a word?):
  <https://bookdown.org/yihui/rmarkdown-cookbook/cache-rds.html#cache-rds>

### Load reference model fits

``` r
# TODO: for the future releases, save full information about the bmm model components in the reference fits
# also save information about operating system, but only for testing, not for general usage

# choose id for the reference fits if multiple exist
version <- "v0.2.1"
seed <- 365
date <- "20240215"

# filter by id
ref_dir <- here::here('tests/internal/ref_fits')
ref_files <- list.files(ref_dir, full.names = TRUE)
chosen_files <- grepl(version, ref_files) & grepl(date, ref_files) & grepl(paste0("seed-",seed), ref_files)
ref_files <- ref_files[chosen_files]

# load reference fits
ref_fits <- lapply(ref_files, readRDS)

# get only the model label from the file name, which is between version_ and _seed, 
ref_labels <- gsub(paste0(".*", version, "_"), "", ref_files)
ref_labels <- gsub("_seed-.*", "", ref_labels)

if (length(unique(ref_labels)) != length(ref_labels)) {
  stop("There are multiple reference fits with the same label. Choose which files to keep manually")
}

names(ref_fits) <- ref_labels
```

prepare a list to hold data the fits

``` r
fit <- list()
```

## Test: sdmSimple

*Note: In the future if the API doesn’t change, we can just use
arguments from the reference fit. For now it doesn’t work since the
formula and model definition have changed since version 0.2.1.*

<details>
<summary>
Run the model
</summary>

``` r
path <- file_path2(here::here(), basepath, "sdmSimple")
data <- ref_fits$sdmSimple$data

formula <- bmf(c ~ 0 + SetSize,
               kappa ~ 1)

model <- sdmSimple('dev_rad')

# stop after 3 checkpoints
fit$sdmSimple.1 <- fit_model(formula, data, model,
                             parallel = TRUE,
                             chains = 4,
                             iter = 2000,
                             refresh = 500,
                             init = 1,
                             silent = 2,
                             backend = 'cmdstanr',
                             seed = seed, 
                             checkpoint_every = 250,
                             stop_after = 750,
                             checkpoints_folder = path)
```

    ## 
    ## Your data has been sorted by the following predictors: SetSize

    ## * caution: you have set `sort_data=TRUE`. You need to be careful when using
    ## brms postprocessing methods that rely on the data order, such as generating
    ## predictions. Assuming you assigned the result of fit_model to a variable called
    ## `fit`, you can extract the sorted data from the fitted object with:
    ## 
    ## data_sorted <- fit$fit_args$data

    ## Sampling will stop after checkpoint 3

    ## Initial Warmup (Typical Set)

    ## Chkpt: 1 / 8; Iteration: 250 / 2000 (warmup)
    ## Chkpt: 2 / 8; Iteration: 500 / 2000 (warmup)
    ## Chkpt: 3 / 8; Iteration: 750 / 2000 (warmup)

    ## Stopping after 3 checkpoints

    ## 
    ## Interupted during warmup. No samples available.

``` r
# resume checkpoint
fit$sdmSimple <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 2000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed, 
                           checkpoint_every = 250,
                           checkpoints_folder = path)
```

    ## 
    ## Your data has been sorted by the following predictors: SetSize

    ## * caution: you have set `sort_data=TRUE`. You need to be careful when using
    ## brms postprocessing methods that rely on the data order, such as generating
    ## predictions. Assuming you assigned the result of fit_model to a variable called
    ## `fit`, you can extract the sorted data from the fitted object with:
    ## 
    ## data_sorted <- fit$fit_args$data

    ## Chkpt: 4 / 8; Iteration: 1000 / 2000 (warmup)
    ## Chkpt: 5 / 8; Iteration: 1250 / 2000 (sample)
    ## Chkpt: 6 / 8; Iteration: 1500 / 2000 (sample)
    ## Chkpt: 7 / 8; Iteration: 1750 / 2000 (sample)
    ## Chkpt: 8 / 8; Iteration: 2000 / 2000 (sample)

    ## Checkpointing complete

``` r
reset_checkpoints(path)
```

</details>
</br>
<details>
<summary>
The results:
</summary>

``` r
summary(fit$sdmSimple)
```

    ##  Family: sdm_simple 
    ##   Links: mu = identity; c = log; kappa = log 
    ## Formula: dev_rad ~ 1 
    ##          mu ~ 1
    ##          c ~ 0 + SetSize
    ##          kappa ~ 1
    ##    Data: data (Number of observations: 4000) 
    ##   Draws: 2 chains, each with iter = 250; warmup = 0; thin = 1;
    ##          total post-warmup draws = 500
    ## 
    ## Regression Coefficients:
    ##                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## Intercept           0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa_Intercept     1.26      0.04     1.17     1.34 1.00      560      728
    ## c_SetSize1          2.31      0.05     2.21     2.42 1.00      634      759
    ## c_SetSize2          1.86      0.04     1.78     1.94 1.00      677     1102
    ## c_SetSize3          1.55      0.04     1.47     1.62 1.00      701     1162
    ## c_SetSize4          1.30      0.04     1.22     1.37 1.00      716     1097
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

<details>
<summary>
Compare with the reference fit:
</summary>

``` r
summary(ref_fits$sdmSimple)
```

    ##  Family: sdm_simple 
    ##   Links: mu = identity; c = log; kappa = log 
    ## Formula: dev_rad ~ 1 
    ##          c ~ 0 + SetSize
    ##          kappa ~ 1
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
    ##          total post-warmup draws = 4000
    ## 
    ## Regression Coefficients:
    ##                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## Intercept           0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa_Intercept     1.26      0.04     1.18     1.35 1.00     1017     1395
    ## c_SetSize1          2.30      0.05     2.20     2.41 1.00     1267     1410
    ## c_SetSize2          1.85      0.04     1.77     1.94 1.00     1216     1342
    ## c_SetSize3          1.54      0.04     1.47     1.62 1.00     1387     1561
    ## c_SetSize4          1.29      0.04     1.22     1.37 1.00     1488     1991
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

Difference in estimates:

``` r
fixef(fit$sdmSimple) - fixef(ref_fits$sdmSimple)
```

    ##                     Estimate     Est.Error        Q2.5       Q97.5
    ## Intercept        0.000000000  0.0000000000  0.00000000  0.00000000
    ## kappa_Intercept -0.007668035 -0.0001840159 -0.00143975 -0.00829000
    ## c_SetSize1       0.007642065  0.0005012697  0.00434825  0.01007725
    ## c_SetSize2       0.006623962 -0.0011823719  0.00980725  0.00188375
    ## c_SetSize3       0.004723068  0.0007277581 -0.00038300  0.00282225
    ## c_SetSize4       0.004944878 -0.0002071649  0.00541175  0.00119250

## Test: mixture3p

<details>
<summary>
Run the model
</summary>

``` r
path <- file_path2(here::here(), basepath, "mixture3p")
data <- ref_fits$mixture3p$data

formula <- bmf(thetat ~ 0 + SetSize,
               thetant ~ 0 + SetSize,
               kappa ~ 0 + SetSize)

model <- mixture3p(resp_err = 'dev_rad',
                   nt_features = paste0("Item", 2:4,"_Col_rad"),
                   setsize = "SetSize")

fit$mixture3p.1 <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 1000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed, 
                           checkpoint_every = 250,
                           stop_after = 750,
                           checkpoints_folder = path)
```

    ## Sampling will stop after checkpoint 3

    ## Initial Warmup (Typical Set)

    ## Chkpt: 1 / 4; Iteration: 250 / 1000 (warmup)
    ## Chkpt: 2 / 4; Iteration: 500 / 1000 (warmup)
    ## Chkpt: 3 / 4; Iteration: 750 / 1000 (sample)

    ## Stopping after 3 checkpoints

``` r
fit$mixture3p <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 1000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed, 
                           checkpoint_every = 250,
                           checkpoints_folder = path)
```

    ## Chkpt: 4 / 4; Iteration: 1000 / 1000 (sample)

    ## Checkpointing complete

``` r
reset_checkpoints(path)
```

</details>

</br>

<details>
<summary>
Results
</summary>

``` r
summary(fit$mixture3p)
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          mu1 ~ 1
    ##          kappa ~ 0 + SetSize
    ##          thetat ~ 0 + SetSize
    ##          thetant ~ 0 + SetSize
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ thetat
    ##          kappa1 ~ kappa
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (thetant + log(inv_ss)) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (thetant + log(inv_ss)) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (thetant + log(inv_ss)) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: data (Number of observations: 4000) 
    ##   Draws: 2 chains, each with iter = 250; warmup = 0; thin = 1;
    ##          total post-warmup draws = 500
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## kappa_SetSize1       3.06      0.05     2.96     3.16 1.00     1475      781
    ## kappa_SetSize2       2.45      0.05     2.34     2.56 1.00      983      678
    ## kappa_SetSize3       2.15      0.07     2.02     2.28 1.00     1233      837
    ## kappa_SetSize4       2.02      0.09     1.83     2.21 1.00     1217      757
    ## thetat_SetSize1      4.22      0.33     3.63     4.91 1.01     1004      598
    ## thetat_SetSize2      2.85      0.20     2.48     3.26 1.00     1194      836
    ## thetat_SetSize3      1.86      0.16     1.56     2.18 1.00      847      725
    ## thetat_SetSize4      0.97      0.14     0.71     1.25 1.00      831      660
    ## thetant_SetSize1  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## thetant_SetSize2    -0.82      0.42    -1.76    -0.10 1.00     1246      685
    ## thetant_SetSize3    -0.44      0.28    -1.04     0.09 1.00      870      677
    ## thetant_SetSize4    -0.81      0.29    -1.40    -0.24 1.00     1023      780
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

<details>
<summary>
Compare with reference fit:
</summary>

``` r
ref_fits$mixture3p
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          thetat ~ 0 + SetSize
    ##          thetant ~ 0 + SetSize
    ##          kappa ~ 0 + SetSize
    ##          mu1 ~ 1
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ thetat
    ##          kappa1 ~ kappa
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (thetant + log(inv_ss)) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (thetant + log(inv_ss)) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (thetant + log(inv_ss)) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 1000; warmup = 500; thin = 1;
    ##          total post-warmup draws = 2000
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## thetat_SetSize1      4.21      0.32     3.65     4.91 1.00     2177     1474
    ## thetat_SetSize2      2.85      0.20     2.48     3.24 1.00     1854     1524
    ## thetat_SetSize3      1.85      0.16     1.54     2.19 1.00     1609     1537
    ## thetat_SetSize4      0.96      0.14     0.71     1.26 1.00     1625     1318
    ## kappa_SetSize1       3.06      0.05     2.97     3.15 1.00     2611     1558
    ## kappa_SetSize2       2.45      0.05     2.35     2.56 1.00     2198     1398
    ## kappa_SetSize3       2.14      0.07     2.01     2.27 1.00     2113     1630
    ## kappa_SetSize4       2.02      0.10     1.83     2.21 1.00     2136     1536
    ## thetant_SetSize1  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## thetant_SetSize2    -0.82      0.42    -1.76    -0.11 1.01     1792     1428
    ## thetant_SetSize3    -0.44      0.29    -1.02     0.14 1.00     1634     1530
    ## thetant_SetSize4    -0.83      0.30    -1.48    -0.28 1.00     1592     1490
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

Difference in estimates

``` r
withr::local_options(list(digits=3))
fit_rows <- rownames(fixef(fit$mixture3p))
round(fixef(fit$mixture3p) - fixef(ref_fits$mixture3p)[fit_rows,],3)
```

    ##                  Estimate Est.Error   Q2.5  Q97.5
    ## mu1_Intercept       0.000     0.000  0.000  0.000
    ## mu5_Intercept       0.000     0.000  0.000  0.000
    ## kappa5_Intercept    0.000     0.000  0.000  0.000
    ## kappa_SetSize1      0.002     0.004 -0.010  0.010
    ## kappa_SetSize2     -0.003     0.001 -0.008  0.000
    ## kappa_SetSize3      0.006     0.000  0.008  0.011
    ## kappa_SetSize4     -0.003    -0.003  0.000 -0.004
    ## thetat_SetSize1     0.008     0.010 -0.024  0.001
    ## thetat_SetSize2    -0.001     0.007 -0.006  0.013
    ## thetat_SetSize3     0.002    -0.001  0.013 -0.002
    ## thetat_SetSize4     0.007    -0.003 -0.003 -0.005
    ## thetant_SetSize1    0.000     0.000  0.000  0.000
    ## thetant_SetSize2   -0.005     0.002 -0.002  0.007
    ## thetant_SetSize3   -0.004    -0.010 -0.019 -0.051
    ## thetant_SetSize4    0.019    -0.008  0.079  0.038

## Test: mixture2p

<details>
<summary>
Run the model
</summary>

``` r
path <- file_path2(here::here(), basepath, "mixture2p")
data <- ref_fits$mixture2p$data

formula <- bmf(thetat ~ 0 + SetSize,
               kappa ~ 0 + SetSize)

model <- mixture2p(resp_err = 'dev_rad')

fit$mixture2p.1 <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 2000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed, 
                           checkpoint_every = 250,
                           stop_after = 750,
                           checkpoints_folder = path)
```

    ## Sampling will stop after checkpoint 3

    ## In file included from stan/lib/stan_math/stan/math/prim/prob/von_mises_lccdf.hpp:5,
    ##                  from stan/lib/stan_math/stan/math/prim/prob/von_mises_ccdf_log.hpp:4,
    ##                  from stan/lib/stan_math/stan/math/prim/prob.hpp:359,
    ##                  from stan/lib/stan_math/stan/math/prim.hpp:16,
    ##                  from stan/lib/stan_math/stan/math/rev.hpp:16,
    ##                  from stan/lib/stan_math/stan/math.hpp:19,
    ##                  from stan/src/stan/model/model_header.hpp:4,
    ##                  from C:/Users/vepopo/AppData/Local/Temp/RtmpWAWXXt/model-73a4387d5f5c.hpp:2:
    ## stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp: In function 'stan::return_type_t<T_x, T_sigma, T_l> stan::math::von_mises_cdf(const T_x&, const T_mu&, const T_k&)':
    ## stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: '-Wmisleading-indentation' is disabled from this point onwards, since column-tracking was disabled due to the size of the code/headers
    ##   194 |       if (cdf_n < 0.0)
    ##       |

    ## stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: adding '-flarge-source-files' will allow for more column-tracking support, at the expense of compilation time and memory

    ## Initial Warmup (Typical Set)

    ## Chkpt: 1 / 8; Iteration: 250 / 2000 (warmup)
    ## Chkpt: 2 / 8; Iteration: 500 / 2000 (warmup)
    ## Chkpt: 3 / 8; Iteration: 750 / 2000 (warmup)

    ## Stopping after 3 checkpoints

    ## 
    ## Interupted during warmup. No samples available.

``` r
fit$mixture2p <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 2000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed, 
                           checkpoint_every = 250,
                           checkpoints_folder = path)
```

    ## Chkpt: 4 / 8; Iteration: 1000 / 2000 (warmup)
    ## Chkpt: 5 / 8; Iteration: 1250 / 2000 (sample)
    ## Chkpt: 6 / 8; Iteration: 1500 / 2000 (sample)
    ## Chkpt: 7 / 8; Iteration: 1750 / 2000 (sample)
    ## Chkpt: 8 / 8; Iteration: 2000 / 2000 (sample)

    ## Checkpointing complete

``` r
reset_checkpoints(path)
```

</details>

</br>

<details>
<summary>
Results
</summary>

``` r
summary(fit$mixture2p)
```

    ##  Family: mixture(von_mises, von_mises) 
    ##   Links: mu1 = tan_half; kappa1 = log; mu2 = tan_half; kappa2 = log; theta1 = identity; theta2 = identity 
    ## Formula: dev_rad ~ 1 
    ##          mu1 ~ 1
    ##          kappa ~ 0 + SetSize
    ##          thetat ~ 0 + SetSize
    ##          kappa2 ~ 1
    ##          mu2 ~ 1
    ##          kappa1 ~ kappa
    ##          theta1 ~ thetat
    ##    Data: data (Number of observations: 4000) 
    ##   Draws: 2 chains, each with iter = 250; warmup = 0; thin = 1;
    ##          total post-warmup draws = 500
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu2_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa2_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## kappa_SetSize1       3.06      0.05     2.96     3.15 1.00     2690     1533
    ## kappa_SetSize2       2.46      0.05     2.35     2.56 1.00     2191     1584
    ## kappa_SetSize3       2.17      0.07     2.03     2.30 1.00     2698     1293
    ## kappa_SetSize4       2.03      0.09     1.85     2.22 1.00     2736     1783
    ## thetat_SetSize1      4.21      0.33     3.64     4.88 1.00     1754     1415
    ## thetat_SetSize2      2.45      0.15     2.17     2.76 1.01     2623     1748
    ## thetat_SetSize3      1.33      0.10     1.13     1.53 1.00     3007     1499
    ## thetat_SetSize4      0.61      0.10     0.42     0.80 1.00     2630     1577
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

<details>
<summary>
Compare with the reference fit:
</summary>

``` r
summary(ref_fits$mixture2p)
```

    ##  Family: mixture(von_mises, von_mises) 
    ##   Links: mu1 = tan_half; kappa1 = log; mu2 = tan_half; kappa2 = log; theta1 = identity; theta2 = identity 
    ## Formula: dev_rad ~ 1 
    ##          thetat ~ 0 + SetSize
    ##          kappa ~ 0 + SetSize
    ##          kappa2 ~ 1
    ##          mu1 ~ 1
    ##          mu2 ~ 1
    ##          kappa1 ~ kappa
    ##          theta1 ~ thetat
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 1000; warmup = 500; thin = 1;
    ##          total post-warmup draws = 2000
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu2_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa2_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## thetat_SetSize1      4.21      0.32     3.64     4.90 1.00     3266     1515
    ## thetat_SetSize2      2.46      0.14     2.18     2.75 1.00     2928     1439
    ## thetat_SetSize3      1.34      0.11     1.12     1.55 1.00     3161     1476
    ## thetat_SetSize4      0.61      0.10     0.42     0.80 1.00     2783     1650
    ## kappa_SetSize1       3.06      0.05     2.96     3.16 1.00     3243     1208
    ## kappa_SetSize2       2.46      0.05     2.35     2.55 1.00     2784     1845
    ## kappa_SetSize3       2.17      0.07     2.03     2.31 1.00     2693     1443
    ## kappa_SetSize4       2.04      0.10     1.85     2.23 1.00     2857     1462
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

Difference in estimates

``` r
withr::local_options(list(digits=3))
fit_rows <- rownames(fixef(fit$mixture2p))
round(fixef(fit$mixture2p) - fixef(ref_fits$mixture2p)[fit_rows,],3)
```

    ##                  Estimate Est.Error   Q2.5  Q97.5
    ## mu1_Intercept       0.000     0.000  0.000  0.000
    ## mu2_Intercept       0.000     0.000  0.000  0.000
    ## kappa2_Intercept    0.000     0.000  0.000  0.000
    ## kappa_SetSize1      0.001    -0.001  0.001 -0.003
    ## kappa_SetSize2      0.000     0.002  0.002  0.007
    ## kappa_SetSize3     -0.002    -0.003  0.002 -0.002
    ## kappa_SetSize4     -0.004    -0.004  0.000 -0.007
    ## thetat_SetSize1    -0.004     0.009 -0.007 -0.018
    ## thetat_SetSize2    -0.002     0.011 -0.017  0.005
    ## thetat_SetSize3    -0.003    -0.003  0.008 -0.016
    ## thetat_SetSize4     0.003    -0.001  0.004  0.006

## Test: IMMfull

<details>
<summary>
Run the model
</summary>

``` r
path <- file_path2(here::here(), basepath, "IMMfull")
data <- ref_fits$IMMfull$data

formula <- bmf(a ~ 0 + SetSize,
               c ~ 0 + SetSize,
               s ~ 0 + SetSize,
               kappa ~ 0 + SetSize)

model <- IMMfull(resp_err = 'dev_rad',
                 nt_features = paste0("Item", 2:4,"_Col_rad"),
                 nt_distances = paste0("Item", 2:4,"_Pos_rad"),
                 setsize = "SetSize")

fit$IMMfull.1 <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 1000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed, 
                           checkpoint_every = 250,
                           stop_after = 750,
                           checkpoints_folder = path)
```

    ## Sampling will stop after checkpoint 3

    ## In file included from stan/lib/stan_math/stan/math/prim/prob/von_mises_lccdf.hpp:5,
    ##                  from stan/lib/stan_math/stan/math/prim/prob/von_mises_ccdf_log.hpp:4,
    ##                  from stan/lib/stan_math/stan/math/prim/prob.hpp:359,
    ##                  from stan/lib/stan_math/stan/math/prim.hpp:16,
    ##                  from stan/lib/stan_math/stan/math/rev.hpp:16,
    ##                  from stan/lib/stan_math/stan/math.hpp:19,
    ##                  from stan/src/stan/model/model_header.hpp:4,
    ##                  from C:/Users/vepopo/AppData/Local/Temp/RtmpWAWXXt/model-73a44c0f4805.hpp:2:
    ## stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp: In function 'stan::return_type_t<T_x, T_sigma, T_l> stan::math::von_mises_cdf(const T_x&, const T_mu&, const T_k&)':
    ## stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: '-Wmisleading-indentation' is disabled from this point onwards, since column-tracking was disabled due to the size of the code/headers
    ##   194 |       if (cdf_n < 0.0)
    ##       |

    ## stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: adding '-flarge-source-files' will allow for more column-tracking support, at the expense of compilation time and memory

    ## Initial Warmup (Typical Set)

    ## Chkpt: 1 / 4; Iteration: 250 / 1000 (warmup)
    ## Chkpt: 2 / 4; Iteration: 500 / 1000 (warmup)
    ## Chkpt: 3 / 4; Iteration: 750 / 1000 (sample)

    ## Stopping after 3 checkpoints

``` r
fit$IMMfull <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 1000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed, 
                           checkpoint_every = 250,
                           checkpoints_folder = path)
```

    ## Chkpt: 4 / 4; Iteration: 1000 / 1000 (sample)

    ## Checkpointing complete

``` r
reset_checkpoints(path)
```

</details>

</br>

<details>
<summary>
Results
</summary>

``` r
summary(fit$IMMfull)
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          mu1 ~ 1
    ##          kappa ~ 0 + SetSize
    ##          a ~ 0 + SetSize
    ##          c ~ 0 + SetSize
    ##          s ~ 0 + SetSize
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ c + a
    ##          kappa1 ~ kappa
    ##          expS ~ exp(s)
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (exp(-expS * Item2_Pos_rad) * c + a) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (exp(-expS * Item3_Pos_rad) * c + a) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (exp(-expS * Item4_Pos_rad) * c + a) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: data (Number of observations: 4000) 
    ##   Draws: 2 chains, each with iter = 250; warmup = 0; thin = 1;
    ##          total post-warmup draws = 500
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## kappa_SetSize1       3.07      0.05     2.98     3.16 1.00     1222      530
    ## kappa_SetSize2       2.44      0.06     2.34     2.55 1.00     1221      678
    ## kappa_SetSize3       2.14      0.06     2.01     2.26 1.00     1709      750
    ## kappa_SetSize4       2.00      0.10     1.81     2.19 1.00     1098      751
    ## c_SetSize1           3.94      0.26     3.43     4.47 1.00      780      489
    ## c_SetSize2           3.45      0.24     3.04     3.95 1.00      744      693
    ## c_SetSize3           2.93      0.20     2.58     3.33 1.00      699      811
    ## c_SetSize4           2.76      0.19     2.41     3.16 1.00     1083      670
    ## a_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## a_SetSize2          -0.51      0.32    -1.15     0.12 1.00      683      747
    ## a_SetSize3          -1.00      0.29    -1.57    -0.47 1.00      651      706
    ## a_SetSize4          -1.71      0.27    -2.27    -1.20 1.00      711      700
    ## s_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## s_SetSize2           1.77      0.47     0.99     2.78 1.00      846      413
    ## s_SetSize3           1.56      0.48     0.84     2.72 1.00      739      594
    ## s_SetSize4           1.72      0.44     1.02     2.74 1.00     1550      591
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

<details>
<summary>
Compare with reference fit:
</summary>

``` r
ref_fits$IMMfull
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          a ~ 0 + SetSize
    ##          c ~ 0 + SetSize
    ##          s ~ 0 + SetSize
    ##          kappa ~ 0 + SetSize
    ##          mu1 ~ 1
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ c + a
    ##          kappa1 ~ kappa
    ##          expS ~ exp(s)
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (exp(-expS * Item2_Pos_rad) * c + a) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (exp(-expS * Item3_Pos_rad) * c + a) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (exp(-expS * Item4_Pos_rad) * c + a) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 1000; warmup = 500; thin = 1;
    ##          total post-warmup draws = 2000
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## c_SetSize1           3.94      0.27     3.44     4.49 1.00     2739     1614
    ## c_SetSize2           3.44      0.25     3.02     3.96 1.00     1904     1095
    ## c_SetSize3           2.92      0.19     2.57     3.34 1.00     1524     1060
    ## c_SetSize4           2.76      0.20     2.40     3.20 1.00     1712     1107
    ## kappa_SetSize1       3.07      0.05     2.98     3.16 1.00     3543     1526
    ## kappa_SetSize2       2.45      0.05     2.33     2.55 1.00     3452     1142
    ## kappa_SetSize3       2.14      0.06     2.01     2.27 1.00     4016     1292
    ## kappa_SetSize4       2.00      0.10     1.81     2.19 1.00     2968     1315
    ## a_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## a_SetSize2          -0.50      0.33    -1.17     0.16 1.00     1836     1284
    ## a_SetSize3          -0.99      0.29    -1.56    -0.42 1.00     1561     1203
    ## a_SetSize4          -1.71      0.28    -2.29    -1.19 1.00     1758      958
    ## s_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## s_SetSize2           1.74      0.50     0.94     2.94 1.00     2442     1341
    ## s_SetSize3           1.60      0.50     0.80     2.75 1.00     1712     1164
    ## s_SetSize4           1.73      0.48     1.00     2.87 1.00     2043     1091
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

Difference in estimates

``` r
withr::local_options(list(digits=3))
fit_rows <- rownames(fixef(fit$IMMfull))
round(fixef(fit$IMMfull) - fixef(ref_fits$IMMfull)[fit_rows,],3)
```

    ##                  Estimate Est.Error   Q2.5  Q97.5
    ## mu1_Intercept       0.000     0.000  0.000  0.000
    ## mu5_Intercept       0.000     0.000  0.000  0.000
    ## kappa5_Intercept    0.000     0.000  0.000  0.000
    ## kappa_SetSize1      0.001     0.000 -0.001 -0.001
    ## kappa_SetSize2     -0.002     0.002  0.007 -0.005
    ## kappa_SetSize3      0.000     0.000  0.003 -0.006
    ## kappa_SetSize4     -0.003    -0.001 -0.004  0.002
    ## c_SetSize1         -0.005    -0.009 -0.005 -0.021
    ## c_SetSize2          0.010    -0.006  0.015 -0.014
    ## c_SetSize3          0.007     0.003  0.014 -0.010
    ## c_SetSize4          0.002    -0.004  0.005 -0.037
    ## a_SetSize1          0.000     0.000  0.000  0.000
    ## a_SetSize2         -0.010    -0.013  0.024 -0.040
    ## a_SetSize3         -0.006     0.001 -0.012 -0.044
    ## a_SetSize4          0.002    -0.008  0.020 -0.015
    ## s_SetSize1          0.000     0.000  0.000  0.000
    ## s_SetSize2          0.027    -0.029  0.052 -0.161
    ## s_SetSize3         -0.041    -0.021  0.039 -0.026
    ## s_SetSize4         -0.012    -0.039  0.023 -0.129

## Test: IMMbsc

<details>
<summary>
Run the model
</summary>

``` r
path <- file_path2(here::here(), basepath, "IMMbsc")
data <- ref_fits$IMMbsc$data

formula <- bmf(c ~ 0 + SetSize,
               s ~ 0 + SetSize,
               kappa ~ 0 + SetSize)

model <- IMMbsc(resp_err = 'dev_rad',
                nt_features = paste0("Item", 2:4,"_Col_rad"),
                nt_distances = paste0("Item", 2:4,"_Pos_rad"),
                setsize = "SetSize")

fit$IMMbsc.1 <- fit_model(formula, data, model,
                        parallel = TRUE,
                        chains = 4,
                        iter = 1000,
                        refresh = 500,
                        init = 1,
                        silent = 2,
                        backend = 'cmdstanr',
                        seed = seed, 
                        checkpoint_every = 250,
                        stop_after = 750,
                        checkpoints_folder = path)
```

    ## Sampling will stop after checkpoint 3

    ## In file included from stan/lib/stan_math/stan/math/prim/prob/von_mises_lccdf.hpp:5,
    ##                  from stan/lib/stan_math/stan/math/prim/prob/von_mises_ccdf_log.hpp:4,
    ##                  from stan/lib/stan_math/stan/math/prim/prob.hpp:359,
    ##                  from stan/lib/stan_math/stan/math/prim.hpp:16,
    ##                  from stan/lib/stan_math/stan/math/rev.hpp:16,
    ##                  from stan/lib/stan_math/stan/math.hpp:19,
    ##                  from stan/src/stan/model/model_header.hpp:4,
    ##                  from C:/Users/vepopo/AppData/Local/Temp/RtmpWAWXXt/model-73a4158576ba.hpp:2:
    ## stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp: In function 'stan::return_type_t<T_x, T_sigma, T_l> stan::math::von_mises_cdf(const T_x&, const T_mu&, const T_k&)':
    ## stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: '-Wmisleading-indentation' is disabled from this point onwards, since column-tracking was disabled due to the size of the code/headers
    ##   194 |       if (cdf_n < 0.0)
    ##       |

    ## stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: adding '-flarge-source-files' will allow for more column-tracking support, at the expense of compilation time and memory

    ## Initial Warmup (Typical Set)

    ## Chkpt: 1 / 4; Iteration: 250 / 1000 (warmup)
    ## Chkpt: 2 / 4; Iteration: 500 / 1000 (warmup)
    ## Chkpt: 3 / 4; Iteration: 750 / 1000 (sample)

    ## Stopping after 3 checkpoints

``` r
fit$IMMbsc <- fit_model(formula, data, model,
                        parallel = TRUE,
                        chains = 4,
                        iter = 1000,
                        refresh = 500,
                        init = 1,
                        silent = 2,
                        backend = 'cmdstanr',
                        seed = seed, 
                        checkpoint_every = 250,
                        checkpoints_folder = path)
```

    ## Chkpt: 4 / 4; Iteration: 1000 / 1000 (sample)

    ## Checkpointing complete

``` r
reset_checkpoints(path)
```

</details>

</br>

<details>
<summary>
Results
</summary>

``` r
summary(fit$IMMbsc)
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          mu1 ~ 1
    ##          kappa ~ 0 + SetSize
    ##          c ~ 0 + SetSize
    ##          s ~ 0 + SetSize
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ c
    ##          kappa1 ~ kappa
    ##          expS ~ exp(s)
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (exp(-expS * Item2_Pos_rad) * c) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (exp(-expS * Item3_Pos_rad) * c) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (exp(-expS * Item4_Pos_rad) * c) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: data (Number of observations: 4000) 
    ##   Draws: 2 chains, each with iter = 250; warmup = 0; thin = 1;
    ##          total post-warmup draws = 500
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## kappa_SetSize1       3.07      0.05     2.98     3.16 1.00     1387      885
    ## kappa_SetSize2       2.43      0.05     2.33     2.54 1.00     1686      743
    ## kappa_SetSize3       2.07      0.06     1.94     2.19 1.00     1574      699
    ## kappa_SetSize4       1.64      0.08     1.48     1.80 1.00     1309      768
    ## c_SetSize1           3.94      0.27     3.46     4.48 1.00     1524      485
    ## c_SetSize2           3.17      0.14     2.90     3.43 1.00     1109      875
    ## c_SetSize3           2.52      0.10     2.31     2.72 1.00      980      619
    ## c_SetSize4           2.20      0.10     2.02     2.40 1.00      963      801
    ## s_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## s_SetSize2           1.85      0.42     1.17     2.81 1.00     1365      825
    ## s_SetSize3           1.88      0.51     1.13     3.19 1.01      725      413
    ## s_SetSize4           1.93      0.46     1.19     2.95 1.00     1200      636
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

<details>
<summary>
Compare with reference fit:
</summary>

``` r
ref_fits$IMMbsc
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          c ~ 0 + SetSize
    ##          s ~ 0 + SetSize
    ##          kappa ~ 0 + SetSize
    ##          mu1 ~ 1
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ c
    ##          kappa1 ~ kappa
    ##          expS ~ exp(s)
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (exp(-expS * Item2_Pos_rad) * c) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (exp(-expS * Item3_Pos_rad) * c) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (exp(-expS * Item4_Pos_rad) * c) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 1000; warmup = 500; thin = 1;
    ##          total post-warmup draws = 2000
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## c_SetSize1           3.94      0.27     3.43     4.50 1.00     2776     1632
    ## c_SetSize2           3.17      0.15     2.90     3.47 1.00     3383     1407
    ## c_SetSize3           2.52      0.11     2.31     2.74 1.00     3596     1815
    ## c_SetSize4           2.20      0.11     2.00     2.42 1.00     2357     1411
    ## kappa_SetSize1       3.07      0.05     2.98     3.16 1.00     2849     1547
    ## kappa_SetSize2       2.43      0.05     2.33     2.54 1.00     3086     1428
    ## kappa_SetSize3       2.07      0.06     1.95     2.18 1.00     3388     1774
    ## kappa_SetSize4       1.64      0.09     1.47     1.81 1.00     2641     1628
    ## s_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## s_SetSize2           1.86      0.45     1.14     2.96 1.00     2541     1475
    ## s_SetSize3           1.86      0.48     1.11     2.98 1.00     1914     1161
    ## s_SetSize4           1.92      0.46     1.22     2.95 1.00     2369     1278
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

Difference in estimates

``` r
withr::local_options(list(digits=3))
fit_rows <- rownames(fixef(fit$IMMbsc))
round(fixef(fit$IMMbsc) - fixef(ref_fits$IMMbsc)[fit_rows,],3)
```

    ##                  Estimate Est.Error   Q2.5  Q97.5
    ## mu1_Intercept       0.000     0.000  0.000  0.000
    ## mu5_Intercept       0.000     0.000  0.000  0.000
    ## kappa5_Intercept    0.000     0.000  0.000  0.000
    ## kappa_SetSize1      0.000    -0.002  0.000  0.000
    ## kappa_SetSize2      0.001     0.000  0.002 -0.002
    ## kappa_SetSize3      0.002     0.002 -0.004  0.012
    ## kappa_SetSize4     -0.002    -0.003  0.008 -0.014
    ## c_SetSize1         -0.005    -0.004  0.021 -0.025
    ## c_SetSize2         -0.004    -0.007  0.008 -0.043
    ## c_SetSize3          0.001    -0.003  0.002 -0.019
    ## c_SetSize4          0.001    -0.008  0.024 -0.020
    ## s_SetSize1          0.000     0.000  0.000  0.000
    ## s_SetSize2         -0.009    -0.037  0.029 -0.154
    ## s_SetSize3          0.014     0.026  0.020  0.206
    ## s_SetSize4          0.008    -0.003 -0.038 -0.005

## Test: IMMabc

<details>
<summary>
Run the model
</summary>

``` r
path <- file_path2(here::here(), basepath, "IMMabc")
data <- ref_fits$IMMabc$data

formula <- bmf(a ~ 0 + SetSize,
               c ~ 0 + SetSize,
               kappa ~ 0 + SetSize)

model <- IMMabc(resp_err = 'dev_rad',
                nt_features = paste0("Item", 2:4,"_Col_rad"),
                setsize = "SetSize")

fit$IMMabc.1 <- fit_model(formula, data, model,
                        parallel = TRUE,
                        chains = 4,
                        iter = 1000,
                        refresh = 500,
                        init = 1,
                        silent = 2,
                        backend = 'cmdstanr',
                        seed = seed, 
                        checkpoint_every = 250,
                        stop_after = 750,
                        checkpoints_folder = path)
```

    ## Sampling will stop after checkpoint 3

    ## In file included from stan/lib/stan_math/stan/math/prim/prob/von_mises_lccdf.hpp:5,
    ##                  from stan/lib/stan_math/stan/math/prim/prob/von_mises_ccdf_log.hpp:4,
    ##                  from stan/lib/stan_math/stan/math/prim/prob.hpp:359,
    ##                  from stan/lib/stan_math/stan/math/prim.hpp:16,
    ##                  from stan/lib/stan_math/stan/math/rev.hpp:16,
    ##                  from stan/lib/stan_math/stan/math.hpp:19,
    ##                  from stan/src/stan/model/model_header.hpp:4,
    ##                  from C:/Users/vepopo/AppData/Local/Temp/RtmpWAWXXt/model-73a4775c459f.hpp:2:
    ## stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp: In function 'stan::return_type_t<T_x, T_sigma, T_l> stan::math::von_mises_cdf(const T_x&, const T_mu&, const T_k&)':
    ## stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: '-Wmisleading-indentation' is disabled from this point onwards, since column-tracking was disabled due to the size of the code/headers
    ##   194 |       if (cdf_n < 0.0)
    ##       |

    ## stan/lib/stan_math/stan/math/prim/prob/von_mises_cdf.hpp:194: note: adding '-flarge-source-files' will allow for more column-tracking support, at the expense of compilation time and memory

    ## Initial Warmup (Typical Set)

    ## Chkpt: 1 / 4; Iteration: 250 / 1000 (warmup)
    ## Chkpt: 2 / 4; Iteration: 500 / 1000 (warmup)
    ## Chkpt: 3 / 4; Iteration: 750 / 1000 (sample)

    ## Stopping after 3 checkpoints

``` r
fit$IMMabc <- fit_model(formula, data, model,
                        parallel = TRUE,
                        chains = 4,
                        iter = 1000,
                        refresh = 500,
                        init = 1,
                        silent = 2,
                        backend = 'cmdstanr',
                        seed = seed, 
                        checkpoint_every = 250,
                        checkpoints_folder = path)
```

    ## Chkpt: 4 / 4; Iteration: 1000 / 1000 (sample)

    ## Checkpointing complete

``` r
reset_checkpoints(path)
```

</details>

</br>

<details>
<summary>
Results
</summary>

``` r
summary(fit$IMMabc)
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          mu1 ~ 1
    ##          kappa ~ 0 + SetSize
    ##          a ~ 0 + SetSize
    ##          c ~ 0 + SetSize
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ c + a
    ##          kappa1 ~ kappa
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (a) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (a) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (a) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: data (Number of observations: 4000) 
    ##   Draws: 2 chains, each with iter = 250; warmup = 0; thin = 1;
    ##          total post-warmup draws = 500
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## kappa_SetSize1       3.07      0.05     2.97     3.16 1.00     1328      698
    ## kappa_SetSize2       2.45      0.05     2.35     2.55 1.01     1378      762
    ## kappa_SetSize3       2.14      0.06     2.01     2.27 1.00     1878      677
    ## kappa_SetSize4       2.01      0.09     1.83     2.19 1.00     1052      731
    ## c_SetSize1           3.94      0.27     3.45     4.45 1.00      794      582
    ## c_SetSize2           3.36      0.22     2.97     3.81 1.00     1196      744
    ## c_SetSize3           2.84      0.17     2.53     3.20 1.00     1018      611
    ## c_SetSize4           2.70      0.17     2.37     3.04 1.00     1023      684
    ## a_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## a_SetSize2          -0.43      0.31    -1.05     0.19 1.01      965      752
    ## a_SetSize3          -0.91      0.27    -1.48    -0.40 1.00     1023      680
    ## a_SetSize4          -1.66      0.24    -2.14    -1.20 1.00     1010      602
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

<details>
<summary>
Compare with reference fit:
</summary>

``` r
ref_fits$IMMabc
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          a ~ 0 + SetSize
    ##          c ~ 0 + SetSize
    ##          kappa ~ 0 + SetSize
    ##          mu1 ~ 1
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ c + a
    ##          kappa1 ~ kappa
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (a) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (a) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (a) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 1000; warmup = 500; thin = 1;
    ##          total post-warmup draws = 2000
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## c_SetSize1           3.94      0.28     3.42     4.53 1.00     3001     1477
    ## c_SetSize2           3.36      0.22     2.96     3.79 1.00     1847     1675
    ## c_SetSize3           2.84      0.17     2.54     3.20 1.00     1908     1589
    ## c_SetSize4           2.70      0.18     2.37     3.07 1.00     2112     1143
    ## kappa_SetSize1       3.07      0.05     2.97     3.16 1.00     3163     1405
    ## kappa_SetSize2       2.45      0.05     2.35     2.55 1.00     3603     1519
    ## kappa_SetSize3       2.14      0.06     2.02     2.26 1.00     2141     1506
    ## kappa_SetSize4       2.01      0.09     1.82     2.18 1.00     3189     1682
    ## a_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## a_SetSize2          -0.43      0.31    -1.04     0.18 1.00     1925     1627
    ## a_SetSize3          -0.91      0.27    -1.43    -0.41 1.00     1802     1650
    ## a_SetSize4          -1.65      0.26    -2.15    -1.17 1.00     1936     1543
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

Difference in estimates

``` r
withr::local_options(list(digits=3))
fit_rows <- rownames(fixef(fit$IMMabc))
round(fixef(fit$IMMabc) - fixef(ref_fits$IMMabc)[fit_rows,],3)
```

    ##                  Estimate Est.Error   Q2.5  Q97.5
    ## mu1_Intercept       0.000     0.000  0.000  0.000
    ## mu5_Intercept       0.000     0.000  0.000  0.000
    ## kappa5_Intercept    0.000     0.000  0.000  0.000
    ## kappa_SetSize1      0.001     0.002 -0.008  0.002
    ## kappa_SetSize2      0.000    -0.002  0.001 -0.005
    ## kappa_SetSize3      0.000     0.003 -0.005  0.011
    ## kappa_SetSize4      0.007    -0.001  0.009  0.003
    ## c_SetSize1          0.006    -0.006  0.025 -0.079
    ## c_SetSize2          0.000     0.002  0.012  0.018
    ## c_SetSize3         -0.001     0.001 -0.008 -0.002
    ## c_SetSize4          0.001    -0.009 -0.001 -0.039
    ## a_SetSize1          0.000     0.000  0.000  0.000
    ## a_SetSize2          0.008    -0.002 -0.009  0.013
    ## a_SetSize3          0.002     0.001 -0.048  0.007
    ## a_SetSize4         -0.006    -0.017  0.013 -0.032
