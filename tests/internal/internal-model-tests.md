Internal model tests
================
2024-02-14

``` r
# load current version of the package on whichever branch you are on
devtools::load_all(".")
library(dplyr)
library(brms)

# this allows you to avoid recompiling stan models if the code doesn't change
cmdstanr_output_dir <- here::here("tests/internal/cmdstanr_output")
if (!dir.exists(cmdstanr_output_dir)) {
  dir.create(cmdstanr_output_dir)
}
options(cmdstanr_write_stan_file_dir = cmdstanr_output_dir)
```

## Introduction

This document contains code snippets for internal model tests. Since
official unit tests via testthat would take too long for actual models
to run every time, we use a mock backend to make sure that the models
are correctly specified and that the fit_model() function works as
expected, except for the actual sampling part.

Using this document, we can run the actual models and make sure they
return the expected results even after changes to the code. The basic
idea is that we have run and stored the model results at a point at
which everything was working as expected. We can then compare the
results of the models to the stored results. Passing a seed to the
fit_model() function ensures that the results are reproducible.
Differences might arise from changes in the underlying packages (brms,
rstan, cmdstanr) or from changes to the model specifications. In which
case we would have to make sure that the results are similar, even if
not identical, and update the stored results.

- \[\] TODO: for now it’s visual inspection. Maybe add explicit test
  with a threshold for estimation differences in a testthat test that is
  run manually only, or on a server.

### Reference fits source

The reference fits are stored in the `tests/internal/ref_fits`
directory. They were generated by the script
`tests/internal/generate_ref_model_fits.R`.

### Important

Set cache to true if you’ve done all the fits interactively and you want
to knit the document without refitting for new tests. Set cache to false
before you start. The whole file currently takes about 20 minutes to run
for all seven models total.

- note1: actually turns out the cache doesn’t transfer between
  interactive mode and knitting the whole document. It is still use to
  keep it set to TRUE, if you just want to add another comparison, then
  knit the whole document without refitting everything else
- note2: I can potentially change the caching to be based on this
  approach instead, which should work both interactively and knittingly
  (is that a word?):
  <https://bookdown.org/yihui/rmarkdown-cookbook/cache-rds.html#cache-rds>

``` r
knitr::opts_chunk$set(cache=TRUE)
```

### Load reference model fits

``` r
# TODO: for the future releases, save full information about the bmm model components in the reference fits
# also save information about operating system, but only for testing, not for general usage

# choose id for the reference fits if multiple exist
version <- "v0.2.1"
seed <- 365
date <- "20240215"

# filter by id
ref_dir <- here::here('tests/internal/ref_fits')
ref_files <- list.files(ref_dir, full.names = TRUE)
chosen_files <- grepl(version, ref_files) & grepl(date, ref_files) & grepl(paste0("seed-",seed), ref_files)
ref_files <- ref_files[chosen_files]

# load reference fits
ref_fits <- lapply(ref_files, readRDS)

# get only the model label from the file name, which is between version_ and _seed, 
ref_labels <- gsub(paste0(".*", version, "_"), "", ref_files)
ref_labels <- gsub("_seed-.*", "", ref_labels)

if (length(unique(ref_labels)) != length(ref_labels)) {
  stop("There are multiple reference fits with the same label. Choose which files to keep manually")
}

names(ref_fits) <- ref_labels
```

prepare a list to hold data the fits

``` r
fit <- list()
```

## Test: sdmSimple

*Note: In the future if the API doesn’t change, we can just use
arguments from the reference fit. For now it doesn’t work since the
formula and model definition have changed since version 0.2.1.*

<details>
<summary>
Run the model
</summary>

``` r
data <- ref_fits$sdmSimple$data

formula <- bmf(c ~ 0 + SetSize,
               kappa ~ 1)

model <- sdmSimple('dev_rad')

fit$sdmSimple <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 2000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed)
```

</details>
</br>
<details>
<summary>
The results:
</summary>

``` r
summary(fit$sdmSimple)
```

    ##  Family: sdm_simple 
    ##   Links: mu = identity; c = log; kappa = log 
    ## Formula: dev_rad ~ 1 
    ##          mu ~ 1
    ##          c ~ 0 + SetSize
    ##          kappa ~ 1
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
    ##          total post-warmup draws = 4000
    ## 
    ## Regression Coefficients:
    ##                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## Intercept           0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa_Intercept     1.26      0.04     1.18     1.35 1.00     1076     1484
    ## c_SetSize1          2.30      0.06     2.20     2.41 1.00     1218     1789
    ## c_SetSize2          1.85      0.04     1.77     1.93 1.00     1292     1987
    ## c_SetSize3          1.54      0.04     1.47     1.62 1.00     1357     2056
    ## c_SetSize4          1.29      0.04     1.22     1.37 1.00     1669     2258
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

<details>
<summary>
Compare with the reference fit:
</summary>

``` r
summary(ref_fits$sdmSimple)
```

    ##  Family: sdm_simple 
    ##   Links: mu = identity; c = log; kappa = log 
    ## Formula: dev_rad ~ 1 
    ##          c ~ 0 + SetSize
    ##          kappa ~ 1
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
    ##          total post-warmup draws = 4000
    ## 
    ## Regression Coefficients:
    ##                 Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## Intercept           0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa_Intercept     1.26      0.04     1.18     1.35 1.00     1017     1395
    ## c_SetSize1          2.30      0.05     2.20     2.41 1.00     1267     1410
    ## c_SetSize2          1.85      0.04     1.77     1.94 1.00     1216     1342
    ## c_SetSize3          1.54      0.04     1.47     1.62 1.00     1387     1561
    ## c_SetSize4          1.29      0.04     1.22     1.37 1.00     1488     1991
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

Difference in estimates:

``` r
fixef(fit$sdmSimple) - fixef(ref_fits$sdmSimple)
```

    ##                      Estimate     Est.Error        Q2.5       Q97.5
    ## Intercept        0.0000000000  0.0000000000  0.00000000  0.00000000
    ## kappa_Intercept -0.0011943400  0.0009060827  0.00061200  0.00244900
    ## c_SetSize1       0.0018565800  0.0010194898 -0.00349875 -0.00061975
    ## c_SetSize2       0.0006824325 -0.0002379245 -0.00131250 -0.00239125
    ## c_SetSize3       0.0006572800 -0.0004630703  0.00246775 -0.00316100
    ## c_SetSize4       0.0004549325  0.0001734408 -0.00000050 -0.00077800

## Test: mixture3p

<details>
<summary>
Run the model
</summary>

``` r
data <- ref_fits$mixture3p$data

formula <- bmf(thetat ~ 0 + SetSize,
               thetant ~ 0 + SetSize,
               kappa ~ 0 + SetSize)

model <- mixture3p(resp_error = 'dev_rad',
                   nt_features = paste0("Item", 2:4,"_Col_rad"),
                   set_size = "SetSize")

fit$mixture3p <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 1000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed)
```

</details>

</br>

<details>
<summary>
Results
</summary>

``` r
summary(fit$mixture3p)
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          mu1 ~ 1
    ##          kappa ~ 0 + SetSize
    ##          thetat ~ 0 + SetSize
    ##          thetant ~ 0 + SetSize
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ thetat
    ##          kappa1 ~ kappa
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (thetant + log(inv_ss)) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (thetant + log(inv_ss)) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (thetant + log(inv_ss)) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 1000; warmup = 500; thin = 1;
    ##          total post-warmup draws = 2000
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## kappa_SetSize1       3.06      0.05     2.96     3.16 1.00     1892     1274
    ## kappa_SetSize2       2.45      0.05     2.35     2.56 1.00     2080     1483
    ## kappa_SetSize3       2.15      0.07     2.02     2.28 1.00     1947     1447
    ## kappa_SetSize4       2.02      0.09     1.84     2.21 1.00     2047     1624
    ## thetat_SetSize1      4.23      0.33     3.64     4.93 1.00     1754      890
    ## thetat_SetSize2      2.85      0.19     2.49     3.23 1.01     1840     1498
    ## thetat_SetSize3      1.85      0.16     1.56     2.20 1.00     1578     1603
    ## thetat_SetSize4      0.96      0.14     0.71     1.25 1.00     1628     1150
    ## thetant_SetSize1  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## thetant_SetSize2    -0.80      0.38    -1.60    -0.10 1.00     1847     1408
    ## thetant_SetSize3    -0.44      0.30    -1.05     0.16 1.00     1590     1378
    ## thetant_SetSize4    -0.83      0.31    -1.49    -0.27 1.00     1432     1195
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

<details>
<summary>
Compare with reference fit:
</summary>

``` r
ref_fits$mixture3p
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          thetat ~ 0 + SetSize
    ##          thetant ~ 0 + SetSize
    ##          kappa ~ 0 + SetSize
    ##          mu1 ~ 1
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ thetat
    ##          kappa1 ~ kappa
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (thetant + log(inv_ss)) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (thetant + log(inv_ss)) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (thetant + log(inv_ss)) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 1000; warmup = 500; thin = 1;
    ##          total post-warmup draws = 2000
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## thetat_SetSize1      4.21      0.32     3.65     4.91 1.00     2177     1474
    ## thetat_SetSize2      2.85      0.20     2.48     3.24 1.00     1854     1524
    ## thetat_SetSize3      1.85      0.16     1.54     2.19 1.00     1609     1537
    ## thetat_SetSize4      0.96      0.14     0.71     1.26 1.00     1625     1318
    ## kappa_SetSize1       3.06      0.05     2.97     3.15 1.00     2611     1558
    ## kappa_SetSize2       2.45      0.05     2.35     2.56 1.00     2198     1398
    ## kappa_SetSize3       2.14      0.07     2.01     2.27 1.00     2113     1630
    ## kappa_SetSize4       2.02      0.10     1.83     2.21 1.00     2136     1536
    ## thetant_SetSize1  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## thetant_SetSize2    -0.82      0.42    -1.76    -0.11 1.01     1792     1428
    ## thetant_SetSize3    -0.44      0.29    -1.02     0.14 1.00     1634     1530
    ## thetant_SetSize4    -0.83      0.30    -1.48    -0.28 1.00     1592     1490
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

Difference in estimates

``` r
withr::local_options(list(digits=3))
fit_rows <- rownames(fixef(fit$mixture3p))
round(fixef(fit$mixture3p) - fixef(ref_fits$mixture3p)[fit_rows,],3)
```

    ##                  Estimate Est.Error   Q2.5  Q97.5
    ## mu1_Intercept       0.000     0.000  0.000  0.000
    ## mu5_Intercept       0.000     0.000  0.000  0.000
    ## kappa5_Intercept    0.000     0.000  0.000  0.000
    ## kappa_SetSize1      0.000     0.002 -0.007  0.005
    ## kappa_SetSize2      0.000    -0.001  0.001  0.000
    ## kappa_SetSize3      0.001     0.000  0.007  0.009
    ## kappa_SetSize4     -0.003    -0.003  0.003 -0.004
    ## thetat_SetSize1     0.018     0.015 -0.014  0.019
    ## thetat_SetSize2     0.002    -0.005  0.011 -0.011
    ## thetat_SetSize3    -0.004     0.003  0.012  0.012
    ## thetat_SetSize4     0.001     0.001 -0.002 -0.006
    ## thetant_SetSize1    0.000     0.000  0.000  0.000
    ## thetant_SetSize2    0.016    -0.040  0.161  0.006
    ## thetant_SetSize3   -0.008     0.006 -0.029  0.022
    ## thetant_SetSize4    0.000     0.008 -0.017  0.004

## Test: mixture2p

<details>
<summary>
Run the model
</summary>

``` r
data <- ref_fits$mixture2p$data

formula <- bmf(thetat ~ 0 + SetSize,
               kappa ~ 0 + SetSize)

model <- mixture2p(resp_error = 'dev_rad')

fit$mixture2p <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 2000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed)
```

</details>

</br>

<details>
<summary>
Results
</summary>

``` r
summary(fit$mixture2p)
```

    ##  Family: mixture(von_mises, von_mises) 
    ##   Links: mu1 = tan_half; kappa1 = log; mu2 = tan_half; kappa2 = log; theta1 = identity; theta2 = identity 
    ## Formula: dev_rad ~ 1 
    ##          mu1 ~ 1
    ##          kappa ~ 0 + SetSize
    ##          thetat ~ 0 + SetSize
    ##          kappa2 ~ 1
    ##          mu2 ~ 1
    ##          kappa1 ~ kappa
    ##          theta1 ~ thetat
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;
    ##          total post-warmup draws = 4000
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu2_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa2_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## kappa_SetSize1       3.06      0.05     2.96     3.15 1.00     5739     3104
    ## kappa_SetSize2       2.45      0.05     2.35     2.56 1.00     6994     3252
    ## kappa_SetSize3       2.17      0.07     2.03     2.30 1.00     6299     3456
    ## kappa_SetSize4       2.03      0.10     1.85     2.23 1.00     5749     3140
    ## thetat_SetSize1      4.22      0.33     3.62     4.95 1.00     5300     2643
    ## thetat_SetSize2      2.46      0.15     2.17     2.76 1.00     6423     3404
    ## thetat_SetSize3      1.33      0.10     1.13     1.53 1.00     6433     3588
    ## thetat_SetSize4      0.61      0.10     0.42     0.80 1.00     6510     3625
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

<details>
<summary>
Compare with the reference fit:
</summary>

``` r
summary(ref_fits$mixture2p)
```

    ##  Family: mixture(von_mises, von_mises) 
    ##   Links: mu1 = tan_half; kappa1 = log; mu2 = tan_half; kappa2 = log; theta1 = identity; theta2 = identity 
    ## Formula: dev_rad ~ 1 
    ##          thetat ~ 0 + SetSize
    ##          kappa ~ 0 + SetSize
    ##          kappa2 ~ 1
    ##          mu1 ~ 1
    ##          mu2 ~ 1
    ##          kappa1 ~ kappa
    ##          theta1 ~ thetat
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 1000; warmup = 500; thin = 1;
    ##          total post-warmup draws = 2000
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu2_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa2_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## thetat_SetSize1      4.21      0.32     3.64     4.90 1.00     3266     1515
    ## thetat_SetSize2      2.46      0.14     2.18     2.75 1.00     2928     1439
    ## thetat_SetSize3      1.34      0.11     1.12     1.55 1.00     3161     1476
    ## thetat_SetSize4      0.61      0.10     0.42     0.80 1.00     2783     1650
    ## kappa_SetSize1       3.06      0.05     2.96     3.16 1.00     3243     1208
    ## kappa_SetSize2       2.46      0.05     2.35     2.55 1.00     2784     1845
    ## kappa_SetSize3       2.17      0.07     2.03     2.31 1.00     2693     1443
    ## kappa_SetSize4       2.04      0.10     1.85     2.23 1.00     2857     1462
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

Difference in estimates

``` r
withr::local_options(list(digits=3))
fit_rows <- rownames(fixef(fit$mixture2p))
round(fixef(fit$mixture2p) - fixef(ref_fits$mixture2p)[fit_rows,],3)
```

    ##                  Estimate Est.Error   Q2.5  Q97.5
    ## mu1_Intercept       0.000     0.000  0.000  0.000
    ## mu2_Intercept       0.000     0.000  0.000  0.000
    ## kappa2_Intercept    0.000     0.000  0.000  0.000
    ## kappa_SetSize1      0.001    -0.002  0.003 -0.003
    ## kappa_SetSize2     -0.001     0.001 -0.003  0.003
    ## kappa_SetSize3     -0.001    -0.003  0.000 -0.007
    ## kappa_SetSize4     -0.003     0.000 -0.001  0.000
    ## thetat_SetSize1     0.003     0.017 -0.024  0.045
    ## thetat_SetSize2     0.004     0.005 -0.012  0.010
    ## thetat_SetSize3    -0.005    -0.005  0.008 -0.012
    ## thetat_SetSize4     0.002     0.000  0.004  0.005

## Test: IMMfull

<details>
<summary>
Run the model
</summary>

``` r
data <- ref_fits$IMMfull$data

formula <- bmf(a ~ 0 + SetSize,
               c ~ 0 + SetSize,
               s ~ 0 + SetSize,
               kappa ~ 0 + SetSize)

model <- IMMfull(resp_error = 'dev_rad',
                 nt_features = paste0("Item", 2:4,"_Col_rad"),
                 nt_distances = paste0("Item", 2:4,"_Pos_rad"),
                 set_size = "SetSize")

fit$IMMfull <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 1000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed)
```

</details>

</br>

<details>
<summary>
Results
</summary>

``` r
summary(fit$IMMfull)
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          mu1 ~ 1
    ##          kappa ~ 0 + SetSize
    ##          a ~ 0 + SetSize
    ##          c ~ 0 + SetSize
    ##          s ~ 0 + SetSize
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ c + a
    ##          kappa1 ~ kappa
    ##          expS ~ exp(s)
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (exp(-expS * Item2_Pos_rad) * c + a) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (exp(-expS * Item3_Pos_rad) * c + a) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (exp(-expS * Item4_Pos_rad) * c + a) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 1000; warmup = 500; thin = 1;
    ##          total post-warmup draws = 2000
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## kappa_SetSize1       3.07      0.05     2.97     3.17 1.01     2900     1108
    ## kappa_SetSize2       2.45      0.05     2.34     2.55 1.01     2749     1384
    ## kappa_SetSize3       2.14      0.07     2.01     2.27 1.01     3655     1451
    ## kappa_SetSize4       2.00      0.10     1.80     2.20 1.00     3606     1336
    ## c_SetSize1           3.94      0.27     3.45     4.49 1.00     3252     1464
    ## c_SetSize2           3.44      0.25     2.99     3.96 1.00     1525     1628
    ## c_SetSize3           2.92      0.18     2.59     3.32 1.00     1930     1283
    ## c_SetSize4           2.76      0.19     2.40     3.16 1.00     1882     1368
    ## a_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## a_SetSize2          -0.50      0.34    -1.18     0.12 1.00     1829     1470
    ## a_SetSize3          -0.99      0.28    -1.52    -0.46 1.00     1835     1202
    ## a_SetSize4          -1.71      0.27    -2.26    -1.19 1.00     1768     1387
    ## s_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## s_SetSize2           1.75      0.49     0.94     2.86 1.00     2554     1394
    ## s_SetSize3           1.61      0.53     0.82     2.85 1.00     1653      818
    ## s_SetSize4           1.73      0.47     0.97     2.79 1.00     2704     1468
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

<details>
<summary>
Compare with reference fit:
</summary>

``` r
ref_fits$IMMfull
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          a ~ 0 + SetSize
    ##          c ~ 0 + SetSize
    ##          s ~ 0 + SetSize
    ##          kappa ~ 0 + SetSize
    ##          mu1 ~ 1
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ c + a
    ##          kappa1 ~ kappa
    ##          expS ~ exp(s)
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (exp(-expS * Item2_Pos_rad) * c + a) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (exp(-expS * Item3_Pos_rad) * c + a) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (exp(-expS * Item4_Pos_rad) * c + a) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 1000; warmup = 500; thin = 1;
    ##          total post-warmup draws = 2000
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## c_SetSize1           3.94      0.27     3.44     4.49 1.00     2739     1614
    ## c_SetSize2           3.44      0.25     3.02     3.96 1.00     1904     1095
    ## c_SetSize3           2.92      0.19     2.57     3.34 1.00     1524     1060
    ## c_SetSize4           2.76      0.20     2.40     3.20 1.00     1712     1107
    ## kappa_SetSize1       3.07      0.05     2.98     3.16 1.00     3543     1526
    ## kappa_SetSize2       2.45      0.05     2.33     2.55 1.00     3452     1142
    ## kappa_SetSize3       2.14      0.06     2.01     2.27 1.00     4016     1292
    ## kappa_SetSize4       2.00      0.10     1.81     2.19 1.00     2968     1315
    ## a_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## a_SetSize2          -0.50      0.33    -1.17     0.16 1.00     1836     1284
    ## a_SetSize3          -0.99      0.29    -1.56    -0.42 1.00     1561     1203
    ## a_SetSize4          -1.71      0.28    -2.29    -1.19 1.00     1758      958
    ## s_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## s_SetSize2           1.74      0.50     0.94     2.94 1.00     2442     1341
    ## s_SetSize3           1.60      0.50     0.80     2.75 1.00     1712     1164
    ## s_SetSize4           1.73      0.48     1.00     2.87 1.00     2043     1091
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

Difference in estimates

``` r
withr::local_options(list(digits=3))
fit_rows <- rownames(fixef(fit$IMMfull))
round(fixef(fit$IMMfull) - fixef(ref_fits$IMMfull)[fit_rows,],3)
```

    ##                  Estimate Est.Error   Q2.5  Q97.5
    ## mu1_Intercept       0.000     0.000  0.000  0.000
    ## mu5_Intercept       0.000     0.000  0.000  0.000
    ## kappa5_Intercept    0.000     0.000  0.000  0.000
    ## kappa_SetSize1      0.000     0.003 -0.008  0.004
    ## kappa_SetSize2     -0.001    -0.002  0.008 -0.008
    ## kappa_SetSize3      0.002     0.004  0.000  0.002
    ## kappa_SetSize4      0.000     0.005 -0.011  0.016
    ## c_SetSize1         -0.005    -0.001  0.008 -0.006
    ## c_SetSize2          0.002     0.002 -0.028 -0.006
    ## c_SetSize3         -0.002    -0.009  0.021 -0.020
    ## c_SetSize4          0.000    -0.001 -0.001 -0.037
    ## a_SetSize1          0.000     0.000  0.000  0.000
    ## a_SetSize2         -0.003     0.004 -0.009 -0.037
    ## a_SetSize3         -0.001    -0.010  0.041 -0.035
    ## a_SetSize4          0.002    -0.006  0.026 -0.005
    ## s_SetSize1          0.000     0.000  0.000  0.000
    ## s_SetSize2          0.006    -0.011 -0.006 -0.078
    ## s_SetSize3          0.013     0.024  0.015  0.105
    ## s_SetSize4          0.001    -0.005 -0.024 -0.080

## Test: IMMbsc

<details>
<summary>
Run the model
</summary>

``` r
data <- ref_fits$IMMbsc$data

formula <- bmf(c ~ 0 + SetSize,
               s ~ 0 + SetSize,
               kappa ~ 0 + SetSize)

model <- IMMbsc(resp_error = 'dev_rad',
                nt_features = paste0("Item", 2:4,"_Col_rad"),
                nt_distances = paste0("Item", 2:4,"_Pos_rad"),
                set_size = "SetSize")

fit$IMMbsc <- fit_model(formula, data, model,
                        parallel = TRUE,
                        chains = 4,
                        iter = 1000,
                        refresh = 500,
                        init = 1,
                        silent = 2,
                        backend = 'cmdstanr',
                        seed = seed)
```

</details>

</br>

<details>
<summary>
Results
</summary>

``` r
summary(fit$IMMbsc)
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          mu1 ~ 1
    ##          kappa ~ 0 + SetSize
    ##          c ~ 0 + SetSize
    ##          s ~ 0 + SetSize
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ c
    ##          kappa1 ~ kappa
    ##          expS ~ exp(s)
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (exp(-expS * Item2_Pos_rad) * c) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (exp(-expS * Item3_Pos_rad) * c) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (exp(-expS * Item4_Pos_rad) * c) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 1000; warmup = 500; thin = 1;
    ##          total post-warmup draws = 2000
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## kappa_SetSize1       3.07      0.05     2.97     3.16 1.00     2992     1422
    ## kappa_SetSize2       2.43      0.05     2.33     2.53 1.00     3478     1469
    ## kappa_SetSize3       2.06      0.06     1.95     2.18 1.00     2758     1586
    ## kappa_SetSize4       1.64      0.08     1.48     1.80 1.00     2251     1593
    ## c_SetSize1           3.95      0.26     3.47     4.50 1.00     3171     1644
    ## c_SetSize2           3.17      0.14     2.90     3.46 1.00     3278     1595
    ## c_SetSize3           2.52      0.11     2.32     2.73 1.00     2935     1439
    ## c_SetSize4           2.20      0.10     2.01     2.41 1.00     2247     1365
    ## s_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## s_SetSize2           1.86      0.49     1.09     3.03 1.00     2675     1303
    ## s_SetSize3           1.86      0.46     1.12     2.93 1.00     2268     1148
    ## s_SetSize4           1.93      0.44     1.22     2.93 1.01     2539     1278
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

<details>
<summary>
Compare with reference fit:
</summary>

``` r
ref_fits$IMMbsc
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          c ~ 0 + SetSize
    ##          s ~ 0 + SetSize
    ##          kappa ~ 0 + SetSize
    ##          mu1 ~ 1
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ c
    ##          kappa1 ~ kappa
    ##          expS ~ exp(s)
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (exp(-expS * Item2_Pos_rad) * c) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (exp(-expS * Item3_Pos_rad) * c) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (exp(-expS * Item4_Pos_rad) * c) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 1000; warmup = 500; thin = 1;
    ##          total post-warmup draws = 2000
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## c_SetSize1           3.94      0.27     3.43     4.50 1.00     2776     1632
    ## c_SetSize2           3.17      0.15     2.90     3.47 1.00     3383     1407
    ## c_SetSize3           2.52      0.11     2.31     2.74 1.00     3596     1815
    ## c_SetSize4           2.20      0.11     2.00     2.42 1.00     2357     1411
    ## kappa_SetSize1       3.07      0.05     2.98     3.16 1.00     2849     1547
    ## kappa_SetSize2       2.43      0.05     2.33     2.54 1.00     3086     1428
    ## kappa_SetSize3       2.07      0.06     1.95     2.18 1.00     3388     1774
    ## kappa_SetSize4       1.64      0.09     1.47     1.81 1.00     2641     1628
    ## s_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## s_SetSize2           1.86      0.45     1.14     2.96 1.00     2541     1475
    ## s_SetSize3           1.86      0.48     1.11     2.98 1.00     1914     1161
    ## s_SetSize4           1.92      0.46     1.22     2.95 1.00     2369     1278
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

Difference in estimates

``` r
withr::local_options(list(digits=3))
fit_rows <- rownames(fixef(fit$IMMbsc))
round(fixef(fit$IMMbsc) - fixef(ref_fits$IMMbsc)[fit_rows,],3)
```

    ##                  Estimate Est.Error   Q2.5  Q97.5
    ## mu1_Intercept       0.000     0.000  0.000  0.000
    ## mu5_Intercept       0.000     0.000  0.000  0.000
    ## kappa5_Intercept    0.000     0.000  0.000  0.000
    ## kappa_SetSize1     -0.001     0.001 -0.006  0.003
    ## kappa_SetSize2      0.002    -0.001  0.005 -0.005
    ## kappa_SetSize3     -0.002     0.004 -0.003  0.006
    ## kappa_SetSize4     -0.003    -0.005  0.013 -0.018
    ## c_SetSize1          0.006    -0.012  0.040 -0.004
    ## c_SetSize2          0.001    -0.002  0.004 -0.011
    ## c_SetSize3          0.000     0.001  0.005 -0.003
    ## c_SetSize4          0.002    -0.006  0.010 -0.004
    ## s_SetSize1          0.000     0.000  0.000  0.000
    ## s_SetSize2          0.001     0.035 -0.056  0.067
    ## s_SetSize3         -0.009    -0.020  0.014 -0.048
    ## s_SetSize4          0.003    -0.016 -0.009 -0.024

## Test: IMMabc

<details>
<summary>
Run the model
</summary>

``` r
data <- ref_fits$IMMabc$data

formula <- bmf(a ~ 0 + SetSize,
               c ~ 0 + SetSize,
               kappa ~ 0 + SetSize)

model <- IMMabc(resp_error = 'dev_rad',
                nt_features = paste0("Item", 2:4,"_Col_rad"),
                set_size = "SetSize")

fit$IMMabc <- fit_model(formula, data, model,
                        parallel = TRUE,
                        chains = 4,
                        iter = 1000,
                        refresh = 500,
                        init = 1,
                        silent = 2,
                        backend = 'cmdstanr',
                        seed = seed)
```

</details>

</br>

<details>
<summary>
Results
</summary>

``` r
summary(fit$IMMabc)
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          mu1 ~ 1
    ##          kappa ~ 0 + SetSize
    ##          a ~ 0 + SetSize
    ##          c ~ 0 + SetSize
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ c + a
    ##          kappa1 ~ kappa
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (a) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (a) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (a) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 1000; warmup = 500; thin = 1;
    ##          total post-warmup draws = 2000
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## kappa_SetSize1       3.07      0.05     2.97     3.17 1.00     2870     1301
    ## kappa_SetSize2       2.45      0.05     2.34     2.55 1.00     3534     1375
    ## kappa_SetSize3       2.14      0.07     2.02     2.27 1.00     3261     1515
    ## kappa_SetSize4       2.01      0.10     1.81     2.19 1.00     3529     1411
    ## c_SetSize1           3.94      0.28     3.44     4.52 1.01     3142     1239
    ## c_SetSize2           3.38      0.23     2.95     3.86 1.00     1710     1318
    ## c_SetSize3           2.84      0.17     2.54     3.20 1.00     2234     1264
    ## c_SetSize4           2.70      0.18     2.39     3.09 1.01     1704     1176
    ## a_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## a_SetSize2          -0.45      0.33    -1.11     0.19 1.00     1692     1452
    ## a_SetSize3          -0.92      0.26    -1.44    -0.40 1.00     2418     1452
    ## a_SetSize4          -1.66      0.26    -2.20    -1.18 1.00     1900     1196
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

<details>
<summary>
Compare with reference fit:
</summary>

``` r
ref_fits$IMMabc
```

    ##  Family: mixture(von_mises, von_mises, von_mises, von_mises, von_mises) 
    ##   Links: mu1 = identity; kappa1 = log; mu2 = identity; kappa2 = log; mu3 = identity; kappa3 = log; mu4 = identity; kappa4 = log; mu5 = identity; kappa5 = log; theta1 = identity; theta2 = identity; theta3 = identity; theta4 = identity; theta5 = identity 
    ## Formula: dev_rad ~ 1 
    ##          a ~ 0 + SetSize
    ##          c ~ 0 + SetSize
    ##          kappa ~ 0 + SetSize
    ##          mu1 ~ 1
    ##          kappa5 ~ 1
    ##          mu5 ~ 1
    ##          theta1 ~ c + a
    ##          kappa1 ~ kappa
    ##          kappa2 ~ kappa
    ##          theta2 ~ LureIdx1 * (a) + (1 - LureIdx1) * (-100)
    ##          mu2 ~ Item2_Col_rad
    ##          kappa3 ~ kappa
    ##          theta3 ~ LureIdx2 * (a) + (1 - LureIdx2) * (-100)
    ##          mu3 ~ Item3_Col_rad
    ##          kappa4 ~ kappa
    ##          theta4 ~ LureIdx3 * (a) + (1 - LureIdx3) * (-100)
    ##          mu4 ~ Item4_Col_rad
    ##    Data: .x2 (Number of observations: 4000) 
    ##   Draws: 4 chains, each with iter = 1000; warmup = 500; thin = 1;
    ##          total post-warmup draws = 2000
    ## 
    ## Regression Coefficients:
    ##                  Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
    ## mu1_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## mu5_Intercept        0.00      0.00     0.00     0.00   NA       NA       NA
    ## kappa5_Intercept  -100.00      0.00  -100.00  -100.00   NA       NA       NA
    ## c_SetSize1           3.94      0.28     3.42     4.53 1.00     3001     1477
    ## c_SetSize2           3.36      0.22     2.96     3.79 1.00     1847     1675
    ## c_SetSize3           2.84      0.17     2.54     3.20 1.00     1908     1589
    ## c_SetSize4           2.70      0.18     2.37     3.07 1.00     2112     1143
    ## kappa_SetSize1       3.07      0.05     2.97     3.16 1.00     3163     1405
    ## kappa_SetSize2       2.45      0.05     2.35     2.55 1.00     3603     1519
    ## kappa_SetSize3       2.14      0.06     2.02     2.26 1.00     2141     1506
    ## kappa_SetSize4       2.01      0.09     1.82     2.18 1.00     3189     1682
    ## a_SetSize1           0.00      0.00     0.00     0.00   NA       NA       NA
    ## a_SetSize2          -0.43      0.31    -1.04     0.18 1.00     1925     1627
    ## a_SetSize3          -0.91      0.27    -1.43    -0.41 1.00     1802     1650
    ## a_SetSize4          -1.65      0.26    -2.15    -1.17 1.00     1936     1543
    ## 
    ## Draws were sampled using sample(hmc). For each parameter, Bulk_ESS
    ## and Tail_ESS are effective sample size measures, and Rhat is the potential
    ## scale reduction factor on split chains (at convergence, Rhat = 1).

</details>

</br>

Difference in estimates

``` r
withr::local_options(list(digits=3))
fit_rows <- rownames(fixef(fit$IMMabc))
round(fixef(fit$IMMabc) - fixef(ref_fits$IMMabc)[fit_rows,],3)
```

    ##                  Estimate Est.Error   Q2.5  Q97.5
    ## mu1_Intercept       0.000     0.000  0.000  0.000
    ## mu5_Intercept       0.000     0.000  0.000  0.000
    ## kappa5_Intercept    0.000     0.000  0.000  0.000
    ## kappa_SetSize1      0.001     0.000 -0.003  0.006
    ## kappa_SetSize2     -0.002    -0.001 -0.002 -0.007
    ## kappa_SetSize3      0.003     0.004 -0.002  0.005
    ## kappa_SetSize4      0.000     0.002 -0.010  0.011
    ## c_SetSize1          0.002    -0.002  0.017 -0.011
    ## c_SetSize2          0.020     0.020 -0.008  0.069
    ## c_SetSize3          0.004     0.001  0.001  0.006
    ## c_SetSize4          0.006     0.003  0.019  0.019
    ## a_SetSize1          0.000     0.000  0.000  0.000
    ## a_SetSize2         -0.013     0.020 -0.070  0.014
    ## a_SetSize3         -0.010    -0.003 -0.007  0.007
    ## a_SetSize4         -0.010     0.001 -0.044 -0.010
