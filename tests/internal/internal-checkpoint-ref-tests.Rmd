---
title: "Internal model tests"
output: github_document
date: "2024-02-14"
---

```{r setup, message=FALSE, warning=FALSE}
# load current version of the package on whichever branch you are on
devtools::load_all(".")
library(dplyr)
library(brms)
library(chkptstanr)

# this allows you to avoid recompiling stan models if the code doesn't change
# cmdstanr_output_dir <- here::here("tests/internal/cmdstanr_output")
# if (!dir.exists(cmdstanr_output_dir)) {
#   dir.create(cmdstanr_output_dir)
# }
# options(cmdstanr_write_stan_file_dir = cmdstanr_output_dir,
#         bmm.sort_data = TRUE)
options(bmm.sort_data = TRUE)

# checkpoint folder
basepath <- "tests/internal/checkpoints1/"
withr::defer({
  dirs <- list.files(here::here(basepath), full.names = TRUE)
  for (dir in dirs) {
    reset_checkpoints(path)
  }
})

```

## Introduction

(THIS TESTS SPECIFICALLY THE NEW CHECKPOINT FUNCTIONALITY)

This document contains code snippets for internal model tests. Since official unit tests via testthat would take too long for actual models to run every time, we use a mock backend to make sure that the models are correctly specified and that the fit_model() function works as expected, except for the actual sampling part.

Using this document, we can run the actual models and make sure they return the expected results even after changes to the code. The basic idea is that we have run and stored the model results at a point at which everything was working as expected. We can then compare the results of the models to the stored results. Passing a seed to the fit_model() function ensures that the results are reproducible. Differences might arise from changes in the underlying packages (brms, rstan, cmdstanr) or from changes to the model specifications. In which case we would have to make sure that the results are similar, even if not identical, and update the stored results.

- [] TODO: for now it's visual inspection. Maybe add explicit test with a threshold for estimation differences in a testthat test that is run manually only, or on a server.

### Reference fits source

The reference fits are stored in the `tests/internal/ref_fits` directory. They were generated by the script `tests/internal/generate_ref_model_fits.R`.

### Important

Set cache to true if you've done all the fits interactively and you want to knit the document without refitting for new tests. Set cache to false before you start. The whole file currently takes about 20 minutes to run for all seven models total.

```{r knitrcache}
knitr::opts_chunk$set(cache=TRUE)
```

- note1: actually turns out the cache doesn't transfer between interactive mode and knitting the whole document. It is still use to keep it set to TRUE, if you just want to add another comparison, then knit the whole document without refitting everything else
- note2: I can potentially change the caching to be based on this approach instead, which should work both interactively and knittingly (is that a word?): https://bookdown.org/yihui/rmarkdown-cookbook/cache-rds.html#cache-rds

### Load reference model fits

```{r load_refs}
# TODO: for the future releases, save full information about the bmm model components in the reference fits
# also save information about operating system, but only for testing, not for general usage

# choose id for the reference fits if multiple exist
version <- "v0.2.1"
seed <- 365
date <- "20240215"

# filter by id
ref_dir <- here::here('tests/internal/ref_fits')
ref_files <- list.files(ref_dir, full.names = TRUE)
chosen_files <- grepl(version, ref_files) & grepl(date, ref_files) & grepl(paste0("seed-",seed), ref_files)
ref_files <- ref_files[chosen_files]

# load reference fits
ref_fits <- lapply(ref_files, readRDS)

# get only the model label from the file name, which is between version_ and _seed, 
ref_labels <- gsub(paste0(".*", version, "_"), "", ref_files)
ref_labels <- gsub("_seed-.*", "", ref_labels)

if (length(unique(ref_labels)) != length(ref_labels)) {
  stop("There are multiple reference fits with the same label. Choose which files to keep manually")
}

names(ref_fits) <- ref_labels
```

prepare a list to hold data the fits

```{r fit_list}
fit <- list()
```

## Test: sdmSimple

*Note: In the future if the API doesn't change, we can just use arguments from the reference fit. For now it doesn't work since the formula and model definition have changed since version 0.2.1.*

<details>
  <summary>Run the model</summary>

```{r sdmSimple_fit}
path <- file_path2(here::here(), basepath, "sdmSimple")
data <- ref_fits$sdmSimple$data

formula <- bmf(c ~ 0 + SetSize,
               kappa ~ 1)

model <- sdmSimple('dev_rad')

# stop after 3 checkpoints
fit$sdmSimple.1 <- fit_model(formula, data, model,
                             parallel = TRUE,
                             chains = 4,
                             iter = 2000,
                             refresh = 500,
                             init = 1,
                             silent = 2,
                             backend = 'cmdstanr',
                             seed = seed, 
                             checkpoint_every = 250,
                             stop_after = 750,
                             checkpoints_folder = path)

# resume checkpoint
fit$sdmSimple <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 2000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed, 
                           checkpoint_every = 250,
                           checkpoints_folder = path)

reset_checkpoints(path)
```

</details>
</br>
<details>
  <summary>The results:</summary>

```{r sdmSimple_results}
summary(fit$sdmSimple)
```

</details>

</br>

<details>
  <summary>Compare with the reference fit:</summary>

```{r sdmSimple_ref_results}
summary(ref_fits$sdmSimple)
```

</details>

</br>

Difference in estimates:

```{r sdmSimple_diff}
fixef(fit$sdmSimple) - fixef(ref_fits$sdmSimple)
```

## Test: mixture3p

<details>
  <summary>Run the model</summary>

```{r mixture3p_fit}
path <- file_path2(here::here(), basepath, "mixture3p")
data <- ref_fits$mixture3p$data

formula <- bmf(thetat ~ 0 + SetSize,
               thetant ~ 0 + SetSize,
               kappa ~ 0 + SetSize)

model <- mixture3p(resp_err = 'dev_rad',
                   nt_features = paste0("Item", 2:4,"_Col_rad"),
                   setsize = "SetSize")

fit$mixture3p.1 <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 1000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed, 
                           checkpoint_every = 250,
                           stop_after = 750,
                           checkpoints_folder = path)

fit$mixture3p <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 1000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed, 
                           checkpoint_every = 250,
                           checkpoints_folder = path)
reset_checkpoints(path)
```


</details> </br>

<details>
  <summary>Results </summary>

```{r mixture3p_results}
summary(fit$mixture3p)
```


</details> </br>

<details>
  <summary>Compare with reference fit:</summary>

```{r ref_fits_mixture3p}
ref_fits$mixture3p
```


</details> </br>

Difference in estimates

```{r mixture3p_diff}
withr::local_options(list(digits=3))
fit_rows <- rownames(fixef(fit$mixture3p))
round(fixef(fit$mixture3p) - fixef(ref_fits$mixture3p)[fit_rows,],3)
```

## Test: mixture2p

<details>
  <summary>Run the model</summary>

```{r mixture2p_fit}
path <- file_path2(here::here(), basepath, "mixture2p")
data <- ref_fits$mixture2p$data

formula <- bmf(thetat ~ 0 + SetSize,
               kappa ~ 0 + SetSize)

model <- mixture2p(resp_err = 'dev_rad')

fit$mixture2p.1 <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 2000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed, 
                           checkpoint_every = 250,
                           stop_after = 750,
                           checkpoints_folder = path)

fit$mixture2p <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 2000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed, 
                           checkpoint_every = 250,
                           checkpoints_folder = path)
reset_checkpoints(path)
```


</details> </br>

<details>
  <summary>Results</summary>

```{r mixture2p_results}
summary(fit$mixture2p)
```


</details> </br>

<details>
  <summary>Compare with the reference fit:</summary>

```{r ref_fits_mixture2p}
summary(ref_fits$mixture2p)
```


</details> </br>

Difference in estimates

```{r}
withr::local_options(list(digits=3))
fit_rows <- rownames(fixef(fit$mixture2p))
round(fixef(fit$mixture2p) - fixef(ref_fits$mixture2p)[fit_rows,],3)
```


## Test: IMMfull

<details>
  <summary>Run the model</summary>



```{r IMMfull_fit}
path <- file_path2(here::here(), basepath, "IMMfull")
data <- ref_fits$IMMfull$data

formula <- bmf(a ~ 0 + SetSize,
               c ~ 0 + SetSize,
               s ~ 0 + SetSize,
               kappa ~ 0 + SetSize)

model <- IMMfull(resp_err = 'dev_rad',
                 nt_features = paste0("Item", 2:4,"_Col_rad"),
                 nt_distances = paste0("Item", 2:4,"_Pos_rad"),
                 setsize = "SetSize")

fit$IMMfull.1 <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 1000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed, 
                           checkpoint_every = 250,
                           stop_after = 750,
                           checkpoints_folder = path)
fit$IMMfull <- fit_model(formula, data, model,
                           parallel = TRUE,
                           chains = 4,
                           iter = 1000,
                           refresh = 500,
                           init = 1,
                           silent = 2,
                           backend = 'cmdstanr',
                           seed = seed, 
                           checkpoint_every = 250,
                           checkpoints_folder = path)
reset_checkpoints(path)
```


</details> </br>

<details>
  <summary>Results</summary>

```{r IMMfull_results}
summary(fit$IMMfull)
```


</details> </br>

<details>
  <summary>Compare with reference fit:</summary>

```{r ref_fits_IMMfull}
ref_fits$IMMfull
```


</details> </br>

Difference in estimates

```{r IMMfull_diff}
withr::local_options(list(digits=3))
fit_rows <- rownames(fixef(fit$IMMfull))
round(fixef(fit$IMMfull) - fixef(ref_fits$IMMfull)[fit_rows,],3)
```


## Test: IMMbsc

<details>
  <summary>Run the model</summary>

```{r IMMbsc_fit}
path <- file_path2(here::here(), basepath, "IMMbsc")
data <- ref_fits$IMMbsc$data

formula <- bmf(c ~ 0 + SetSize,
               s ~ 0 + SetSize,
               kappa ~ 0 + SetSize)

model <- IMMbsc(resp_err = 'dev_rad',
                nt_features = paste0("Item", 2:4,"_Col_rad"),
                nt_distances = paste0("Item", 2:4,"_Pos_rad"),
                setsize = "SetSize")

fit$IMMbsc.1 <- fit_model(formula, data, model,
                        parallel = TRUE,
                        chains = 4,
                        iter = 1000,
                        refresh = 500,
                        init = 1,
                        silent = 2,
                        backend = 'cmdstanr',
                        seed = seed, 
                        checkpoint_every = 250,
                        stop_after = 750,
                        checkpoints_folder = path)

fit$IMMbsc <- fit_model(formula, data, model,
                        parallel = TRUE,
                        chains = 4,
                        iter = 1000,
                        refresh = 500,
                        init = 1,
                        silent = 2,
                        backend = 'cmdstanr',
                        seed = seed, 
                        checkpoint_every = 250,
                        checkpoints_folder = path)
reset_checkpoints(path)
```


</details> </br>

<details>
  <summary>Results</summary>

```{r IMMbsc_results}
summary(fit$IMMbsc)
```


</details> </br>

<details>
  <summary>Compare with reference fit:</summary>

```{r ref_fits_IMMbsc}
ref_fits$IMMbsc
```


</details> </br>

Difference in estimates

```{r IMMbsc_diff}
withr::local_options(list(digits=3))
fit_rows <- rownames(fixef(fit$IMMbsc))
round(fixef(fit$IMMbsc) - fixef(ref_fits$IMMbsc)[fit_rows,],3)
```


## Test: IMMabc

<details>
  <summary>Run the model</summary>

```{r IMMabc_fit}
path <- file_path2(here::here(), basepath, "IMMabc")
data <- ref_fits$IMMabc$data

formula <- bmf(a ~ 0 + SetSize,
               c ~ 0 + SetSize,
               kappa ~ 0 + SetSize)

model <- IMMabc(resp_err = 'dev_rad',
                nt_features = paste0("Item", 2:4,"_Col_rad"),
                setsize = "SetSize")

fit$IMMabc.1 <- fit_model(formula, data, model,
                        parallel = TRUE,
                        chains = 4,
                        iter = 1000,
                        refresh = 500,
                        init = 1,
                        silent = 2,
                        backend = 'cmdstanr',
                        seed = seed, 
                        checkpoint_every = 250,
                        stop_after = 750,
                        checkpoints_folder = path)

fit$IMMabc <- fit_model(formula, data, model,
                        parallel = TRUE,
                        chains = 4,
                        iter = 1000,
                        refresh = 500,
                        init = 1,
                        silent = 2,
                        backend = 'cmdstanr',
                        seed = seed, 
                        checkpoint_every = 250,
                        checkpoints_folder = path)
reset_checkpoints(path)
```


</details> </br>

<details>
  <summary>Results</summary>

```{r IMMabc_results}
summary(fit$IMMabc)
```


</details> </br>

<details>
  <summary>Compare with reference fit:</summary>

```{r ref_fits_IMMabc}
ref_fits$IMMabc
```


</details> </br>

Difference in estimates

```{r IMMabc_diff}
withr::local_options(list(digits=3))
fit_rows <- rownames(fixef(fit$IMMabc))
round(fixef(fit$IMMabc) - fixef(ref_fits$IMMabc)[fit_rows,],3)
```


