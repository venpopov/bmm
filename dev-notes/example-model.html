<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Example model file – BMM Developer Notes</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./add-new-model.html" rel="next">
<link href="./bmm-architecture.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">BMM Developer Notes</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./../reference/index.html"> 
<span class="menu-text">Functions</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../articles/index.html"> 
<span class="menu-text">Articles</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../news/index.html"> 
<span class="menu-text">Changelog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../dev-notes/index.html"> 
<span class="menu-text">Develop</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./../parameter-recovery/index.html"> 
<span class="menu-text">Parameter recovery</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./example-model.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Example model file</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">System setup</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./git-workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Git and Github workflow</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bmm-architecture.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">BMM code structure</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./example-model.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Example model file</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./add-new-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Adding a new model</span></span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#the-interference-measurement-model-imm" id="toc-the-interference-measurement-model-imm" class="nav-link active" data-scroll-target="#the-interference-measurement-model-imm"><span class="header-section-number">4.1</span> The Interference Measurement Model (IMM)</a>
  <ul class="collapse">
  <li><a href="#model-definition" id="toc-model-definition" class="nav-link" data-scroll-target="#model-definition"><span class="header-section-number">4.1.1</span> Model definition</a></li>
  <li><a href="#model-alias" id="toc-model-alias" class="nav-link" data-scroll-target="#model-alias"><span class="header-section-number">4.1.2</span> Model alias</a></li>
  <li><a href="#check_data-methods" id="toc-check_data-methods" class="nav-link" data-scroll-target="#check_data-methods"><span class="header-section-number">4.1.3</span> check_data() methods</a></li>
  <li><a href="#configure_model-methods" id="toc-configure_model-methods" class="nav-link" data-scroll-target="#configure_model-methods"><span class="header-section-number">4.1.4</span> configure_model() methods</a></li>
  </ul></li>
  <li><a href="#the-signal-discrimination-model-sdm" id="toc-the-signal-discrimination-model-sdm" class="nav-link" data-scroll-target="#the-signal-discrimination-model-sdm"><span class="header-section-number">4.2</span> The Signal Discrimination Model (SDM)</a>
  <ul class="collapse">
  <li><a href="#model-definition-1" id="toc-model-definition-1" class="nav-link" data-scroll-target="#model-definition-1"><span class="header-section-number">4.2.1</span> Model definition</a></li>
  <li><a href="#check_data-methods-1" id="toc-check_data-methods-1" class="nav-link" data-scroll-target="#check_data-methods-1"><span class="header-section-number">4.2.2</span> check_data() methods</a></li>
  <li><a href="#configure_model-methods-1" id="toc-configure_model-methods-1" class="nav-link" data-scroll-target="#configure_model-methods-1"><span class="header-section-number">4.2.3</span> configure_model() methods</a></li>
  <li><a href="#post-processing-methods" id="toc-post-processing-methods" class="nav-link" data-scroll-target="#post-processing-methods"><span class="header-section-number">4.2.4</span> Post-processing methods</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-example-model" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Example model file</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>All models in the package are defined as S3 classes and follow a strict template. This allows us to implement general methods for handling model fitting, data checking, and post-processing. Each model has an internal function that defines the model and its parameters, and a user-facing alias. Let’s look at how two models are implemented - the IMM model, which uses both general class and specific model methods, but no custom stan code, and the SDM model, which depends heavily on custom stan code. If you use the <code>use_model_template()</code> function, templates for all sections below will be automatically generated for your model.</p>
<section id="the-interference-measurement-model-imm" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="the-interference-measurement-model-imm"><span class="header-section-number">4.1</span> The Interference Measurement Model (IMM)</h2>
<p>The model is defined in the file <code>R/model_imm.R.</code> Let’s go through the different parts.</p>
<section id="model-definition" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="model-definition"><span class="header-section-number">4.1.1</span> Model definition</h3>
<p>The full IMM model is defined in the following internal model class:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>.model_imm <span class="ot">&lt;-</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>  <span class="cf">function</span>(<span class="at">resp_error =</span> <span class="cn">NULL</span>, <span class="at">nt_features =</span> <span class="cn">NULL</span>, <span class="at">nt_distances =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-3"><a href="#cb1-3"></a>           <span class="at">set_size =</span> <span class="cn">NULL</span>, <span class="at">regex =</span> <span class="cn">FALSE</span>, <span class="at">version =</span> <span class="st">"full"</span>, <span class="at">links =</span> <span class="cn">NULL</span>,</span>
<span id="cb1-4"><a href="#cb1-4"></a>           <span class="at">call =</span> <span class="cn">NULL</span>, ...) {</span>
<span id="cb1-5"><a href="#cb1-5"></a>    out <span class="ot">&lt;-</span> <span class="fu">structure</span>(</span>
<span id="cb1-6"><a href="#cb1-6"></a>      <span class="fu">list</span>(</span>
<span id="cb1-7"><a href="#cb1-7"></a>        <span class="at">resp_vars =</span> <span class="fu">nlist</span>(resp_error),</span>
<span id="cb1-8"><a href="#cb1-8"></a>        <span class="at">other_vars =</span> <span class="fu">nlist</span>(nt_features, nt_distances, set_size),</span>
<span id="cb1-9"><a href="#cb1-9"></a>        <span class="at">domain =</span> <span class="st">"Visual working memory"</span>,</span>
<span id="cb1-10"><a href="#cb1-10"></a>        <span class="at">task =</span> <span class="st">"Continuous reproduction"</span>,</span>
<span id="cb1-11"><a href="#cb1-11"></a>        <span class="at">name =</span> <span class="st">"Interference measurement model by Oberauer and Lin (2017)."</span>,</span>
<span id="cb1-12"><a href="#cb1-12"></a>        <span class="at">version =</span> version,</span>
<span id="cb1-13"><a href="#cb1-13"></a>        <span class="at">citation =</span> <span class="fu">glue</span>(</span>
<span id="cb1-14"><a href="#cb1-14"></a>          <span class="st">"Oberauer, K., &amp; Lin, H.Y. (2017). An interference model </span><span class="sc">\\</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="st">          of visual working memory. Psychological Review, 124(1), 21-59"</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>        ),</span>
<span id="cb1-17"><a href="#cb1-17"></a>        <span class="at">requirements =</span> <span class="fu">glue</span>(</span>
<span id="cb1-18"><a href="#cb1-18"></a>          <span class="st">'- The response vairable should be in radians and </span><span class="sc">\\</span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="st">          represent the angular error relative to the target</span></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="st">          - The non-target features should be in radians and be </span><span class="sc">\\</span></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="st">          centered relative to the target'</span></span>
<span id="cb1-22"><a href="#cb1-22"></a>        ),</span>
<span id="cb1-23"><a href="#cb1-23"></a>        <span class="at">parameters =</span> <span class="fu">list</span>(</span>
<span id="cb1-24"><a href="#cb1-24"></a>          <span class="at">mu1 =</span> <span class="fu">glue</span>(</span>
<span id="cb1-25"><a href="#cb1-25"></a>            <span class="st">"Location parameter of the von Mises distribution for memory </span><span class="sc">\\</span></span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="st">            responses (in radians). Fixed internally to 0 by default."</span></span>
<span id="cb1-27"><a href="#cb1-27"></a>          ),</span>
<span id="cb1-28"><a href="#cb1-28"></a>          <span class="at">kappa =</span> <span class="st">"Concentration parameter of the von Mises distribution"</span>,</span>
<span id="cb1-29"><a href="#cb1-29"></a>          <span class="at">a =</span> <span class="st">"General activation of memory items"</span>,</span>
<span id="cb1-30"><a href="#cb1-30"></a>          <span class="at">c =</span> <span class="st">"Context activation"</span>,</span>
<span id="cb1-31"><a href="#cb1-31"></a>          <span class="at">s =</span> <span class="st">"Spatial similarity gradient"</span></span>
<span id="cb1-32"><a href="#cb1-32"></a>        ),</span>
<span id="cb1-33"><a href="#cb1-33"></a>        <span class="at">links =</span> <span class="fu">list</span>(</span>
<span id="cb1-34"><a href="#cb1-34"></a>          <span class="at">mu1 =</span> <span class="st">"tan_half"</span>,</span>
<span id="cb1-35"><a href="#cb1-35"></a>          <span class="at">kappa =</span> <span class="st">"log"</span>,</span>
<span id="cb1-36"><a href="#cb1-36"></a>          <span class="at">a =</span> <span class="st">"log"</span>,</span>
<span id="cb1-37"><a href="#cb1-37"></a>          <span class="at">c =</span> <span class="st">"log"</span>,</span>
<span id="cb1-38"><a href="#cb1-38"></a>          <span class="at">s =</span> <span class="st">"log"</span></span>
<span id="cb1-39"><a href="#cb1-39"></a>        ),</span>
<span id="cb1-40"><a href="#cb1-40"></a>        <span class="at">fixed_parameters =</span> <span class="fu">list</span>(<span class="at">mu1 =</span> <span class="dv">0</span>, <span class="at">mu2 =</span> <span class="dv">0</span>, <span class="at">kappa2 =</span> <span class="sc">-</span><span class="dv">100</span>),</span>
<span id="cb1-41"><a href="#cb1-41"></a>        <span class="at">default_priors =</span> <span class="fu">list</span>(</span>
<span id="cb1-42"><a href="#cb1-42"></a>          <span class="at">mu1 =</span> <span class="fu">list</span>(<span class="at">main =</span> <span class="st">"student_t(1, 0, 1)"</span>),</span>
<span id="cb1-43"><a href="#cb1-43"></a>          <span class="at">kappa =</span> <span class="fu">list</span>(<span class="at">main =</span> <span class="st">"normal(2, 1)"</span>, <span class="at">effects =</span> <span class="st">"normal(0, 1)"</span>),</span>
<span id="cb1-44"><a href="#cb1-44"></a>          <span class="at">a =</span> <span class="fu">list</span>(<span class="at">main =</span> <span class="st">"normal(0, 1)"</span>, <span class="at">effects =</span> <span class="st">"normal(0, 1)"</span>),</span>
<span id="cb1-45"><a href="#cb1-45"></a>          <span class="at">c =</span> <span class="fu">list</span>(<span class="at">main =</span> <span class="st">"normal(0, 1)"</span>, <span class="at">effects =</span> <span class="st">"normal(0, 1)"</span>),</span>
<span id="cb1-46"><a href="#cb1-46"></a>          <span class="at">s =</span> <span class="fu">list</span>(<span class="at">main =</span> <span class="st">"normal(0, 1)"</span>, <span class="at">effects =</span> <span class="st">"normal(0, 1)"</span>)</span>
<span id="cb1-47"><a href="#cb1-47"></a>        ),</span>
<span id="cb1-48"><a href="#cb1-48"></a>        <span class="at">void_mu =</span> <span class="cn">FALSE</span></span>
<span id="cb1-49"><a href="#cb1-49"></a>      ),</span>
<span id="cb1-50"><a href="#cb1-50"></a>      <span class="co"># attributes</span></span>
<span id="cb1-51"><a href="#cb1-51"></a>      <span class="at">regex =</span> regex,</span>
<span id="cb1-52"><a href="#cb1-52"></a>      <span class="at">regex_vars =</span> <span class="fu">c</span>(<span class="st">'nt_features'</span>, <span class="st">'nt_distances'</span>),</span>
<span id="cb1-53"><a href="#cb1-53"></a>      <span class="at">class =</span> <span class="fu">c</span>(<span class="st">"bmmodel"</span>, <span class="st">"circular"</span>, <span class="st">"non_targets"</span>, <span class="st">"imm"</span>, <span class="fu">paste0</span>(<span class="st">'imm_'</span>,version)),</span>
<span id="cb1-54"><a href="#cb1-54"></a>      <span class="at">call =</span> call</span>
<span id="cb1-55"><a href="#cb1-55"></a>    )</span>
<span id="cb1-56"><a href="#cb1-56"></a></span>
<span id="cb1-57"><a href="#cb1-57"></a>    <span class="co"># add version specific information</span></span>
<span id="cb1-58"><a href="#cb1-58"></a>    <span class="cf">if</span> (version <span class="sc">==</span> <span class="st">"abc"</span>) {</span>
<span id="cb1-59"><a href="#cb1-59"></a>      out<span class="sc">$</span>parameters<span class="sc">$</span>s <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-60"><a href="#cb1-60"></a>      out<span class="sc">$</span>links<span class="sc">$</span>s <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-61"><a href="#cb1-61"></a>      out<span class="sc">$</span>default_priors<span class="sc">$</span>s <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-62"><a href="#cb1-62"></a>      <span class="fu">attributes</span>(out)<span class="sc">$</span>regex_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'nt_features'</span>)</span>
<span id="cb1-63"><a href="#cb1-63"></a>    } <span class="cf">else</span> <span class="cf">if</span> (version <span class="sc">==</span> <span class="st">"bsc"</span>) {</span>
<span id="cb1-64"><a href="#cb1-64"></a>      out<span class="sc">$</span>parameters<span class="sc">$</span>a <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-65"><a href="#cb1-65"></a>      out<span class="sc">$</span>links<span class="sc">$</span>a <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-66"><a href="#cb1-66"></a>      out<span class="sc">$</span>default_priors<span class="sc">$</span>a <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-67"><a href="#cb1-67"></a>    }</span>
<span id="cb1-68"><a href="#cb1-68"></a></span>
<span id="cb1-69"><a href="#cb1-69"></a>    out<span class="sc">$</span>links[<span class="fu">names</span>(links)] <span class="ot">&lt;-</span> links</span>
<span id="cb1-70"><a href="#cb1-70"></a>    out</span>
<span id="cb1-71"><a href="#cb1-71"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here is a brief explanation of the different components of the model definition:</p>
<p><code>resp_vars</code>: a list of response variables that the model will be fitted to. These variables will be used to construct the <code>brmsformula</code> passed to <code>brms</code> together with the <code>bmmformula</code> and the <code>parameters</code> of the model. The user has to provide these variables in the data frame that is passed to the <code>bmm()</code> function</p>
<p><code>other_vars:</code> a list of additional variables that are required for the model. This is used to check if the data contains all necessary information for fitting the model. In the example above, the IMM model requires the names of the variables specifying the non-target features relative to the target, the variables specifying the distance of the non-targets to the target, and the set_size. The user has to provide these variables in the data frame that is passed to the <code>bmm()</code> function</p>
<p><code>domain, task, name, citation, requirements</code>: contains information about the model, such as the domain, task, name, citation, requirements. This information is used for generating help pages</p>
<p><code>version:</code> if the model has multiple versions, this argument is specified by the user. Then it is used to dynamically adjust some information in the model object. In the case of the <code>imm</code> model, we have three versions - <code>full</code>, <code>bsc</code> and <code>abc</code>. As you can see at the end of the script, some parameters are deleted depending on the model version.</p>
<p><code>parameters:</code> contains a named list of all parameters in the model that can be estimated by the user and their description. This information is used internally to check if the <code>bmmformula</code> contains linear model formulas for all model parameters, and to decide what information to include in the summary of <code>bmmfit</code> objects.</p>
<p><code>links:</code> a named list providing the link function for each parameter. For example, <code>kappa</code> in the <code>imm</code> models has to be positive, so it is sampled on the log scale. This information is used in defining the model family and for the summary methods. If you want the user to be able to specify custom link functions, the next to last line of the script replaces the links with those provided by the user</p>
<p><code>fixed_parameters</code> in the <code>imm</code> several parameters are fixed to constant values internally to identify the model. Only one of them, <code>mu1</code> is also part of the <code>parameters</code> block - this is the only fixed parameters that users can choose to estimate instead of leaving it fixed. <code>mu2</code> and <code>kappa2</code> cannot be freely estimated.</p>
<p><code>default_priors</code> a list of lists for each parameter in the model. Each prior has two components: <code>main</code>, the prior that will be put on the Intercept or on each level of a factor if the intercept is suppressed; <code>effects</code>, the prior to put on the regression coefficients relative to the intercept. The priors are described as in the <code>set_prior</code> function from <code>brms</code>. This information is used by the <code>configure_prior()</code> S3 method to automatically set the default priors for the model. The priors that you put here will be used by <code>bmm()</code> unless the users chooses to overwrite them.</p>
<p><code>void_mu:</code> For models using a custom family that do not contain a <code>location</code> or <code>mu</code> parameter, for example the diffusion model, we recommend setting up a <code>void_mu</code> parameter. This avoids arbitrarily using one of the model parameters as the <code>mu</code> parameter.</p>
<p><code>regex:</code> For the <code>imm</code> models, the <code>nt_features</code> and <code>nt_distances</code> variables can be specified with regular expressions, if the user sets <code>regex = TRUE</code></p>
<p><code>call</code>: this automatically records how the model was called so that the call can be printed in the summary after fitting. Leave it as is.</p>
<p><code>class</code>: is the most important part. It contains the class of the model. This is used by generic S3 methods to perform data checks and model configuration. The classes should be ordered from most general to most specific. A general class exists when the same operations can be performed on multiple models. For example, the ‘3p’, ‘imm_abc’, ‘imm_bsc’ and ‘imm_full’ models all have non-targets and set_size arguments, so the same data checks can be performed on all of them, represented by the class <code>non_targets</code>. The first class should always be <code>bmmodel</code>, which is the main class for all models. The last class should be the specific model name, in this case <code>imm_full</code>, <code>imm_abc</code> or <code>imm_bsc</code>, which is automatically constructed if a <code>version</code> argument is provided. Otherwise the last class will be just the name of the model.</p>
</section>
<section id="model-alias" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2" class="anchored" data-anchor-id="model-alias"><span class="header-section-number">4.1.2</span> Model alias</h3>
<p>The model alias is a user-facing function that calls the internal model function. It is defined as follows:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co">#' @title `r .model_imm()$name`</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="co">#' @description Three versions of the `r .model_imm()$name` - the full, bsc, and abc.</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">#' `IMMfull()`, `IMMbsc()`, and `IMMabc()` are deprecated and will be removed in the future.</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co">#' Please use `imm(version = 'full')`, `imm(version = 'bsc')`, or `imm(version = 'abc')` instead.</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co">#'</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co">#' @name imm</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="co">#' @details `r model_info(.model_imm(), components =c('domain', 'task', 'name', 'citation'))`</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="co">#' #### Version: `full`</span></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="co">#' `r model_info(.model_imm(version = "full"), components = c('requirements', 'parameters', 'fixed_parameters', 'links', 'prior'))`</span></span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="co">#' #### Version: `bsc`</span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="co">#' `r model_info(.model_imm(version = "bsc"), components = c('requirements', 'parameters', 'fixed_parameters', 'links', 'prior'))`</span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="co">#' #### Version: `abc`</span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co">#' `r model_info(.model_imm(version = "abc"), components =c('requirements', 'parameters', 'fixed_parameters', 'links', 'prior'))`</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="co">#'</span></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="co">#' Additionally, all imm models have an internal parameter that is fixed to 0 to</span></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co">#' allow the model to be identifiable. This parameter is not estimated and is not</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="co">#' included in the model formula. The parameter is:</span></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="co">#'</span></span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="co">#'   - b = "Background activation (internally fixed to 0)"</span></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="co">#'</span></span>
<span id="cb2-21"><a href="#cb2-21"></a><span class="co">#' @param resp_error The name of the variable in the provided dataset containing</span></span>
<span id="cb2-22"><a href="#cb2-22"></a><span class="co">#'   the response error. The response Error should code the response relative to</span></span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="co">#'   the to-be-recalled target in radians. You can transform the response error</span></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="co">#'   in degrees to radian using the `deg2rad` function.</span></span>
<span id="cb2-25"><a href="#cb2-25"></a><span class="co">#' @param nt_features A character vector with the names of the non-target</span></span>
<span id="cb2-26"><a href="#cb2-26"></a><span class="co">#'   variables. The non_target variables should be in radians and be centered</span></span>
<span id="cb2-27"><a href="#cb2-27"></a><span class="co">#'   relative to the target. Alternatively, if regex=TRUE, a regular</span></span>
<span id="cb2-28"><a href="#cb2-28"></a><span class="co">#'   expression can be used to match the non-target feature columns in the</span></span>
<span id="cb2-29"><a href="#cb2-29"></a><span class="co">#'   dataset.</span></span>
<span id="cb2-30"><a href="#cb2-30"></a><span class="co">#' @param nt_distances A vector of names of the columns containing the distances</span></span>
<span id="cb2-31"><a href="#cb2-31"></a><span class="co">#'   of non-target items to the target item. Alternatively, if regex=TRUE, a regular</span></span>
<span id="cb2-32"><a href="#cb2-32"></a><span class="co">#'   expression can be used to match the non-target distances columns in the</span></span>
<span id="cb2-33"><a href="#cb2-33"></a><span class="co">#'   dataset. Only necessary for the `bsc` and `full` versions.</span></span>
<span id="cb2-34"><a href="#cb2-34"></a><span class="co">#' @param set_size Name of the column containing the set size variable (if</span></span>
<span id="cb2-35"><a href="#cb2-35"></a><span class="co">#'   set_size varies) or a numeric value for the set_size, if the set_size is</span></span>
<span id="cb2-36"><a href="#cb2-36"></a><span class="co">#'   fixed.</span></span>
<span id="cb2-37"><a href="#cb2-37"></a><span class="co">#' @param regex Logical. If TRUE, the `nt_features` and `nt_distances` arguments</span></span>
<span id="cb2-38"><a href="#cb2-38"></a><span class="co">#'   are interpreted as a regular expression to match the non-target feature</span></span>
<span id="cb2-39"><a href="#cb2-39"></a><span class="co">#'   columns in the dataset.</span></span>
<span id="cb2-40"><a href="#cb2-40"></a><span class="co">#' @param version Character. The version of the IMM model to use. Can be one of</span></span>
<span id="cb2-41"><a href="#cb2-41"></a><span class="co">#'  `full`, `bsc`, or `abc`. The default is `full`.</span></span>
<span id="cb2-42"><a href="#cb2-42"></a><span class="co">#' @param ... used internally for testing, ignore it</span></span>
<span id="cb2-43"><a href="#cb2-43"></a><span class="co">#' @return An object of class `bmmodel`</span></span>
<span id="cb2-44"><a href="#cb2-44"></a><span class="co">#' @keywords bmmodel</span></span>
<span id="cb2-45"><a href="#cb2-45"></a><span class="co">#' @examplesIf isTRUE(Sys.getenv("BMM_EXAMPLES"))</span></span>
<span id="cb2-46"><a href="#cb2-46"></a><span class="co">#' # load data</span></span>
<span id="cb2-47"><a href="#cb2-47"></a><span class="co">#' data &lt;- oberauer_lin_2017</span></span>
<span id="cb2-48"><a href="#cb2-48"></a><span class="co">#'</span></span>
<span id="cb2-49"><a href="#cb2-49"></a><span class="co">#' # define formula</span></span>
<span id="cb2-50"><a href="#cb2-50"></a><span class="co">#' ff &lt;- bmmformula(</span></span>
<span id="cb2-51"><a href="#cb2-51"></a><span class="co">#'   kappa ~ 0 + set_size,</span></span>
<span id="cb2-52"><a href="#cb2-52"></a><span class="co">#'   c ~ 0 + set_size,</span></span>
<span id="cb2-53"><a href="#cb2-53"></a><span class="co">#'   a ~ 0 + set_size,</span></span>
<span id="cb2-54"><a href="#cb2-54"></a><span class="co">#'   s ~ 0 + set_size</span></span>
<span id="cb2-55"><a href="#cb2-55"></a><span class="co">#' )</span></span>
<span id="cb2-56"><a href="#cb2-56"></a><span class="co">#'</span></span>
<span id="cb2-57"><a href="#cb2-57"></a><span class="co">#' # specify the full IMM model with explicit column names for non-target features and distances</span></span>
<span id="cb2-58"><a href="#cb2-58"></a><span class="co">#' # by default this fits the full version of the model</span></span>
<span id="cb2-59"><a href="#cb2-59"></a><span class="co">#' model1 &lt;- imm(resp_error = "dev_rad",</span></span>
<span id="cb2-60"><a href="#cb2-60"></a><span class="co">#'               nt_features = paste0('col_nt', 1:7),</span></span>
<span id="cb2-61"><a href="#cb2-61"></a><span class="co">#'               nt_distances = paste0('dist_nt', 1:7),</span></span>
<span id="cb2-62"><a href="#cb2-62"></a><span class="co">#'               set_size = 'set_size')</span></span>
<span id="cb2-63"><a href="#cb2-63"></a><span class="co">#'</span></span>
<span id="cb2-64"><a href="#cb2-64"></a><span class="co">#' # fit the model</span></span>
<span id="cb2-65"><a href="#cb2-65"></a><span class="co">#' fit &lt;- bmm(formula = ff,</span></span>
<span id="cb2-66"><a href="#cb2-66"></a><span class="co">#'            data = data,</span></span>
<span id="cb2-67"><a href="#cb2-67"></a><span class="co">#'            model = model1,</span></span>
<span id="cb2-68"><a href="#cb2-68"></a><span class="co">#'            cores = 4,</span></span>
<span id="cb2-69"><a href="#cb2-69"></a><span class="co">#'            backend = 'cmdstanr')</span></span>
<span id="cb2-70"><a href="#cb2-70"></a><span class="co">#'</span></span>
<span id="cb2-71"><a href="#cb2-71"></a><span class="co">#' # alternatively specify the IMM model with a regular expression to match non-target features</span></span>
<span id="cb2-72"><a href="#cb2-72"></a><span class="co">#' # this is equivalent to the previous call, but more concise</span></span>
<span id="cb2-73"><a href="#cb2-73"></a><span class="co">#' model2 &lt;- imm(resp_error = "dev_rad",</span></span>
<span id="cb2-74"><a href="#cb2-74"></a><span class="co">#'               nt_features = 'col_nt',</span></span>
<span id="cb2-75"><a href="#cb2-75"></a><span class="co">#'               nt_distances = 'dist_nt',</span></span>
<span id="cb2-76"><a href="#cb2-76"></a><span class="co">#'               set_size = 'set_size',</span></span>
<span id="cb2-77"><a href="#cb2-77"></a><span class="co">#'               regex = TRUE)</span></span>
<span id="cb2-78"><a href="#cb2-78"></a><span class="co">#'</span></span>
<span id="cb2-79"><a href="#cb2-79"></a><span class="co">#' # fit the model</span></span>
<span id="cb2-80"><a href="#cb2-80"></a><span class="co">#' fit &lt;- bmm(formula = ff,</span></span>
<span id="cb2-81"><a href="#cb2-81"></a><span class="co">#'            data = data,</span></span>
<span id="cb2-82"><a href="#cb2-82"></a><span class="co">#'            model = model2,</span></span>
<span id="cb2-83"><a href="#cb2-83"></a><span class="co">#'            cores = 4,</span></span>
<span id="cb2-84"><a href="#cb2-84"></a><span class="co">#'            backend = 'cmdstanr')</span></span>
<span id="cb2-85"><a href="#cb2-85"></a><span class="co">#'</span></span>
<span id="cb2-86"><a href="#cb2-86"></a><span class="co">#' # you can also specify the `bsc` or `abc` versions of the model to fit a reduced version</span></span>
<span id="cb2-87"><a href="#cb2-87"></a><span class="co">#' model3 &lt;- imm(resp_error = "dev_rad",</span></span>
<span id="cb2-88"><a href="#cb2-88"></a><span class="co">#'               nt_features = 'col_nt',</span></span>
<span id="cb2-89"><a href="#cb2-89"></a><span class="co">#'               set_size = 'set_size',</span></span>
<span id="cb2-90"><a href="#cb2-90"></a><span class="co">#'               regex = TRUE,</span></span>
<span id="cb2-91"><a href="#cb2-91"></a><span class="co">#'               version = 'abc')</span></span>
<span id="cb2-92"><a href="#cb2-92"></a><span class="co">#' fit &lt;- bmm(formula = ff,</span></span>
<span id="cb2-93"><a href="#cb2-93"></a><span class="co">#'            data = data,</span></span>
<span id="cb2-94"><a href="#cb2-94"></a><span class="co">#'            model = model3,</span></span>
<span id="cb2-95"><a href="#cb2-95"></a><span class="co">#'            cores = 4,</span></span>
<span id="cb2-96"><a href="#cb2-96"></a><span class="co">#'            backend = 'cmdstanr')</span></span>
<span id="cb2-97"><a href="#cb2-97"></a><span class="co">#' @export</span></span>
<span id="cb2-98"><a href="#cb2-98"></a>imm <span class="ot">&lt;-</span> <span class="cf">function</span>(resp_error, nt_features, nt_distances, set_size, <span class="at">regex =</span> <span class="cn">FALSE</span>, <span class="at">version =</span> <span class="st">"full"</span>, ...) {</span>
<span id="cb2-99"><a href="#cb2-99"></a>  call <span class="ot">&lt;-</span> <span class="fu">match.call</span>()</span>
<span id="cb2-100"><a href="#cb2-100"></a>  dots <span class="ot">&lt;-</span> <span class="fu">list</span>(...)</span>
<span id="cb2-101"><a href="#cb2-101"></a>  <span class="cf">if</span> (<span class="st">"setsize"</span> <span class="sc">%in%</span> <span class="fu">names</span>(dots)) {</span>
<span id="cb2-102"><a href="#cb2-102"></a>    set_size <span class="ot">&lt;-</span> dots<span class="sc">$</span>setsize</span>
<span id="cb2-103"><a href="#cb2-103"></a>    <span class="fu">warning</span>(<span class="st">"The argument 'setsize' is deprecated. Please use 'set_size' instead."</span>)</span>
<span id="cb2-104"><a href="#cb2-104"></a>  }</span>
<span id="cb2-105"><a href="#cb2-105"></a>  <span class="cf">if</span> (version <span class="sc">==</span> <span class="st">"abc"</span>) {</span>
<span id="cb2-106"><a href="#cb2-106"></a>    nt_distances <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb2-107"><a href="#cb2-107"></a>  }</span>
<span id="cb2-108"><a href="#cb2-108"></a>  <span class="fu">stop_missing_args</span>()</span>
<span id="cb2-109"><a href="#cb2-109"></a>  <span class="fu">.model_imm</span>(<span class="at">resp_error =</span> resp_error, <span class="at">nt_features =</span> nt_features,</span>
<span id="cb2-110"><a href="#cb2-110"></a>             <span class="at">nt_distances =</span> nt_distances, <span class="at">set_size =</span> set_size, <span class="at">regex =</span> regex,</span>
<span id="cb2-111"><a href="#cb2-111"></a>             <span class="at">version =</span> version, <span class="at">call =</span> call, ...)</span>
<span id="cb2-112"><a href="#cb2-112"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The details will be filled out automatically from the model definition. This does some fancy formatting to include documentation about all versions of the model in the same help file.</p>
</section>
<section id="check_data-methods" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3" class="anchored" data-anchor-id="check_data-methods"><span class="header-section-number">4.1.3</span> check_data() methods</h3>
<p>Each model should have a <code>check_data.modelname()</code> method that checks if the data contains all necessary information for fitting the model. For the IMM, the <code>bsc</code> and <code>full</code> versions require a special check for the <code>nt_distances</code> variables:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">#' @export</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>check_data.imm_bsc <span class="ot">&lt;-</span> <span class="cf">function</span>(model, data, formula) {</span>
<span id="cb3-3"><a href="#cb3-3"></a>  data <span class="ot">&lt;-</span> <span class="fu">.check_data_imm_dist</span>(model, data, formula)</span>
<span id="cb3-4"><a href="#cb3-4"></a>  <span class="fu">NextMethod</span>(<span class="st">"check_data"</span>)</span>
<span id="cb3-5"><a href="#cb3-5"></a>}</span>
<span id="cb3-6"><a href="#cb3-6"></a></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="co">#' @export</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>check_data.imm_full <span class="ot">&lt;-</span> <span class="cf">function</span>(model, data, formula) {</span>
<span id="cb3-9"><a href="#cb3-9"></a>  data <span class="ot">&lt;-</span> <span class="fu">.check_data_imm_dist</span>(model, data, formula)</span>
<span id="cb3-10"><a href="#cb3-10"></a>  <span class="fu">NextMethod</span>(<span class="st">"check_data"</span>)</span>
<span id="cb3-11"><a href="#cb3-11"></a>}</span>
<span id="cb3-12"><a href="#cb3-12"></a></span>
<span id="cb3-13"><a href="#cb3-13"></a>.check_data_imm_dist <span class="ot">&lt;-</span> <span class="cf">function</span>(model, data, formula) {</span>
<span id="cb3-14"><a href="#cb3-14"></a>  nt_distances <span class="ot">&lt;-</span> model<span class="sc">$</span>other_vars<span class="sc">$</span>nt_distances</span>
<span id="cb3-15"><a href="#cb3-15"></a>  max_set_size <span class="ot">&lt;-</span> <span class="fu">attr</span>(data, <span class="st">'max_set_size'</span>)</span>
<span id="cb3-16"><a href="#cb3-16"></a></span>
<span id="cb3-17"><a href="#cb3-17"></a>  <span class="fu">stopif</span>(<span class="sc">!</span><span class="fu">isTRUE</span>(<span class="fu">all.equal</span>(<span class="fu">length</span>(nt_distances), max_set_size <span class="sc">-</span> <span class="dv">1</span>)),</span>
<span id="cb3-18"><a href="#cb3-18"></a>         <span class="st">"The number of columns for non-target distances in the argument </span><span class="sc">\\</span></span>
<span id="cb3-19"><a href="#cb3-19"></a><span class="st">         'nt_distances' should equal max(set_size)-1})"</span>)</span>
<span id="cb3-20"><a href="#cb3-20"></a></span>
<span id="cb3-21"><a href="#cb3-21"></a>  <span class="co"># replace nt_distances</span></span>
<span id="cb3-22"><a href="#cb3-22"></a>  data[,nt_distances][<span class="fu">is.na</span>(data[,nt_distances])] <span class="ot">&lt;-</span> <span class="dv">999</span></span>
<span id="cb3-23"><a href="#cb3-23"></a></span>
<span id="cb3-24"><a href="#cb3-24"></a>  <span class="fu">stopif</span>(<span class="fu">any</span>(data[,nt_distances] <span class="sc">&lt;</span> <span class="dv">0</span>),</span>
<span id="cb3-25"><a href="#cb3-25"></a>         <span class="st">"All non-target distances to the target need to be postive."</span>)</span>
<span id="cb3-26"><a href="#cb3-26"></a>  data</span>
<span id="cb3-27"><a href="#cb3-27"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The IMM models share methods with the <code>mixture3p</code> model, all of which are of class <code>non_targets</code> so the <code>check_data.non_targets</code> method is defined in the general file <code>R/helpers-data.R</code>. If you are adding a new model, you should check if the data requirements are similar to any existing model and define the <code>check_data</code> method only for the methods that are unique to your model.</p>
<p>The <code>check_data.mymodel()</code> function should always take the arguments <code>model</code>, <code>data</code>, and <code>formula</code> and return the data with the necessary transformations. It should also call <code>data = NextMethod("check_data")</code> to call the check_data method of the more general class.</p>
</section>
<section id="configure_model-methods" class="level3" data-number="4.1.4">
<h3 data-number="4.1.4" class="anchored" data-anchor-id="configure_model-methods"><span class="header-section-number">4.1.4</span> configure_model() methods</h3>
<p>The configure_model.mymodel() method is where you specify the model formula, the family, any custom code. The method is defined as follows for the IMM model:</p>
<p>(we show only the <code>IMMfull</code> version)</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>configure_model.imm_full <span class="ot">&lt;-</span> <span class="cf">function</span>(model, data, formula) {</span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="co"># retrieve arguments from the data check</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>  max_set_size <span class="ot">&lt;-</span> <span class="fu">attr</span>(data, <span class="st">'max_set_size'</span>)</span>
<span id="cb4-4"><a href="#cb4-4"></a>  lure_idx <span class="ot">&lt;-</span> <span class="fu">attr</span>(data, <span class="st">"lure_idx_vars"</span>)</span>
<span id="cb4-5"><a href="#cb4-5"></a>  nt_features <span class="ot">&lt;-</span> model<span class="sc">$</span>other_vars<span class="sc">$</span>nt_features</span>
<span id="cb4-6"><a href="#cb4-6"></a>  set_size_var <span class="ot">&lt;-</span> model<span class="sc">$</span>other_vars<span class="sc">$</span>set_size</span>
<span id="cb4-7"><a href="#cb4-7"></a>  nt_distances <span class="ot">&lt;-</span> model<span class="sc">$</span>other_vars<span class="sc">$</span>nt_distances</span>
<span id="cb4-8"><a href="#cb4-8"></a></span>
<span id="cb4-9"><a href="#cb4-9"></a>  <span class="co"># construct main brms formula from the bmm formula</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>  formula <span class="ot">&lt;-</span> <span class="fu">bmf2bf</span>(model, formula) <span class="sc">+</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>    brms<span class="sc">::</span><span class="fu">lf</span>(kappa2 <span class="sc">~</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>    brms<span class="sc">::</span><span class="fu">lf</span>(mu2 <span class="sc">~</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>    brms<span class="sc">::</span><span class="fu">nlf</span>(theta1 <span class="sc">~</span> <span class="fu">log</span>(<span class="fu">exp</span>(c) <span class="sc">+</span> <span class="fu">exp</span>(a))) <span class="sc">+</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>    brms<span class="sc">::</span><span class="fu">nlf</span>(kappa1 <span class="sc">~</span> kappa) <span class="sc">+</span></span>
<span id="cb4-15"><a href="#cb4-15"></a>    brms<span class="sc">::</span><span class="fu">nlf</span>(expS <span class="sc">~</span> <span class="fu">exp</span>(s))</span>
<span id="cb4-16"><a href="#cb4-16"></a></span>
<span id="cb4-17"><a href="#cb4-17"></a>  <span class="co"># additional internal terms for the mixture model formula</span></span>
<span id="cb4-18"><a href="#cb4-18"></a>  kappa_nts <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"kappa"</span>, <span class="dv">3</span><span class="sc">:</span>(max_set_size <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb4-19"><a href="#cb4-19"></a>  theta_nts <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"theta"</span>, <span class="dv">3</span><span class="sc">:</span>(max_set_size <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb4-20"><a href="#cb4-20"></a>  mu_nts <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"mu"</span>, <span class="dv">3</span><span class="sc">:</span>(max_set_size <span class="sc">+</span> <span class="dv">1</span>))</span>
<span id="cb4-21"><a href="#cb4-21"></a></span>
<span id="cb4-22"><a href="#cb4-22"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(max_set_size <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb4-23"><a href="#cb4-23"></a>    formula <span class="ot">&lt;-</span> formula <span class="sc">+</span></span>
<span id="cb4-24"><a href="#cb4-24"></a>      <span class="fu">glue_nlf</span>(<span class="st">"{kappa_nts[i]} ~ kappa"</span>) <span class="sc">+</span></span>
<span id="cb4-25"><a href="#cb4-25"></a>      <span class="fu">glue_nlf</span>(<span class="st">"{theta_nts[i]} ~ {lure_idx[i]} * log(exp(c-expS*{nt_distances[i]}) + exp(a))"</span>,</span>
<span id="cb4-26"><a href="#cb4-26"></a>               <span class="st">"+ (1 - {lure_idx[i]}) * (-100)"</span>) <span class="sc">+</span></span>
<span id="cb4-27"><a href="#cb4-27"></a>      <span class="fu">glue_nlf</span>(<span class="st">"{mu_nts[i]} ~ {nt_features[i]}"</span>)</span>
<span id="cb4-28"><a href="#cb4-28"></a>  }</span>
<span id="cb4-29"><a href="#cb4-29"></a></span>
<span id="cb4-30"><a href="#cb4-30"></a>  <span class="co"># define mixture family</span></span>
<span id="cb4-31"><a href="#cb4-31"></a>  formula<span class="sc">$</span>family <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">mixture</span>(brms<span class="sc">::</span><span class="fu">von_mises</span>(<span class="st">"tan_half"</span>),</span>
<span id="cb4-32"><a href="#cb4-32"></a>                                  brms<span class="sc">::</span><span class="fu">von_mises</span>(<span class="st">"identity"</span>),</span>
<span id="cb4-33"><a href="#cb4-33"></a>                                  <span class="at">nmix =</span> <span class="fu">c</span>(<span class="dv">1</span>, max_set_size),</span>
<span id="cb4-34"><a href="#cb4-34"></a>                                  <span class="at">order =</span> <span class="st">"none"</span>)</span>
<span id="cb4-35"><a href="#cb4-35"></a></span>
<span id="cb4-36"><a href="#cb4-36"></a>  <span class="fu">nlist</span>(formula, data)</span>
<span id="cb4-37"><a href="#cb4-37"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The configure_model method should always take the arguments <code>model</code>, <code>data</code>, and <code>formula</code> (as a <code>bmmformula)</code> and return a named list with the formula (as a <code>brmsformula</code>) and the data. The <code>brmsfamily</code> should be stored within the formula.</p>
<p>Inside the configure_model method the <code>brmsformula</code> is generated using the <code>bmf2bf</code> function. This function converts the <code>bmmformula</code> passed to <code>bmm()</code> function into a <code>brmsformula</code> based on the information for the response variables provided in the <code>bmmmodel</code> object. There is a general method in <code>R/bmmformula.R</code> to construct the formula for all models with a single response variable.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># default method to paste the full brms formula for all bmmodels</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co">#' @export</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>bmf2bf.bmmodel <span class="ot">&lt;-</span> <span class="cf">function</span>(model, formula) {</span>
<span id="cb5-4"><a href="#cb5-4"></a>  <span class="co"># check if the model has only one response variable and extract if TRUE</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>  brms_formula <span class="ot">&lt;-</span> <span class="fu">NextMethod</span>(<span class="st">"bmf2bf"</span>)</span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a>  <span class="co"># for each dependent parameter, check if it is used as a non-linear predictor of</span></span>
<span id="cb5-8"><a href="#cb5-8"></a>  <span class="co"># another parameter and add the corresponding brms function</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>  <span class="cf">for</span> (pform <span class="cf">in</span> formula) {</span>
<span id="cb5-10"><a href="#cb5-10"></a>    <span class="cf">if</span> (<span class="fu">is_nl</span>(pform)) {</span>
<span id="cb5-11"><a href="#cb5-11"></a>      brms_formula <span class="ot">&lt;-</span> brms_formula <span class="sc">+</span> brms<span class="sc">::</span><span class="fu">nlf</span>(pform)</span>
<span id="cb5-12"><a href="#cb5-12"></a>    } <span class="cf">else</span> {</span>
<span id="cb5-13"><a href="#cb5-13"></a>      brms_formula <span class="ot">&lt;-</span> brms_formula <span class="sc">+</span> brms<span class="sc">::</span><span class="fu">lf</span>(pform)</span>
<span id="cb5-14"><a href="#cb5-14"></a>    }</span>
<span id="cb5-15"><a href="#cb5-15"></a>  }</span>
<span id="cb5-16"><a href="#cb5-16"></a>  brms_formula</span>
<span id="cb5-17"><a href="#cb5-17"></a>}</span>
<span id="cb5-18"><a href="#cb5-18"></a></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="co"># paste first line of the brms formula for all bmmodels with 1 response variable</span></span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="co">#' @export</span></span>
<span id="cb5-21"><a href="#cb5-21"></a>bmf2bf.default <span class="ot">&lt;-</span> <span class="cf">function</span>(model, formula){</span>
<span id="cb5-22"><a href="#cb5-22"></a>  <span class="co"># set base brms formula based on response</span></span>
<span id="cb5-23"><a href="#cb5-23"></a>  brms<span class="sc">::</span><span class="fu">bf</span>(<span class="fu">paste0</span>(model<span class="sc">$</span>resp_vars[[<span class="dv">1</span>]], <span class="st">"~ 1"</span>))</span>
<span id="cb5-24"><a href="#cb5-24"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The <code>bmf2bf.bmmodel</code> method initializes the conversion of the <code>bmmformula</code> to a <code>brms_formula</code>. The first step for this is to paste the first line of a <code>brmsformula</code> that includes the response as the dependent variable on the left-hand side. For models with a single response variable this is done in the <code>bmf2bf.default</code> method. For models with more than one response variable, you will have to provide a model specific method of <code>bmf2bf.myModel</code> to convert the <code>bmmformula</code> into the <code>brmsformula</code> . This conversion from a <code>bmmformula</code> object into a <code>brmsformula</code> object is done to avoid users having to specify complicated and long formulas or specifying all additional response information in the <code>brmsformula</code> themselves. For more detailed information on the use of additional response information in a <code>brmsformula</code> please see the <code>brmsformula</code> <a href="https://rdrr.io/cran/brms/man/brmsformula.html">documentation</a>.</p>
</section>
</section>
<section id="the-signal-discrimination-model-sdm" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="the-signal-discrimination-model-sdm"><span class="header-section-number">4.2</span> The Signal Discrimination Model (SDM)</h2>
<p>The SDM model is defined in the file <code>R/model_sdm.R</code>. The SDM model differs in the configuration compared to the IMM model, as it requires custom STAN code. Let’s go through the different parts. As before, we start with the model definition.</p>
<section id="model-definition-1" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="model-definition-1"><span class="header-section-number">4.2.1</span> Model definition</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>.model_sdm <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">resp_error =</span> <span class="cn">NULL</span>, <span class="at">links =</span> <span class="cn">NULL</span>, <span class="at">version =</span> <span class="st">"simple"</span>, <span class="at">call =</span> <span class="cn">NULL</span>, ...) {</span>
<span id="cb6-2"><a href="#cb6-2"></a>  out <span class="ot">&lt;-</span> <span class="fu">structure</span>(</span>
<span id="cb6-3"><a href="#cb6-3"></a>    <span class="fu">list</span>(</span>
<span id="cb6-4"><a href="#cb6-4"></a>      <span class="at">resp_vars =</span> <span class="fu">nlist</span>(resp_error),</span>
<span id="cb6-5"><a href="#cb6-5"></a>      <span class="at">other_vars =</span> <span class="fu">nlist</span>(),</span>
<span id="cb6-6"><a href="#cb6-6"></a>      <span class="at">domain =</span> <span class="st">'Visual working memory'</span>,</span>
<span id="cb6-7"><a href="#cb6-7"></a>      <span class="at">task =</span> <span class="st">'Continuous reproduction'</span>,</span>
<span id="cb6-8"><a href="#cb6-8"></a>      <span class="at">name =</span> <span class="st">'Signal Discrimination Model (SDM) by Oberauer (2023)'</span>,</span>
<span id="cb6-9"><a href="#cb6-9"></a>      <span class="at">citation =</span> <span class="fu">glue</span>(</span>
<span id="cb6-10"><a href="#cb6-10"></a>        <span class="st">'Oberauer, K. (2023). Measurement models for visual working memory - </span><span class="sc">\\</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="st">        A factorial model comparison. Psychological Review, 130(3), 841-852'</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>      ),</span>
<span id="cb6-13"><a href="#cb6-13"></a>      <span class="at">version =</span> version,</span>
<span id="cb6-14"><a href="#cb6-14"></a>      <span class="at">requirements =</span> <span class="fu">glue</span>(</span>
<span id="cb6-15"><a href="#cb6-15"></a>        <span class="st">'- The response variable should be in radians and represent the angular </span><span class="sc">\\</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="st">        error relative to the target'</span></span>
<span id="cb6-17"><a href="#cb6-17"></a>      ),</span>
<span id="cb6-18"><a href="#cb6-18"></a>      <span class="at">parameters =</span> <span class="fu">list</span>(</span>
<span id="cb6-19"><a href="#cb6-19"></a>        <span class="at">mu =</span> <span class="fu">glue</span>(<span class="st">'Location parameter of the SDM distribution (in radians; </span><span class="sc">\\</span></span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="st">                  by default fixed internally to 0)'</span>),</span>
<span id="cb6-21"><a href="#cb6-21"></a>        <span class="at">c =</span> <span class="st">'Memory strength parameter of the SDM distribution'</span>,</span>
<span id="cb6-22"><a href="#cb6-22"></a>        <span class="at">kappa =</span> <span class="st">'Precision parameter of the SDM distribution'</span></span>
<span id="cb6-23"><a href="#cb6-23"></a>      ),</span>
<span id="cb6-24"><a href="#cb6-24"></a>      <span class="at">links =</span> <span class="fu">list</span>(</span>
<span id="cb6-25"><a href="#cb6-25"></a>        <span class="at">mu =</span> <span class="st">'tan_half'</span>,</span>
<span id="cb6-26"><a href="#cb6-26"></a>        <span class="at">c =</span> <span class="st">'log'</span>,</span>
<span id="cb6-27"><a href="#cb6-27"></a>        <span class="at">kappa =</span> <span class="st">'log'</span></span>
<span id="cb6-28"><a href="#cb6-28"></a>      ),</span>
<span id="cb6-29"><a href="#cb6-29"></a>      <span class="at">fixed_parameters =</span> <span class="fu">list</span>(<span class="at">mu =</span> <span class="dv">0</span>),</span>
<span id="cb6-30"><a href="#cb6-30"></a>      <span class="at">default_priors =</span> <span class="fu">list</span>(</span>
<span id="cb6-31"><a href="#cb6-31"></a>        <span class="at">mu =</span> <span class="fu">list</span>(<span class="at">main =</span> <span class="st">"student_t(1, 0, 1)"</span>),</span>
<span id="cb6-32"><a href="#cb6-32"></a>        <span class="at">kappa =</span> <span class="fu">list</span>(<span class="at">main =</span> <span class="st">"student_t(5, 1.75, 0.75)"</span>, <span class="at">effects =</span> <span class="st">"normal(0, 1)"</span>),</span>
<span id="cb6-33"><a href="#cb6-33"></a>        <span class="at">c =</span> <span class="fu">list</span>(<span class="at">main =</span> <span class="st">"student_t(5, 2, 0.75)"</span>, <span class="at">effects =</span> <span class="st">"normal(0, 1)"</span>)</span>
<span id="cb6-34"><a href="#cb6-34"></a>      ),</span>
<span id="cb6-35"><a href="#cb6-35"></a>      <span class="at">void_mu =</span> <span class="cn">FALSE</span></span>
<span id="cb6-36"><a href="#cb6-36"></a>    ),</span>
<span id="cb6-37"><a href="#cb6-37"></a>    <span class="at">class =</span> <span class="fu">c</span>(<span class="st">'bmmodel'</span>, <span class="st">'circular'</span>, <span class="st">'sdm'</span>, <span class="fu">paste0</span>(<span class="st">"sdm_"</span>, version)),</span>
<span id="cb6-38"><a href="#cb6-38"></a>    <span class="at">call =</span> call</span>
<span id="cb6-39"><a href="#cb6-39"></a>  )</span>
<span id="cb6-40"><a href="#cb6-40"></a>  out<span class="sc">$</span>links[<span class="fu">names</span>(links)] <span class="ot">&lt;-</span> links</span>
<span id="cb6-41"><a href="#cb6-41"></a>  out</span>
<span id="cb6-42"><a href="#cb6-42"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The model definition is similar to the IMM model, but the SDM model only requires the user to specify the response error, but not additional variables such as non-target variables. The <code>class</code> is also different, as the SDM model is not a subclass of the IMM model. We’ll skip the alias for the SDM model, as it is similar for every model.</p>
</section>
<section id="check_data-methods-1" class="level3" data-number="4.2.2">
<h3 data-number="4.2.2" class="anchored" data-anchor-id="check_data-methods-1"><span class="header-section-number">4.2.2</span> check_data() methods</h3>
<p>The SDM shares a class with other <code>circular</code> models, so most of the data checks are performed by <code>check_data.circular</code> method, defined in the general file <code>R/helpers-data.R</code>. The <code>sdm</code> however, samples much more quickly in Stan, if the data is sorted by the predictor variables, so we have the following custom data check method for the sdm:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co">#' @export</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>check_data.sdm <span class="ot">&lt;-</span> <span class="cf">function</span>(model, data, formula) {</span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="co"># data sorted by predictors is necessary for speedy computation of normalizing constant</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>  data <span class="ot">&lt;-</span> <span class="fu">order_data_query</span>(model, data, formula)</span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="fu">NextMethod</span>(<span class="st">"check_data"</span>)</span>
<span id="cb7-6"><a href="#cb7-6"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="configure_model-methods-1" class="level3" data-number="4.2.3">
<h3 data-number="4.2.3" class="anchored" data-anchor-id="configure_model-methods-1"><span class="header-section-number">4.2.3</span> configure_model() methods</h3>
<p>The configure_model method for the SDM model is different compared to the IMM model, as it requires custom STAN code. The method is defined as follows:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="co">#' @export</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>configure_model.sdm <span class="ot">&lt;-</span> <span class="cf">function</span>(model, data, formula) {</span>
<span id="cb8-3"><a href="#cb8-3"></a>  <span class="co"># construct the family</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>  <span class="co"># note - c has a log link, but I've coded it manually for computational efficiency</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>  sdm_simple <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">custom_family</span>(</span>
<span id="cb8-6"><a href="#cb8-6"></a>    <span class="st">"sdm_simple"</span>,</span>
<span id="cb8-7"><a href="#cb8-7"></a>    <span class="at">dpars =</span> <span class="fu">c</span>(<span class="st">"mu"</span>, <span class="st">"c"</span>, <span class="st">"kappa"</span>),</span>
<span id="cb8-8"><a href="#cb8-8"></a>    <span class="at">links =</span> <span class="fu">c</span>(<span class="st">"tan_half"</span>, <span class="st">"identity"</span>, <span class="st">"log"</span>),</span>
<span id="cb8-9"><a href="#cb8-9"></a>    <span class="at">lb =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb8-10"><a href="#cb8-10"></a>    <span class="at">ub =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="cn">NA</span>, <span class="cn">NA</span>),</span>
<span id="cb8-11"><a href="#cb8-11"></a>    <span class="at">type =</span> <span class="st">"real"</span>, <span class="at">loop =</span> <span class="cn">FALSE</span>,</span>
<span id="cb8-12"><a href="#cb8-12"></a>    <span class="at">log_lik =</span> log_lik_sdm_simple,</span>
<span id="cb8-13"><a href="#cb8-13"></a>    <span class="at">posterior_predict =</span> posterior_predict_sdm_simple</span>
<span id="cb8-14"><a href="#cb8-14"></a>  )</span>
<span id="cb8-15"><a href="#cb8-15"></a></span>
<span id="cb8-16"><a href="#cb8-16"></a>  <span class="co"># prepare initial stanvars to pass to brms, model formula and priors</span></span>
<span id="cb8-17"><a href="#cb8-17"></a>  sc_path <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">"stan_chunks"</span>, <span class="at">package =</span> <span class="st">"bmm"</span>)</span>
<span id="cb8-18"><a href="#cb8-18"></a>  stan_funs <span class="ot">&lt;-</span> <span class="fu">read_lines2</span>(<span class="fu">paste0</span>(sc_path, <span class="st">"/sdm_simple_funs.stan"</span>))</span>
<span id="cb8-19"><a href="#cb8-19"></a>  stan_tdata <span class="ot">&lt;-</span> <span class="fu">read_lines2</span>(<span class="fu">paste0</span>(sc_path, <span class="st">"/sdm_simple_tdata.stan"</span>))</span>
<span id="cb8-20"><a href="#cb8-20"></a>  stan_likelihood <span class="ot">&lt;-</span> <span class="fu">read_lines2</span>(<span class="fu">paste0</span>(sc_path, <span class="st">"/sdm_simple_likelihood.stan"</span>))</span>
<span id="cb8-21"><a href="#cb8-21"></a>  stanvars <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">stanvar</span>(<span class="at">scode =</span> stan_funs, <span class="at">block =</span> <span class="st">"functions"</span>) <span class="sc">+</span></span>
<span id="cb8-22"><a href="#cb8-22"></a>    brms<span class="sc">::</span><span class="fu">stanvar</span>(<span class="at">scode =</span> stan_tdata, <span class="at">block =</span> <span class="st">"tdata"</span>) <span class="sc">+</span></span>
<span id="cb8-23"><a href="#cb8-23"></a>    brms<span class="sc">::</span><span class="fu">stanvar</span>(<span class="at">scode =</span> stan_likelihood, <span class="at">block =</span> <span class="st">"likelihood"</span>, <span class="at">position =</span> <span class="st">"end"</span>)</span>
<span id="cb8-24"><a href="#cb8-24"></a></span>
<span id="cb8-25"><a href="#cb8-25"></a>  <span class="co"># construct main brms formula from the bmm formula</span></span>
<span id="cb8-26"><a href="#cb8-26"></a>  formula <span class="ot">&lt;-</span> <span class="fu">bmf2bf</span>(model, formula)</span>
<span id="cb8-27"><a href="#cb8-27"></a>  formula<span class="sc">$</span>family <span class="ot">&lt;-</span> sdm_simple</span>
<span id="cb8-28"><a href="#cb8-28"></a></span>
<span id="cb8-29"><a href="#cb8-29"></a>  <span class="co"># set initial values to be sampled between [-1,1] to avoid extreme SDs that</span></span>
<span id="cb8-30"><a href="#cb8-30"></a>  <span class="co"># can cause the sampler to fail</span></span>
<span id="cb8-31"><a href="#cb8-31"></a>  init <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb8-32"><a href="#cb8-32"></a></span>
<span id="cb8-33"><a href="#cb8-33"></a>  <span class="co"># return the list</span></span>
<span id="cb8-34"><a href="#cb8-34"></a>  <span class="fu">nlist</span>(formula, data, stanvars, init)</span>
<span id="cb8-35"><a href="#cb8-35"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>Lines 5-14</strong> use the <code>brms::custom_family</code> function to define a custom family for the SDM model. The <code>dpars</code> argument specifies the parameters of the model, and the <code>links</code> argument specifies the link functions for the parameters. For more information, see <a href="https://cran.r-project.org/web/packages/brms/vignettes/brms_customfamilies.html">here</a></p>
<p><strong>Lines 17-23</strong> read the custom STAN code from the <code>inst/stan_chunks</code> directory. This has to be specified with the system.file() command to ensure that the code is found when the package is installed. The <code>stanvars</code> object is used to pass custom STAN code to the <code>brms</code> package. The <code>stanvars</code> object is a list of <code>brms::stanvar</code> objects, each of which contains the STAN code for a specific part of the model. There is a separate <code>.stan</code> file for each part of the STAN code, and each file is read into a separate <code>brms::stanvar</code> object.</p>
<p>Converting the <code>bmmformula</code> to a <code>brmsformula</code> and collecting all arguments is done entirely using the <code>bmf2bf</code> method.</p>
</section>
<section id="post-processing-methods" class="level3" data-number="4.2.4">
<h3 data-number="4.2.4" class="anchored" data-anchor-id="post-processing-methods"><span class="header-section-number">4.2.4</span> Post-processing methods</h3>
<p>Unlike the <code>imm</code> model, the <code>sdm</code> model requires some special post-processing because of the way the link functions are coded. These methods are applied <em>after</em> the brmsfit object is returned, at the very end of the <em>bmm()</em> pipeline:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co">#' @export</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>postprocess_brm.sdm <span class="ot">&lt;-</span> <span class="cf">function</span>(model, fit, ...) {</span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="co"># manually set link_c to "log" since I coded it manually</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>  fit<span class="sc">$</span>family<span class="sc">$</span>link_c <span class="ot">&lt;-</span> <span class="st">"log"</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>  fit<span class="sc">$</span>formula<span class="sc">$</span>family<span class="sc">$</span>link_c <span class="ot">&lt;-</span> <span class="st">"log"</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>  fit</span>
<span id="cb9-7"><a href="#cb9-7"></a>}</span>
<span id="cb9-8"><a href="#cb9-8"></a></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="co">#' @export</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>revert_postprocess_brm.sdm <span class="ot">&lt;-</span> <span class="cf">function</span>(model, fit, ...) {</span>
<span id="cb9-11"><a href="#cb9-11"></a>  fit<span class="sc">$</span>family<span class="sc">$</span>link_c <span class="ot">&lt;-</span> <span class="st">"identity"</span></span>
<span id="cb9-12"><a href="#cb9-12"></a>  fit<span class="sc">$</span>formula<span class="sc">$</span>family<span class="sc">$</span>link_c <span class="ot">&lt;-</span> <span class="st">"identity"</span></span>
<span id="cb9-13"><a href="#cb9-13"></a>  fit</span>
<span id="cb9-14"><a href="#cb9-14"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>we also have a couple of special functions for custom families in brms (see the <code>log_lik</code>and <code>posterior_predict</code> argument in the call to <code>brms::custom_familiy()</code>), which allow other typical tools from <code>brms</code> such posterior_predict of bridgesampling to work:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>log_lik_sdm_simple <span class="ot">&lt;-</span> <span class="cf">function</span>(i, prep) {</span>
<span id="cb10-2"><a href="#cb10-2"></a>  mu <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">get_dpar</span>(prep, <span class="st">"mu"</span>, <span class="at">i =</span> i)</span>
<span id="cb10-3"><a href="#cb10-3"></a>  c <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">get_dpar</span>(prep, <span class="st">"c"</span>, <span class="at">i =</span> i)</span>
<span id="cb10-4"><a href="#cb10-4"></a>  kappa <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">get_dpar</span>(prep, <span class="st">"kappa"</span>, <span class="at">i =</span> i)</span>
<span id="cb10-5"><a href="#cb10-5"></a>  y <span class="ot">&lt;-</span> prep<span class="sc">$</span>data<span class="sc">$</span>Y[i]</span>
<span id="cb10-6"><a href="#cb10-6"></a>  <span class="fu">dsdm</span>(y, mu, c, kappa, <span class="at">log =</span> T)</span>
<span id="cb10-7"><a href="#cb10-7"></a>}</span>
<span id="cb10-8"><a href="#cb10-8"></a></span>
<span id="cb10-9"><a href="#cb10-9"></a>posterior_predict_sdm_simple <span class="ot">&lt;-</span> <span class="cf">function</span>(i, prep, ...) {</span>
<span id="cb10-10"><a href="#cb10-10"></a>  mu <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">get_dpar</span>(prep, <span class="st">"mu"</span>, <span class="at">i =</span> i)</span>
<span id="cb10-11"><a href="#cb10-11"></a>  c <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">get_dpar</span>(prep, <span class="st">"c"</span>, <span class="at">i =</span> i)</span>
<span id="cb10-12"><a href="#cb10-12"></a>  kappa <span class="ot">&lt;-</span> brms<span class="sc">::</span><span class="fu">get_dpar</span>(prep, <span class="st">"kappa"</span>, <span class="at">i =</span> i)</span>
<span id="cb10-13"><a href="#cb10-13"></a>  <span class="fu">rsdm</span>(<span class="fu">length</span>(mu), mu, c, kappa)</span>
<span id="cb10-14"><a href="#cb10-14"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We will now look at how to construct all these parts for a new model. <strong>Hint</strong>: you don’t have to do it manually, you can use the <code>use_model_template()</code> function to generate templates for your model.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./bmm-architecture.html" class="pagination-link" aria-label="BMM code structure">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">BMM code structure</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./add-new-model.html" class="pagination-link" aria-label="Adding a new model">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Adding a new model</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>